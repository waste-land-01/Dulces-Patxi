<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dulces Patxi</title>
  <style>
    :root{
      --bg-dark:#0f1214;
      --panel-dark:#16171a;
      --muted:#9aa6b2;
      --accent:#0ea5ff;
      --card:#17181b;
      --glass: rgba(255,255,255,0.03);
      --radius:14px;
      --gap:18px;
    }
    html,body{height:100%;margin:0;font-family: "Segoe UI", Roboto, Arial, sans-serif;background:var(--bg-dark);color:#ebeff2;-webkit-font-smoothing:antialiased;}
    .light { --bg-dark:#f6f7f9; --panel-dark:#ffffff; --card:#ffffff; color:#101214; --muted:#55606a; --glass: rgba(0,0,0,0.03); }
    .app {min-height:100vh; display:flex; flex-direction:column; align-items:stretch;}
    header { text-align:center; padding:28px 18px 8px 18px; }
    h1 { margin:0; font-size:34px; color:var(--accent); letter-spacing:0.02em; }
    .welcome {
      margin:8px 0 0 0;
      font-weight:700;
      white-space:pre; /* preserve newline layout below */
      font-size:15px;
      color:var(--muted);
      display:inline-block;
      text-align:center;
      line-height:1.05;
    }
    /* main area */
    main { max-width:980px; width:100%; margin:0 auto; padding:18px; box-sizing:border-box; flex:1 1 auto; }

    .search-row{display:flex; justify-content:center; margin:10px 0 20px 0;}
    .search-input{
      width:96%;
      max-width:760px;
      padding:14px 46px 14px 16px;
      border-radius:12px;
      border:0;
      background:linear-gradient(180deg,var(--panel-dark), #0b0d0f);
      color:inherit;
      box-shadow: 0 6px 22px rgba(0,0,0,0.45);
      font-size:16px;
    }
    .search-icon{position:relative; margin-left:-44px; margin-top:10px; color:var(--muted); font-size:18px; pointer-events:none;}

    /* big buttons grid */
    .grid { display:grid; grid-template-columns: repeat(1,1fr); gap:var(--gap); margin-top:18px; }
    @media(min-width:720px){ .grid { grid-template-columns: repeat(2,1fr); } }

    .btn {
      display:flex; align-items:center; justify-content:center;
      padding:20px; font-size:18px; font-weight:900; letter-spacing:0.02em;
      border-radius:var(--radius); border:0; cursor:pointer;
      background: linear-gradient(145deg,var(--card), #0b0d0f);
      color:var(--accent);
      box-shadow: 6px 6px 20px rgba(0,0,0,0.6), -6px -6px 18px rgba(255,255,255,0.02);
      min-height:88px;
    }
    .btn.large { font-size:20px; padding:24px; min-height:110px; }
    .btn:hover{ transform:translateY(-4px); transition:transform .14s ease; background:linear-gradient(145deg,#0f1418,#0a0b0c); color:white; }

    /* views */
    .view { display:none; width:100%; max-width:980px; margin:0 auto; padding:18px; box-sizing:border-box; }
    .view.active { display:block; }

    .page-head { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
    .back { border:0; padding:10px 12px; border-radius:10px; background:var(--panel-dark); color:var(--accent); font-weight:800; cursor:pointer; }
    .title { font-weight:900; font-size:20px; color:var(--accent); }

    .list { display:flex; flex-direction:column; gap:12px; margin-top:8px; }
    .card { background:linear-gradient(180deg,var(--card), #0f1113); padding:14px; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.5); color:inherit; }
    .card .row { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .card .name { font-weight:900; font-size:16px; }
    .muted { color:var(--muted); font-size:13px; }

    /* recipe detail layout */
    .recipe-top { display:flex; justify-content:space-between; gap:10px; align-items:center; margin-bottom:12px; }
    .recipe-meta { color:var(--muted); font-weight:700; font-size:13px; margin-bottom:10px; }
    .ingredientes, .elaboracion { margin:12px 0; padding:12px; border-radius:10px; background:var(--glass); color:inherit; }
    .ingredientes ul { margin:0; padding-left:18px; }
    .elaboracion ol { margin:0; padding-left:18px; }

    /* custom timer control inline */
    .timer-inline { display:flex; gap:8px; align-items:center; }
    select.timer-select { padding:8px; border-radius:8px; border:0; background:var(--panel-dark); color:inherit; font-weight:800; }
    .small-btn { padding:8px 10px; border-radius:10px; border:0; cursor:pointer; background:var(--accent); color:#022; font-weight:900; }

    /* bottom fixed timer bar */
    .timer-bar {
      position:fixed; left:0; right:0; bottom:0; z-index:9999;
      background: linear-gradient(180deg, rgba(10,12,14,0.95), rgba(2,6,8,0.98));
      color:white; padding:8px 12px; display:flex; gap:10px; align-items:center; overflow:auto; box-shadow:0 -6px 18px rgba(0,0,0,0.6);
      border-top:3px solid rgba(14,165,255,0.12);
    }
    .timer-pill { display:flex; gap:8px; align-items:center; padding:6px 10px; border-radius:10px; background:rgba(255,255,255,0.03); font-weight:800; font-size:14px; white-space:nowrap; }
    .timer-controls button { margin-left:6px; padding:6px 10px; border-radius:8px; border:0; background:#111; color:var(--accent); cursor:pointer; font-weight:900; }

    /* modal overlay */
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:10000; }
    .modal { background:var(--panel-dark); padding:18px; border-radius:14px; width:calc(100% - 40px); max-width:700px; box-shadow:0 12px 40px rgba(0,0,0,0.6); color:inherit; }

    .share-row { margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    .share-row button { padding:8px 12px; border-radius:10px; border:0; background:var(--accent); color:#022; font-weight:900; cursor:pointer; }

    footer { text-align:center; padding:14px 8px; font-size:13px; color:var(--muted); }
  </style>
</head>
<body>
  <div class="app" id="appRoot">
    <header>
      <h1>Dulce Patxi</h1>
      <!-- la estructura de la bienvenida debe quedar exactamente como pides:
           línea 1: "Bienvenidos en Dulces de Bachir Krai"
           línea 2 (justo debajo de "Bachir Krai"): "By  Yahya" -->
      <div class="welcome">Bienvenidos en Dulces de Bachir Krai
By  Yahya</div>
    </header>

    <main>
      <!-- VISTAS -->
      <!-- VISTA PRINCIPAL -->
      <section id="view-main" class="view active">
        <div class="search-row">
          <input id="searchInput" class="search-input" placeholder="Buscar receta..." aria-label="Buscar receta">
          <div class="search-icon">🔎</div>
        </div>

        <div class="grid" id="mainButtons">
          <button class="btn large" id="btnModo">Modo</button>
          <button class="btn large" id="btnSmart">Buscador inteligente</button>
          <button class="btn large" id="btnMenu">menu</button>
          <button class="btn large" id="btnEstrella">recetas estrella</button>
          <button class="btn large" id="btnNotas">Notas personales</button>
        </div>
      </section>

      <!-- MENU -->
      <section id="view-menu" class="view">
        <div class="page-head">
          <button class="back" data-action="back">Atrás</button>
          <div class="title">Menú</div>
        </div>
        <div class="list">
          <div class="card"><button class="btn" onclick="showCategories()">Categorías</button></div>
          <div class="card"><button class="btn" onclick="openStarRecipes()">Recetas estrella</button></div>
          <div class="card"><button class="btn" onclick="openLastRecipe()">Última receta</button></div>
        </div>
      </section>

      <!-- BUSCADOR INTELIGENTE -->
      <section id="view-smart" class="view">
        <div class="page-head">
          <button class="back" data-action="back">Atrás</button>
          <div class="title">Buscador inteligente</div>
        </div>
        <div class="list">
          <div class="card">
            <div class="row">
              <div>
                <div class="name">Filtrar por tiempo</div>
                <div class="muted">Franjas: A (1-20), B (21-40), C (41+)</div>
              </div>
              <div><button class="btn" onclick="filterByTime()">Seleccionar</button></div>
            </div>
          </div>

          <div class="card">
            <div class="row">
              <div>
                <div class="name">Filtrar por dificultad</div>
                <div class="muted">F (Fácil), M (Medio), D (Difícil)</div>
              </div>
              <div><button class="btn" onclick="filterByDifficulty()">Seleccionar</button></div>
            </div>
          </div>

          <div class="card">
            <div class="row">
              <div>
                <div class="name">Filtrar por categoría</div>
                <div class="muted">Introduce el nombre de la categoría</div>
              </div>
              <div><button class="btn" onclick="filterByCategory()">Seleccionar</button></div>
            </div>
          </div>
        </div>
      </section>

      <!-- LISTA DE RECETAS (resultados / categoría / favoritos) -->
      <section id="view-list" class="view">
        <div class="page-head">
          <button class="back" data-action="back">Atrás</button>
          <div class="title" id="listTitle">Recetas</div>
        </div>
        <div id="listContent" class="list"></div>
      </section>

      <!-- DETALLE DE RECETA -->
      <section id="view-recipe" class="view">
        <div class="page-head">
          <div style="display:flex;gap:10px;align-items:center;">
            <button class="back" data-action="back">Atrás</button>
            <div id="recipeName" class="title">Receta</div>
          </div>
          <!-- temporizador personalizado al lado del botón Atrás -->
          <div class="timer-inline" style="margin-left:auto;">
            <label for="customTimerSelect" class="muted" style="font-weight:700;">Temporizador</label>
            <select id="customTimerSelect" class="timer-select" aria-label="Selecciona minutos"></select>
            <button class="small-btn" id="customTimerAdd">Añadir</button>
          </div>
        </div>

        <div id="recipeMeta" class="recipe-meta"></div>

        <div id="recipeBody" class="card">
          <div id="ingredientsSection" class="ingredientes"></div>
          <div id="elaboracionSection" class="elaboracion"></div>

          <div style="display:flex; gap:12px; margin-top:12px; flex-wrap:wrap;">
            <button class="btn" id="shareRecipeBtn">Compartir</button>
            <button class="btn" id="notesRecipeBtn">Notas personales</button>
          </div>
        </div>
      </section>

      <!-- NOTAS AGREGADAS (agregado general) -->
      <section id="view-notes" class="view">
        <div class="page-head">
          <button class="back" data-action="back">Atrás</button>
          <div class="title">Notas y observaciones</div>
        </div>
        <div id="notesContainer" class="list"></div>
      </section>

      <!-- NOTAS DE RECETA -->
      <section id="view-note-recipe" class="view">
        <div class="page-head">
          <button class="back" data-action="back">Atrás</button>
          <div class="title" id="noteRecipeTitle">Nota</div>
        </div>
        <div class="card">
          <textarea id="noteTextarea" class="note-area" placeholder="Escribe tus notas aquí..."></textarea>
          <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;">
            <button class="btn" id="saveNoteBtn">Guardar</button>
            <button class="btn" id="shareNoteBtn">Compartir</button>
          </div>
        </div>
      </section>

    </main>

    <footer>© Dulces Patxi</footer>

    <!-- barra inferior de temporizadores -->
    <div id="timerBar" class="timer-bar" style="display:none;"></div>
  </div>

  <!-- modal overlay (usado para resultados de búsqueda y compartir fallback) -->
  <div id="overlayRoot" style="display:none;"></div>

  <script>
  /*********************************************
   *  Dulces Patxi - index.html (completo)
   *  - Pega tus recetas en el bloque indicado
   *  - Navegación apilada (historyStack)
   *  - Búsqueda normal + modal de resultados
   *  - Buscador inteligente (A/B/C y F/M/D case-insensitive)
   *  - Parser automático de tiempos en elaboracion
   *  - Temporizadores múltiples persistentes (localStorage)
   *  - Temporizadores permanecen al salir de la receta
   *  - Notas por receta + sección agregada de notas
   *  - Compartir con formato elegante y enlaces a WhatsApp/Telegram/Email/SMS
   *********************************************/

 



 <script>
    // === DATOS DE LAS RECETAS ===
    const recetas = [
           // === TARTAS DEL AYER ===
      {
        "id": "VARIOS 142",
        "nombre": "Tarta de Manzana",
        "categoria": "Tartas del Ayer",
        "ingredientes": [
          { "nombre": "Pasta sableaux o hojaldre", "cantidad": 1, "unidad": "masa" },
          { "nombre": "Crema pastelera", "cantidad": 250, "unidad": "gr" },
          { "nombre": "Manzanas reinetas", "cantidad": 4, "unidad": "unidades" },
          { "nombre": "Azúcar grano", "cantidad": 50, "unidad": "gr" },
          { "nombre": "Gelatina de manzana", "cantidad": 1, "unidad": "sobre" }
        ],
        "elaboracion": [
          "Rellenar un molde con pasta sableux y cocer en blanco con alubias.",
          "Retirar las alubias y rellenar con crema pastelera.",
          "Colocar manzana pelada y fileteada de forma decorativa.",
          "Espolvorear con azúcar y hornear a 190°C durante 35 minutos.",
          "Una vez fría, abrillantar con gelatina de manzana."
        ],
        "temperatura": 190,
        "tiempo": 35
      },
      {
        "id": "VARIOS 143",
        "nombre": "Tarta San Marcos",
        "categoria": "Tartas del Ayer",
        "ingredientes": [
          { "nombre": "Bizcocho corriente", "cantidad": 1, "unidad": "plancha" },
          { "nombre": "Almíbar para emborrachar", "cantidad": 200, "unidad": "ml" },
          { "nombre": "Nata montada", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Yema pastelera", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Azúcar en grano", "cantidad": 50, "unidad": "gr" },
          { "nombre": "Gelatina de manzana", "cantidad": 1, "unidad": "sobre" }
        ],
        "elaboracion": [
          "Montar la tarta: disco de bizcocho emborrachado.",
          "Capa de yema pastelera.",
          "Disco de bizcocho emborrachado.",
          "Capa de nata montada.",
          "Disco de bizcocho emborrachado.",
          "Extender yema pastelera, rociar con azúcar y quemar con soplete.",
          "Decorar laterales con nata y almendra granillo tostada.",
          "Abrillantar con gelatina de manzana."
        ]
      },
      {
        "id": "VARIOS 144",
        "nombre": "Tarta Tatin",
        "categoria": "Tartas del Ayer",
        "ingredientes": [
          { "nombre": "Azúcar", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 100, "unidad": "ml" },
          { "nombre": "Manzanas reinetas", "cantidad": 1, "unidad": "kg" },
          { "nombre": "Recortes de hojaldre", "cantidad": 1, "unidad": "cantidad suficiente" }
        ],
        "elaboracion": [
          "Baño de caramelo en molde: derretir azúcar con agua.",
          "Pelar, descorazonar y cortar manzanas por la mitad.",
          "Colocarlas en el molde con parte convexa hacia abajo.",
          "Cubrir con lámina de hojaldre, pinchar y hornear a 180°C."
        ],
        "temperatura": 180,
        "tiempo": 40
      },
      {
        "id": "VARIOS 146",
        "nombre": "Tarta de Queso",
        "categoria": "Tartas del Ayer",
        "ingredientes": [
          { "nombre": "Queso tipo Philadelphia", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Huevos", "cantidad": 4, "unidad": "unidades" },
          { "nombre": "Nata líquida", "cantidad": 200, "unidad": "ml" },
          { "nombre": "Galletas trituradas", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Mantequilla", "cantidad": 100, "unidad": "gr" }
        ],
        "elaboracion": [
          "Mezclar galletas con mantequilla derretida y formar base.",
          "Batir queso con azúcar, añadir huevos uno a uno.",
          "Incorporar nata y verter sobre la base.",
          "Hornear a baño María a 160°C durante 50 minutos.",
          "Enfriar y refrigerar toda la noche."
        ],
        "temperatura": 160,
        "tiempo": 50
      },
      {
        "id": "VARIOS 147",
        "nombre": "Tarta de Yema Quemada",
        "categoria": "Tartas del Ayer",
        "ingredientes": [
          { "nombre": "Pasta sableaux", "cantidad": 1, "unidad": "masa" },
          { "nombre": "Yemas de huevo", "cantidad": 20, "unidad": "unidades" },
          { "nombre": "Azúcar", "cantidad": 600, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 250, "unidad": "ml" }
        ],
        "elaboracion": [
          "Preparar almíbar con azúcar y agua hasta punto de hebra fina.",
          "Incorporar yemas poco a poco sin dejar de remover.",
          "Verter sobre la masa sableaux previamente cocida.",
          "Cocer al horno suave hasta dorar ligeramente."
        ],
        "temperatura": 170,
        "tiempo": 25
      },
      {
        "id": "VARIOS 150",
        "nombre": "Tarta Sagarroz",
        "categoria": "Tartas del Ayer",
        "ingredientes": [
          { "nombre": "Bizcocho corriente", "cantidad": 1, "unidad": "plancha" },
          { "nombre": "Almíbar aromatizado con sidra", "cantidad": 200, "unidad": "ml" },
          { "nombre": "Nata montada", "cantidad": 400, "unidad": "gr" },
          { "nombre": "Compota de manzana", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Sidra", "cantidad": 100, "unidad": "ml" },
          { "nombre": "Gelatina de manzana", "cantidad": 1, "unidad": "sobre" }
        ],
        "elaboracion": [
          "Emborrar el bizcocho con almíbar de sidra.",
          "Rellenar con capas alternas de nata y compota.",
          "Cubrir con nata y abrillantar con gelatina."
        ]
      },
      {
        "id": "VARIOS 161",
        "nombre": "Tarta de Almendra",
        "categoria": "Tartas del Ayer",
        "ingredientes": [
          { "nombre": "Pasta quebrada", "cantidad": 1, "unidad": "masa" },
          { "nombre": "Azúcar", "cantidad": 250, "unidad": "gr" },
          { "nombre": "Almendra molida", "cantidad": 250, "unidad": "gr" },
          { "nombre": "Ralladura de limón", "cantidad": 1, "unidad": "unidad" },
          { "nombre": "Huevos", "cantidad": 3, "unidad": "unidades" },
          { "nombre": "Mantequilla", "cantidad": 250, "unidad": "gr" }
        ],
        "elaboracion": [
          "Forrar molde con pasta quebrada.",
          "Mezclar almendra, azúcar, ralladura, huevos y mantequilla.",
          "Verter sobre la base y hornear a 180°C durante 45 minutos."
        ],
        "temperatura": 180,
        "tiempo": 45
      },
      {
        "id": "VARIOS 158",
        "nombre": "Tarta de Frutas",
        "categoria": "Tartas del Ayer",
        "ingredientes": [
          { "nombre": "Dos discos de bizcocho", "cantidad": 2, "unidad": "unidades" },
          { "nombre": "Almíbar de emborrachar", "cantidad": 200, "unidad": "ml" },
          { "nombre": "Nata montada", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Yema de naranja", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Frutas variadas", "cantidad": 500, "unidad": "gr" }
        ],
        "elaboracion": [
          "Colocar un disco de bizcocho en molde de aro.",
          "Emborrarlo mínimamente.",
          "Rellenar abundantemente de nata.",
          "Colocar encima el otro disco de bizcocho y emborracharlo.",
          "Extender yema de naranja, rociar con azúcar y quemar.",
          "Abrillantar con gelatina de manzana.",
          "Colocar frutas decorativamente y abrillantar."
        ]
      },
      // === TARTAS PREMIUM ===
      {
        "id": "VARIOS 148",
        "nombre": "Tronco Navideño",
        "categoria": "Tartas Premium",
        "ingredientes": [
          { "nombre": "Bizcocho plancha", "cantidad": 1, "unidad": "unidad" },
          { "nombre": "Trufa", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Almíbar", "cantidad": 150, "unidad": "ml" },
          { "nombre": "Cobertura", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Mantequilla", "cantidad": 50, "unidad": "gr" },
          { "nombre": "Hojas de chocolate", "cantidad": 1, "unidad": "cantidad" },
          { "nombre": "Azúcar glass", "cantidad": 30, "unidad": "gr" },
          { "nombre": "Canela en polvo", "cantidad": 5, "unidad": "gr" }
        ],
        "elaboracion": [
          "Empapar el bizcocho con almíbar.",
          "Untar con trufa y enrollar con ayuda de papel sulfurizado.",
          "Abrillantar con cobertura mezclada con mantequilla.",
          "Crear textura de corteza con tenedor.",
          "Decorar con hojas de chocolate y canela."
        ]
      },
      {
        "id": "VARIOS 149",
        "nombre": "Tarta Selva Negra",
        "categoria": "Tartas Premium",
        "ingredientes": [
          { "nombre": "Bizcocho de chocolate", "cantidad": 1, "unidad": "plancha" },
          { "nombre": "Cherovia", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Kirsch", "cantidad": 200, "unidad": "ml" },
          { "nombre": "Nata montada", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Cacao en polvo", "cantidad": 50, "unidad": "gr" },
          { "nombre": "Cerezas en almíbar", "cantidad": 1, "unidad": "lata" }
        ],
        "elaboracion": [
          "Cortar el bizcocho en tres discos.",
          "Emborrar cada disco con Kirsch.",
          "Alternar capas de cherovia, nata y cerezas.",
          "Cubrir exterior con nata y espolvorear cacao.",
          "Decorar con cerezas y virutas de chocolate."
        ]
      },
      {
        "id": "VARIOS 151",
        "nombre": "Tarta Martínica",
        "categoria": "Tartas Premium",
        "ingredientes": [
          { "nombre": "Pasta sableaux", "cantidad": 1, "unidad": "masa" },
          { "nombre": "Crema pastelera", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Piña natural", "cantidad": 1, "unidad": "unidad" },
          { "nombre": "Ron", "cantidad": 50, "unidad": "ml" },
          { "nombre": "Nata montada", "cantidad": 200, "unidad": "gr" }
        ],
        "elaboracion": [
          "Forrar molde con pasta sableaux y cocer en blanco.",
          "Rellenar con crema pastelera y piña macerada en ron.",
          "Cubrir con nata y decorar con trozos de piña."
        ]
      },
      {
        "id": "VARIOS 152",
        "nombre": "Tarta de Moka",
        "categoria": "Tartas Premium",
        "ingredientes": [
          { "nombre": "Bizcocho genovés", "cantidad": 1, "unidad": "plancha" },
          { "nombre": "Café expreso", "cantidad": 200, "unidad": "ml" },
          { "nombre": "Mascarpone", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Azúcar glass", "cantidad": 100, "unidad": "gr" },
          { "nombre": "Chocolate negro", "cantidad": 100, "unidad": "gr" }
        ],
        "elaboracion": [
          "Emborrar el bizcocho con café.",
          "Mezclar mascarpone con azúcar y cubrir el bizcocho.",
          "Rallar chocolate y espolvorear por encima."
        ]
      },
      {
        "id": "VARIOS 153",
        "nombre": "Tarta Ópera",
        "categoria": "Tartas Premium",
        "ingredientes": [
          { "nombre": "Bizcocho joconde", "cantidad": 3, "unidad": "discos" },
          { "nombre": "Café concentrado", "cantidad": 150, "unidad": "ml" },
          { "nombre": "Crema de moka", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Cobertura de chocolate", "cantidad": 200, "unidad": "gr" }
        ],
        "elaboracion": [
          "Alternar capas de bizcocho empapado en café y crema de moka.",
          "Cubrir con cobertura de chocolate brillante."
        ]
      },
      {
        "id": "VARIOS 154",
        "nombre": "Tarta Ponche Genovés",
        "categoria": "Tartas Premium",
        "ingredientes": [
          { "nombre": "Bizcocho genovés", "cantidad": 1, "unidad": "plancha" },
          { "nombre": "Almíbar de vino de Málaga", "cantidad": 200, "unidad": "ml" },
          { "nombre": "Crema pastelera", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Nata montada", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Chantilly", "cantidad": 200, "unidad": "gr" }
        ],
        "elaboracion": [
          "Cortar el bizcocho en dos capas.",
          "Emborrar con almíbar de vino de Málaga.",
          "Rellenar con crema pastelera y nata.",
          "Cubrir con chantilly y decorar con guindas."
        ]
      },
      {
        "id": "VARIOS 155",
        "nombre": "Tarta Mascota",
        "categoria": "Tartas Premium",
        "ingredientes": [
          { "nombre": "Bizcocho molde", "cantidad": 1, "unidad": "unidad" },
          { "nombre": "Almíbar de emborrachar", "cantidad": 200, "unidad": "ml" },
          { "nombre": "Crema de mantequilla", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Almendra fileteada", "cantidad": 100, "unidad": "gr" }
        ],
        "elaboracion": [
          "Partimos de un bizcocho relleno de crema de mantequilla.",
          "Cubrimos la superficie y los laterales con crema de mantequilla.",
          "Aplanamos con espátula.",
          "Decoramos con almendra fileteada."
        ]
      },
      {
        "id": "VARIOS 156",
        "nombre": "Terrina de Frutas",
        "categoria": "Tartas Premium",
        "ingredientes": [
          { "nombre": "Plancha de bizcocho", "cantidad": 1, "unidad": "unidad" },
          { "nombre": "Mantequilla", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Azúcar lustre", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Almendra molida", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Nata líquida", "cantidad": 300, "unidad": "ml" },
          { "nombre": "Kiwi", "cantidad": 3, "unidad": "unidades" },
          { "nombre": "Fresas", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Melocotón en almíbar", "cantidad": 200, "unidad": "gr" }
        ],
        "elaboracion": [
          "Forrar molde con film transparente.",
          "Colocar capa de bizcocho.",
          "Rellenar con mezcla de mantequilla, azúcar, almendra y nata.",
          "Añadir frutas cortadas.",
          "Congelar y desmoldar."
        ]
      },
      {
        "id": "VARIOS 157",
        "nombre": "Tarta de Enrejado",
        "categoria": "Tartas Premium",
        "ingredientes": [
          { "nombre": "Recortes de hojaldre", "cantidad": 1, "unidad": "masa" },
          { "nombre": "Crema pastelera", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Frambuesas", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Gelatina de manzana", "cantidad": 1, "unidad": "sobre" }
        ],
        "elaboracion": [
          "Forrar molde con hojaldre.",
          "Rellenar con crema pastelera.",
          "Colocar frambuesas.",
          "Hacer rejilla con tiras de hojaldre.",
          "Hornear a 180°C.",
          "Abrillantar con gelatina."
        ],
        "temperatura": 180,
        "tiempo": 35
      },
      {
        "id": "VARIOS 159",
        "nombre": "Tarta de Chocolatina",
        "categoria": "Tartas Premium",
        "ingredientes": [
          { "nombre": "Bizcocho genovés", "cantidad": 1, "unidad": "plancha" },
          { "nombre": "Almíbar de café", "cantidad": 200, "unidad": "ml" },
          { "nombre": "Trufa negra", "cantidad": 400, "unidad": "gr" },
          { "nombre": "Virutas de chocolate", "cantidad": 100, "unidad": "gr" }
        ],
        "elaboracion": [
          "Cortar bizcocho en dos capas.",
          "Emborrar con almíbar de café.",
          "Rellenar con trufa negra.",
          "Cubrir con trufa y decorar con virutas."
        ]
      },
      // === BIZCOCHOS, MAGDALENAS & MUFFINS ===
      {
        "id": "VARIOS 67",
        "nombre": "Sobao Pasiego",
        "categoria": "Bizcochos, Magdalenas & Muffins",
        "ingredientes": [
          { "nombre": "Mantequilla", "cantidad": 1000, "unidad": "gr" },
          { "nombre": "Azúcar glasé", "cantidad": 1000, "unidad": "gr" },
          { "nombre": "Huevos", "cantidad": 15, "unidad": "unidades" },
          { "nombre": "Ron", "cantidad": 50, "unidad": "ml" },
          { "nombre": "Harina floja", "cantidad": 1000, "unidad": "gr" },
          { "nombre": "Impulsor", "cantidad": 10, "unidad": "gr" }
        ],
        "elaboracion": [
          "Batir mantequilla con azúcar, añadir huevos uno a uno.",
          "Incorporar harina con impulsor, ron y mezclar delicadamente.",
          "Hornear a 180°C."
        ],
        "temperatura": 180,
        "tiempo": 30
      },
      {
        "id": "VARIOS 202",
        "nombre": "San Blas",
        "categoria": "Bizcochos, Magdalenas & Muffins",
        "ingredientes": [
          { "nombre": "Harina", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 250, "unidad": "gr" },
          { "nombre": "Huevos", "cantidad": 5, "unidad": "unidades" },
          { "nombre": "Mantequilla", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Leche", "cantidad": 100, "unidad": "ml" },
          { "nombre": "Impulsor", "cantidad": 10, "unidad": "gr" }
        ],
        "elaboracion": [
          "Batir mantequilla con azúcar, añadir huevos uno a uno.",
          "Incorporar harina con impulsor y leche.",
          "Hornear a 180°C durante 25 minutos."
        ],
        "temperatura": 180,
        "tiempo": 25
      },
      {
        "id": "VARIOS 58",
        "nombre": "Bizcocho de Chocolate",
        "categoria": "Bizcochos, Magdalenas & Muffins",
        "ingredientes": [
          { "nombre": "Huevos", "cantidad": 4, "unidad": "unidades" },
          { "nombre": "Azúcar", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Harina", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Cacao en polvo", "cantidad": 50, "unidad": "gr" },
          { "nombre": "Mantequilla", "cantidad": 100, "unidad": "gr" },
          { "nombre": "Leche", "cantidad": 100, "unidad": "ml" },
          { "nombre": "Impulsor", "cantidad": 10, "unidad": "gr" }
        ],
        "elaboracion": [
          "Batir huevos con azúcar hasta doblar volumen.",
          "Añadir harina, cacao, mantequilla derretida, leche e impulsor.",
          "Hornear a 180°C durante 30 minutos."
        ],
        "temperatura": 180,
        "tiempo": 30
      },
      {
        "id": "VARIOS 59",
        "nombre": "Bizcocho de Naranja",
        "categoria": "Bizcochos, Magdalenas & Muffins",
        "ingredientes": [
          { "nombre": "Huevos", "cantidad": 4, "unidad": "unidades" },
          { "nombre": "Azúcar", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Harina", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Zumo de naranja", "cantidad": 100, "unidad": "ml" },
          { "nombre": "Ralladura de naranja", "cantidad": 1, "unidad": "unidad" },
          { "nombre": "Mantequilla", "cantidad": 100, "unidad": "gr" },
          { "nombre": "Impulsor", "cantidad": 10, "unidad": "gr" }
        ],
        "elaboracion": [
          "Batir huevos con azúcar hasta doblar volumen.",
          "Añadir harina, zumo, ralladura, mantequilla derretida e impulsor.",
          "Hornear a 180°C durante 30 minutos."
        ],
        "temperatura": 180,
        "tiempo": 30
      },
      {
        "id": "VARIOS 68",
        "nombre": "Magdalenas",
        "categoria": "Bizcochos, Magdalenas & Muffins",
        "ingredientes": [
          { "nombre": "Huevos", "cantidad": 10, "unidad": "unidades" },
          { "nombre": "Azúcar", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Harina", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Mantequilla", "cantidad": 250, "unidad": "gr" },
          { "nombre": "Leche", "cantidad": 100, "unidad": "ml" },
          { "nombre": "Impulsor", "cantidad": 10, "unidad": "gr" }
        ],
        "elaboracion": [
          "Batir huevos con azúcar hasta doblar volumen.",
          "Incorporar harina, mantequilla derretida, leche e impulsor.",
          "Escudillar en moldes y hornear a 180°C durante 20 minutos."
        ],
        "temperatura": 180,
        "tiempo": 20
      },
      {
        "id": "VARIOS 61",
        "nombre": "Bizcocho de Manzana",
        "categoria": "Bizcochos, Magdalenas & Muffins",
        "ingredientes": [
          { "nombre": "Huevos", "cantidad": 4, "unidad": "unidades" },
          { "nombre": "Azúcar", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Harina", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Manzanas", "cantidad": 2, "unidad": "unidades" },
          { "nombre": "Mantequilla", "cantidad": 100, "unidad": "gr" },
          { "nombre": "Impulsor", "cantidad": 10, "unidad": "gr" }
        ],
        "elaboracion": [
          "Batir huevos con azúcar hasta doblar volumen.",
          "Añadir harina, manzana rallada, mantequilla derretida e impulsor.",
          "Hornear a 180°C durante 30 minutos."
        ],
        "temperatura": 180,
        "tiempo": 30
      },
      {
        "id": "VARIOS 60",
        "nombre": "Bizcocho de Coco",
        "categoria": "Bizcochos, Magdalenas & Muffins",
        "ingredientes": [
          { "nombre": "Huevos", "cantidad": 4, "unidad": "unidades" },
          { "nombre": "Azúcar", "cantidad": 400, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 200, "unidad": "cc" },
          { "nombre": "Harina", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Levadura royal", "cantidad": 1, "unidad": "sobre" },
          { "nombre": "Coco rallado", "cantidad": 50, "unidad": "gr" }
        ],
        "elaboracion": [
          "Batir huevos con azúcar, agregar agua hirviendo, harina, levadura y coco.",
          "Verter en molde engrasado y enharinado.",
          "Hornear a fuego lento los primeros 10 minutos, luego aumentar temperatura."
        ],
        "tiempo": 50
      },
      {
        "id": "VARIOS 195",
        "nombre": "Coquitos",
        "categoria": "Bizcochos, Magdalenas & Muffins",
        "ingredientes": [
          { "nombre": "Huevos", "cantidad": 3, "unidad": "unidades" },
          { "nombre": "Azúcar", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Coco rallado", "cantidad": 250, "unidad": "gr" }
        ],
        "elaboracion": [
          "Mezclar ingredientes y dejar reposar en frigorífico.",
          "Formar bolas pequeñas y hornear a horno fuerte 20 minutos."
        ],
        "temperatura": 190,
        "tiempo": 20
      },
      {
        "id": "VARIOS 196",
        "nombre": "Macarrón de Almendra",
        "categoria": "Bizcochos, Magdalenas & Muffins",
        "ingredientes": [
          { "nombre": "Almendra molida", "cantidad": 480, "unidad": "gr" },
          { "nombre": "Azúcar grano", "cantidad": 400, "unidad": "gr" },
          { "nombre": "Claritas", "cantidad": 180, "unidad": "gr" }
        ],
        "elaboracion": [
          "Mezclar todos los ingredientes hasta formar una masa homogénea.",
          "Escudillar con manga sobre placa.",
          "Secar a 40-50°C durante varias horas.",
          "Cocer a 140°C cuando estén secos."
        ],
        "temperatura": 140,
        "tiempo": 15
      },
      {
        "id": "VARIOS 199",
        "nombre": "Empiñonadas",
        "categoria": "Bizcochos, Magdalenas & Muffins",
        "ingredientes": [
          { "nombre": "Almendra molida", "cantidad": 250, "unidad": "gr" },
          { "nombre": "Azúcar lustre", "cantidad": 225, "unidad": "gr" },
          { "nombre": "Claras de huevo", "cantidad": 1, "unidad": "cantidad" },
          { "nombre": "Piñones", "cantidad": 100, "unidad": "gr" }
        ],
        "elaboracion": [
          "Mezclar almendra, azúcar y claras.",
          "Formar bolas, rebozar con piñones.",
          "Cocer a horno a 180-200°C."
        ],
        "temperatura": 190,
        "tiempo": 18
      },
      // === DULCES & CONFITES ===
      {
        "id": "VARIOS 173",
        "nombre": "Trufa Negra",
        "categoria": "Dulces & Confites",
        "ingredientes": [
          { "nombre": "Nata", "cantidad": 350, "unidad": "gr" },
          { "nombre": "Cobertura negra", "cantidad": 650, "unidad": "gr" },
          { "nombre": "Cognac", "cantidad": 2, "unidad": "cda" }
        ],
        "elaboracion": [
          "Calentar la nata y verter sobre la cobertura.",
          "Disolver con espátula, añadir cognac.",
          "Dejar enfriar, hacer bolas y bañar en cobertura o cacao."
        ]
      },
      {
        "id": "VARIOS 48",
        "nombre": "Trufa Cocida",
        "categoria": "Dulces & Confites",
        "ingredientes": [
          { "nombre": "Nata líquida", "cantidad": 1000, "unidad": "ml" },
          { "nombre": "Cobertura negra", "cantidad": 140, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 150, "unidad": "gr" }
        ],
        "elaboracion": [
          "Mezclar todos los ingredientes y llevar al fuego hasta disolver la cobertura.",
          "Enfriar en cámara toda la noche.",
          "Al día siguiente, montar con varilla hasta obtener textura cremosa.",
          "Formar bolas y rodar en cacao en polvo."
        ]
      },
      {
        "id": "VARIOS 49",
        "nombre": "Trufa Cocida Blanca",
        "categoria": "Dulces & Confites",
        "ingredientes": [
          { "nombre": "Nata líquida", "cantidad": 1000, "unidad": "ml" },
          { "nombre": "Cobertura blanca", "cantidad": 400, "unidad": "gr" }
        ],
        "elaboracion": [
          "Cocer de víspera la nata con la cobertura.",
          "Enfriar en cámara y al día siguiente proceder a montarla."
        ]
      },
      {
        "id": "VARIOS 50",
        "nombre": "Toffe",
        "categoria": "Dulces & Confites",
        "ingredientes": [
          { "nombre": "Nata líquida", "cantidad": 1000, "unidad": "ml" },
          { "nombre": "Azúcar", "cantidad": 250, "unidad": "gr" }
        ],
        "elaboracion": [
          "Hacer caramelo rubio con azúcar.",
          "Añadir nata caliente con cuidado.",
          "Hervir hasta disolución completa.",
          "Usar como salsa o montar al día siguiente."
        ]
      },
      {
        "id": "VARIOS 178",
        "nombre": "Mazapán",
        "categoria": "Dulces & Confites",
        "ingredientes": [
          { "nombre": "Almendra molida", "cantidad": 1000, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 1000, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 200, "unidad": "ml" },
          { "nombre": "Glucosa", "cantidad": 100, "unidad": "gr" }
        ],
        "elaboracion": [
          "Mezclar todos los ingredientes hasta formar una masa homogénea.",
          "Amasar y moldear como se desee.",
          "Secar al aire o en horno muy bajo."
        ]
      },
      {
        "id": "VARIOS 180",
        "nombre": "Turrón de Yema",
        "categoria": "Dulces & Confites",
        "ingredientes": [
          { "nombre": "Nata", "cantidad": 125, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 125, "unidad": "gr" },
          { "nombre": "Yemas", "cantidad": 9, "unidad": "unidades" },
          { "nombre": "Almíbar", "cantidad": 1, "unidad": "kilo" },
          { "nombre": "Almendra molida", "cantidad": 1, "unidad": "kilo" },
          { "nombre": "Glucosa", "cantidad": 50, "unidad": "gr" },
          { "nombre": "Vainillina", "cantidad": 1, "unidad": "cda" }
        ],
        "elaboracion": [
          "Elaborar almíbar a punto de bola floja.",
          "Mezclar con yemas, nata, almendra y glucosa.",
          "Moldear y enfriar."
        ]
      },
      {
        "id": "VARIOS 182",
        "nombre": "Turrón de Coco",
        "categoria": "Dulces & Confites",
        "ingredientes": [
          { "nombre": "Almíbar", "cantidad": 1, "unidad": "kilo" },
          { "nombre": "Agua", "cantidad": 350, "unidad": "gr" },
          { "nombre": "Coco rallado", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Almendra molida", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Glucosa", "cantidad": 125, "unidad": "gr" }
        ],
        "elaboracion": [
          "Hacer almíbar con azúcar, agua y glucosa.",
          "Añadir coco y almendra.",
          "Verter en molde, enfriar y cortar."
        ]
      },
      {
        "id": "VARIOS 183",
        "nombre": "Turrón de Pistachos",
        "categoria": "Dulces & Confites",
        "ingredientes": [
          { "nombre": "Almíbar", "cantidad": 1, "unidad": "kilo" },
          { "nombre": "Agua", "cantidad": 330, "unidad": "gr" },
          { "nombre": "Pistachos molidos", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Almendra molida", "cantidad": 500, "unidad": "gr" }
        ],
        "elaboracion": [
          "Hacer almíbar a punto de hebra floja.",
          "Mezclar con pistachos y almendra.",
          "Moldear, prensar y reposar."
        ]
      },
      {
        "id": "VARIOS 184",
        "nombre": "Guirlache",
        "categoria": "Dulces & Confites",
        "ingredientes": [
          { "nombre": "Azúcar", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Manteca de cerdo", "cantidad": 10, "unidad": "gr" },
          { "nombre": "Canela", "cantidad": 5, "unidad": "gr" },
          { "nombre": "Zumo de limón", "cantidad": 1, "unidad": "chorro" },
          { "nombre": "Almendras marcona", "cantidad": 450, "unidad": "gr" }
        ],
        "elaboracion": [
          "Hacer caramelo rubio con azúcar, manteca, canela y limón.",
          "Añadir almendras tostadas.",
          "Extender sobre mármol engrasado.",
          "Cortar en barritas antes de enfriar."
        ]
      },
      {
        "id": "VARIOS 181",
        "nombre": "Turrón de Nata Nuez",
        "categoria": "Dulces & Confites",
        "ingredientes": [
          { "nombre": "Nata", "cantidad": 400, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 1125, "unidad": "gr" },
          { "nombre": "Almendra molida", "cantidad": 1000, "unidad": "gr" },
          { "nombre": "Nueces", "cantidad": 750, "unidad": "gr" },
          { "nombre": "Vainillina", "cantidad": 1, "unidad": "cda" }
        ],
        "elaboracion": [
          "Hervir nata con azúcar, añadir almendra, nueces y vainillina.",
          "Moldear, prensar y dejar reposar mínimo un día."
        ]
      },
      // === MASAS & PASTELES ===
      {
        "id": "VARIOS 75",
        "nombre": "Hojaldre (Fórmula Tradicional)",
        "categoria": "Masas & Pasteles",
        "ingredientes": [
          { "nombre": "Harina fuerte", "cantidad": 1000, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 600, "unidad": "gr" },
          { "nombre": "Sal", "cantidad": 20, "unidad": "gr" },
          { "nombre": "Manteca de cerdo o mantequilla", "cantidad": 600, "unidad": "gr" }
        ],
        "elaboracion": [
          "Mezclar harina, agua y sal. Formar un plastón.",
          "Enfriar 30 minutos.",
          "Estirar y colocar la grasa en el centro. Doblar como libro.",
          "Repetir 3-4 vueltas simples, refrigerando entre cada una."
        ]
      },
      {
        "id": "VARIOS 83",
        "nombre": "Palmeras",
        "categoria": "Masas & Pasteles",
        "ingredientes": [
          { "nombre": "Plastón de hojaldre", "cantidad": 1, "unidad": "masa" },
          { "nombre": "Azúcar en grano", "cantidad": 200, "unidad": "gr" }
        ],
        "elaboracion": [
          "Hacer una masa de hojaldre a la que se dan 6 pliegues sencillos.",
          "En el último pliegue espolvorear con azúcar en grano y estirar.",
          "Se monta la masa tres veces por cada lado, juntar y cortar en palmeras.",
          "Hornear a 200-210°C hasta dorar."
        ],
        "temperatura": 205,
        "tiempo": 22
      },
      {
        "id": "VARIOS 187",
        "nombre": "Cigarrillos Rusos",
        "categoria": "Masas & Pasteles",
        "ingredientes": [
          { "nombre": "Hojaldre", "cantidad": 1, "unidad": "masa" },
          { "nombre": "Azúcar glass", "cantidad": 100, "unidad": "gr" },
          { "nombre": "Clara de huevo", "cantidad": 1, "unidad": "unidad" }
        ],
        "elaboracion": [
          "Estirar el hojaldre muy fino y pintar con clara de huevo.",
          "Espolvorear con azúcar glass.",
          "Enrollar como si fuera un brazo de gitano y cortar en rodajas finas.",
          "Hornear a 200°C hasta dorar."
        ],
        "temperatura": 200,
        "tiempo": 15
      },
      {
        "id": "VARIOS 190",
        "nombre": "Lenguas de Gato",
        "categoria": "Masas & Pasteles",
        "ingredientes": [
          { "nombre": "Mantequilla", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Azúcar glass", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Harina", "cantidad": 200, "unidad": "gr" }
        ],
        "elaboracion": [
          "Batir mantequilla con azúcar glass.",
          "Incorporar harina con espátula.",
          "Escudillar en boquilla rizada.",
          "Hornear a 180°C sin abrir el horno."
        ],
        "temperatura": 180,
        "tiempo": 12
      },
      // === POSTRES FRÍOS ===
      {
        "id": "VARIOS 13",
        "nombre": "Flan de Chocolate",
        "categoria": "Postres Fríos",
        "ingredientes": [
          { "nombre": "Leche", "cantidad": 250, "unidad": "ml" },
          { "nombre": "Nata líquida", "cantidad": 250, "unidad": "ml" },
          { "nombre": "Azúcar", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Cobertura negra", "cantidad": 100, "unidad": "gr" },
          { "nombre": "Huevos", "cantidad": 6, "unidad": "unidades" },
          { "nombre": "Salsa de caramelo", "cantidad": 1, "unidad": "cantidad" }
        ],
        "elaboracion": [
          "Mezclar leche, nata, azúcar y cobertura fundida.",
          "Añadir huevos batidos.",
          "Verter en moldes con caramelo.",
          "Cocer al baño María a 160°C durante 45 minutos.",
          "Enfriar y desmoldar."
        ],
        "temperatura": 160,
        "tiempo": 45
      },
      {
        "id": "VARIOS 25",
        "nombre": "Compota de Manzana",
        "categoria": "Postres Fríos",
        "ingredientes": [
          { "nombre": "Manzanas", "cantidad": 1000, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Vino blanco", "cantidad": 250, "unidad": "ml" },
          { "nombre": "Orejones", "cantidad": 50, "unidad": "gr" },
          { "nombre": "Pasas", "cantidad": 30, "unidad": "gr" }
        ],
        "elaboracion": [
          "Pelar y cortar manzanas.",
          "Cocer con azúcar, vino y frutas secas.",
          "Dejar enfriar antes de servir."
        ]
      },
      {
        "id": "VARIOS 26",
        "nombre": "Peras en Almíbar",
        "categoria": "Postres Fríos",
        "ingredientes": [
          { "nombre": "Peras", "cantidad": 1000, "unidad": "gr" },
          { "nombre": "Vino blanco", "cantidad": 500, "unidad": "ml" },
          { "nombre": "Azúcar", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 500, "unidad": "ml" },
          { "nombre": "Canela en rama", "cantidad": 1, "unidad": "unidad" },
          { "nombre": "Cáscara de limón", "cantidad": 1, "unidad": "unidad" }
        ],
        "elaboracion": [
          "Pelar peras y mantener en agua con limón.",
          "Hervir agua, vino, azúcar, canela y limón.",
          "Añadir peras y cocer a fuego lento 20-30 min.",
          "Dejar enfriar en el almíbar."
        ],
        "tiempo": 25
      },
      {
        "id": "VARIOS 27",
        "nombre": "Arroz con Leche",
        "categoria": "Postres Fríos",
        "ingredientes": [
          { "nombre": "Arroz", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Leche", "cantidad": 1000, "unidad": "ml" },
          { "nombre": "Azúcar", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Canela en rama", "cantidad": 1, "unidad": "unidad" },
          { "nombre": "Cáscara de limón", "cantidad": 1, "unidad": "unidad" },
          { "nombre": "Vainilla", "cantidad": 1, "unidad": "unidad" }
        ],
        "elaboracion": [
          "Cocer el arroz en leche con azúcar, canela, limón y vainilla.",
          "Dejar enfriar y servir frío con canela por encima."
        ]
      },
      {
        "id": "VARIOS 28",
        "nombre": "Leche Frita",
        "categoria": "Postres Fríos",
        "ingredientes": [
          { "nombre": "Leche", "cantidad": 1000, "unidad": "ml" },
          { "nombre": "Harina", "cantidad": 100, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Canela", "cantidad": 10, "unidad": "gr" },
          { "nombre": "Aceite para freír", "cantidad": 500, "unidad": "ml" }
        ],
        "elaboracion": [
          "Cocer leche con azúcar, canela y harina hasta espesar.",
          "Enfriar, cortar en dados y freír.",
          "Espolvorear con azúcar y canela."
        ]
      },
      {
        "id": "VARIOS 29",
        "nombre": "Torrijas",
        "categoria": "Postres Fríos",
        "ingredientes": [
          { "nombre": "Pan de brioche", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Leche", "cantidad": 500, "unidad": "ml" },
          { "nombre": "Huevos", "cantidad": 3, "unidad": "unidades" },
          { "nombre": "Azúcar", "cantidad": 100, "unidad": "gr" },
          { "nombre": "Canela", "cantidad": 10, "unidad": "gr" },
          { "nombre": "Aceite", "cantidad": 300, "unidad": "ml" }
        ],
        "elaboracion": [
          "Remojar pan en leche con canela y azúcar.",
          "Pasar por huevo y freír.",
          "Espolvorear con azúcar y canela."
        ]
      },
      {
        "id": "VARIOS 30",
        "nombre": "Goxua",
        "categoria": "Postres Fríos",
        "ingredientes": [
          { "nombre": "Bizcocho corriente", "cantidad": 1, "unidad": "plancha" },
          { "nombre": "Crema pastelera", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Nata montada", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Caramelo", "cantidad": 100, "unidad": "gr" }
        ],
        "elaboracion": [
          "Cortar el bizcocho en cuadrados.",
          "Rellenar con crema y nata.",
          "Baño de caramelo por encima."
        ]
      },
      {
        "id": "VARIOS 31",
        "nombre": "Pastel Vasco",
        "categoria": "Postres Fríos",
        "ingredientes": [
          { "nombre": "Harina", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Mantequilla", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Huevos", "cantidad": 4, "unidad": "unidades" },
          { "nombre": "Crema pastelera", "cantidad": 400, "unidad": "gr" }
        ],
        "elaboracion": [
          "Mezclar harina, azúcar, mantequilla y huevos hasta formar masa.",
          "Forrar molde y rellenar con crema pastelera.",
          "Hornear a 180°C durante 40 minutos."
        ],
        "temperatura": 180,
        "tiempo": 40
      },
      // === HELADOS & SORBETES ===
      {
        "id": "VARIOS 100",
        "nombre": "Sorbete de Limón al Champán",
        "categoria": "Helados & Sorbetes",
        "ingredientes": [
          { "nombre": "Almíbar a 28°Brix", "cantidad": 1, "unidad": "litro" },
          { "nombre": "Zumo de limón", "cantidad": 1, "unidad": "litro" }
        ],
        "elaboracion": [
          "Mezclar ambos ingredientes y enfriar bien.",
          "Introducir en heladora y dejar congelar."
        ]
      },
      {
        "id": "VARIOS 105",
        "nombre": "Sorbete de Limón",
        "categoria": "Helados & Sorbetes",
        "ingredientes": [
          { "nombre": "Zumo de limón", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Glucosa", "cantidad": 100, "unidad": "gr" },
          { "nombre": "Maicena", "cantidad": 20, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 480, "unidad": "gr" }
        ],
        "elaboracion": [
          "Mezclar sacarosa con maicena, añadir agua y cocer.",
          "Enfriar, añadir zumo y helar."
        ]
      },
      {
        "id": "VARIOS 118",
        "nombre": "Mousse de Cava",
        "categoria": "Helados & Sorbetes",
        "ingredientes": [
          { "nombre": "Cava", "cantidad": 750, "unidad": "ml" },
          { "nombre": "Azúcar", "cantidad": 360, "unidad": "gr" },
          { "nombre": "Gelatina", "cantidad": 24, "unidad": "gr" },
          { "nombre": "Yemas", "cantidad": 3, "unidad": "unidades" },
          { "nombre": "Nata líquida", "cantidad": 400, "unidad": "ml" }
        ],
        "elaboracion": [
          "Calentar cava con azúcar y gelatina.",
          "Añadir yemas, enfriar y mezclar con nata montada.",
          "Congelar."
        ]
      },
      {
        "id": "VARIOS 97",
        "nombre": "Sorbete de Naranja",
        "categoria": "Helados & Sorbetes",
        "ingredientes": [
          { "nombre": "Agua", "cantidad": 250, "unidad": "ml" },
          { "nombre": "Azúcar", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Ralladura de naranja", "cantidad": 1, "unidad": "cantidad" },
          { "nombre": "Zumo de naranja", "cantidad": 500, "unidad": "ml" },
          { "nombre": "Clara de huevo", "cantidad": 1, "unidad": "unidad" }
        ],
        "elaboracion": [
          "Hacer almíbar con agua y azúcar.",
          "Añadir ralladura, zumo y clara batida.",
          "Congelar en heladora."
        ]
      },
      {
        "id": "VARIOS 106",
        "nombre": "Bavarois de Chocolate",
        "categoria": "Helados & Sorbetes",
        "ingredientes": [
          { "nombre": "Chocolate negro", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Leche", "cantidad": 500, "unidad": "ml" },
          { "nombre": "Azúcar", "cantidad": 100, "unidad": "gr" },
          { "nombre": "Huevos", "cantidad": 4, "unidad": "unidades" },
          { "nombre": "Gelatina", "cantidad": 10, "unidad": "gr" }
        ],
        "elaboracion": [
          "Derretir chocolate con leche y azúcar.",
          "Añadir yemas, gelatina reblandecida.",
          "Montar claras y nata, incorporar.",
          "Enmoldar y refrigerar."
        ]
      },
      // === RELLENOS & COBERTURAS ===
      {
        "id": "VARIOS 221",
        "nombre": "Coulis de Frutos Rojos",
        "categoria": "Rellenos & Coberturas",
        "ingredientes": [
          { "nombre": "Fruta roja", "cantidad": 1000, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 400, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 250, "unidad": "ml" }
        ],
        "elaboracion": [
          "Hervir todos los ingredientes hasta densidad media.",
          "Triturar y colar por chino fino."
        ]
      },
      {
        "id": "VARIOS 215",
        "nombre": "Glassa Antihumedad",
        "categoria": "Decoración & Acabados",
        "ingredientes": [
          { "nombre": "Azúcar glass", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Clara de huevo deshidratada", "cantidad": 20, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 100, "unidad": "ml" }
        ],
        "elaboracion": [
          "Mezclar todos los ingredientes hasta homogeneidad.",
          "Dejar reposar 12 horas tapado.",
          "Ideal para decorar tartas sin que se humedezcan."
        ]
      },
      {
        "id": "VARIOS 223",
        "nombre": "Coulis de Manzana",
        "categoria": "Rellenos & Coberturas",
        "ingredientes": [
          { "nombre": "Manzanas", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 375, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 75, "unidad": "gr" },
          { "nombre": "Zumo de limón", "cantidad": 1, "unidad": "unidad" },
          { "nombre": "Vainilla", "cantidad": 0.25, "unidad": "vaina" }
        ],
        "elaboracion": [
          "Cocer manzanas con resto de ingredientes.",
          "Triturar, colar y ajustar espesor."
        ]
      },
      {
        "id": "VARIOS 224",
        "nombre": "Coulis de Kiwi",
        "categoria": "Rellenos & Coberturas",
        "ingredientes": [
          { "nombre": "Kiwi", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 100, "unidad": "ml" }
        ],
        "elaboracion": [
          "Pelar y triturar kiwi.",
          "Añadir azúcar y agua.",
          "Cocer ligeramente y colar."
        ]
      },
      {
        "id": "VARIOS 216",
        "nombre": "Baño de Cobertura",
        "categoria": "Decoración & Acabados",
        "ingredientes": [
          { "nombre": "Cobertura negra", "cantidad": 1000, "unidad": "gr" },
          { "nombre": "Mantequilla", "cantidad": 1000, "unidad": "gr" },
          { "nombre": "Glucosa", "cantidad": 2, "unidad": "cda" }
        ],
        "elaboracion": [
          "Derretir cobertura con mantequilla y glucosa.",
          "Usar como baño para tartas y bombones."
        ]
      },
      // === DECORACIÓN & ACABADOS ===
      {
        "id": "VARIOS 225",
        "nombre": "Merengue Italiano",
        "categoria": "Decoración & Acabados",
        "ingredientes": [
          { "nombre": "Claras de huevo", "cantidad": 100, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 50, "unidad": "ml" },
          { "nombre": "Azúcar invertido", "cantidad": 10, "unidad": "gr" }
        ],
        "elaboracion": [
          "Calentar azúcar, agua y azúcar invertido hasta 118°C.",
          "Verter sobre claras batidas a punto de nieve.",
          "Seguir batiendo hasta enfriar."
        ]
      },
      {
        "id": "VARIOS 226",
        "nombre": "Salsa de Fresa",
        "categoria": "Decoración & Acabados",
        "ingredientes": [
          { "nombre": "Fresas", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 100, "unidad": "ml" },
          { "nombre": "Glucosa", "cantidad": 50, "unidad": "gr" },
          { "nombre": "Limón", "cantidad": 1, "unidad": "unidad" }
        ],
        "elaboracion": [
          "Cocer fresas con azúcar, agua, glucosa y limón.",
          "Triturar y colar."
        ]
      },
      {
        "id": "VARIOS 227",
        "nombre": "Salsa de Módena",
        "categoria": "Decoración & Acabados",
        "ingredientes": [
          { "nombre": "Vinagre de módena", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 400, "unidad": "gr" },
          { "nombre": "Zumo de limón", "cantidad": 1, "unidad": "chorro" },
          { "nombre": "Agua", "cantidad": 1, "unidad": "chorro" }
        ],
        "elaboracion": [
          "Reducir vinagre. Hacer caramelo rubio con azúcar.",
          "Mezclar ambas elaboraciones. Debe quedar meloso."
        ]
      },
      // === NUEVAS RECETAS ADICIONALES PARA COMPLETAR 73 ===
      {
        "id": "VARIOS 174",
        "nombre": "Trufa con Leche",
        "categoria": "Dulces & Confites",
        "ingredientes": [
          { "nombre": "Nata", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Cobertura blanca", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Leche condensada", "cantidad": 100, "unidad": "gr" }
        ],
        "elaboracion": [
          "Calentar nata, añadir cobertura blanca y leche condensada.",
          "Dejar enfriar, hacer bolas y rodar en cacao."
        ]
      },
      {
        "id": "VARIOS 197",
        "nombre": "Marquesas",
        "categoria": "Bizcochos, Magdalenas & Muffins",
        "ingredientes": [
          { "nombre": "Huevos", "cantidad": 6, "unidad": "unidades" },
          { "nombre": "Azúcar", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Harina", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Mantequilla", "cantidad": 50, "unidad": "gr" }
        ],
        "elaboracion": [
          "Batir huevos con azúcar hasta triplicar volumen.",
          "Incorporar harina y mantequilla derretida con cuidado.",
          "Hornear a 180°C durante 25 minutos."
        ],
        "temperatura": 180,
        "tiempo": 25
      },
      {
        "id": "VARIOS 171",
        "nombre": "San Honore",
        "categoria": "Tartas Premium",
        "ingredientes": [
          { "nombre": "Pasta choux", "cantidad": 1, "unidad": "masa" },
          { "nombre": "Pasta sable", "cantidad": 1, "unidad": "masa" },
          { "nombre": "Crema San Honore", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Caramelo", "cantidad": 100, "unidad": "gr" }
        ],
        "elaboracion": [
          "Elaborar profiteroles con pasta choux.",
          "Montar base con pasta sable.",
          "Rellenar con crema, colocar profiteroles y abrillantar con caramelo."
        ]
      },
      {
        "id": "VARIOS 122",
        "nombre": "Tarta de Frambuesas",
        "categoria": "Tartas del Ayer",
        "ingredientes": [
          { "nombre": "Base de galleta", "cantidad": 1, "unidad": "unidad" },
          { "nombre": "Crema pastelera", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Frambuesas", "cantidad": 400, "unidad": "gr" },
          { "nombre": "Gelatina de frambuesa", "cantidad": 1, "unidad": "sobre" }
        ],
        "elaboracion": [
          "Rellenar base con crema pastelera.",
          "Colocar frambuesas encima.",
          "Abrillantar con gelatina."
        ]
      },
      {
        "id": "VARIOS 129",
        "nombre": "Tarta de Queso (2ª Forma)",
        "categoria": "Tartas del Ayer",
        "ingredientes": [
          { "nombre": "Queso crema", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Huevos", "cantidad": 4, "unidad": "unidades" },
          { "nombre": "Galletas", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Mantequilla", "cantidad": 100, "unidad": "gr" },
          { "nombre": "Coulis de fruta", "cantidad": 200, "unidad": "gr" }
        ],
        "elaboracion": [
          "Base con galletas y mantequilla.",
          "Mezclar queso, azúcar y huevos.",
          "Verter sobre base y hornear al baño María.",
          "Desmoldar y cubrir con coulis."
        ],
        "temperatura": 160,
        "tiempo": 50
      },
      {
        "id": "VARIOS 46",
        "nombre": "Nata Montada",
        "categoria": "Rellenos & Coberturas",
        "ingredientes": [
          { "nombre": "Nata líquida", "cantidad": 1000, "unidad": "ml" },
          { "nombre": "Azúcar", "cantidad": 125, "unidad": "gr" }
        ],
        "elaboracion": [
          "Batir nata fría con azúcar hasta punto firme."
        ]
      },
      {
        "id": "VARIOS 45",
        "nombre": "Merengue Rápido",
        "categoria": "Decoración & Acabados",
        "ingredientes": [
          { "nombre": "Claritas", "cantidad": 400, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 600, "unidad": "gr" }
        ],
        "elaboracion": [
          "Mezclar y calentar al baño María hasta disolver azúcar.",
          "Batir hasta enfriar y tener cuerpo firme."
        ]
      }
    ];




  // estado global y storage keys
  const STORAGE = {
    NOTES: 'dp_notes_v1',
    FAVORITES: 'dp_favs_v1',
    TIMERS: 'dp_timers_v1',
    LAST_VIEW_RECIPE: 'dp_last_recipe_v1'
  };

  let historyStack = [{ id: 'view-main', data: null }];
  let currentView = 'view-main';
  let notes = JSON.parse(localStorage.getItem(STORAGE.NOTES) || '{}');
  let favorites = JSON.parse(localStorage.getItem(STORAGE.FAVORITES) || '[]');
  let timers = JSON.parse(localStorage.getItem(STORAGE.TIMERS) || '[]'); // array of {id, recipeId, label, remainingSec, running, endAt}

  /* ---------- helpers ---------- */
  function $(id){ return document.getElementById(id); }
  function saveNotes(){ localStorage.setItem(STORAGE.NOTES, JSON.stringify(notes)); }
  function saveFavorites(){ localStorage.setItem(STORAGE.FAVORITES, JSON.stringify(favorites)); }
  function saveTimers(){ localStorage.setItem(STORAGE.TIMERS, JSON.stringify(timers)); }

  function showView(id, data){
    // push new view to stack
    historyStack.push({ id, data });
    renderView(id, data);
  }
  function replaceView(id, data){
    // replace current view (useful for redirect)
    historyStack[historyStack.length-1] = { id, data };
    renderView(id, data);
  }
  function goBack(){
    if(historyStack.length <= 1) return;
    historyStack.pop();
    const last = historyStack[historyStack.length - 1];
    renderView(last.id, last.data);
  }

  function renderView(id, data){
    // hide all views
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    // show chosen view
    const view = $(id);
    if(!view) return;
    view.classList.add('active');
    currentView = id;

    // run renderers for dynamic content
    if(id === 'view-list') renderListView(data);
    if(id === 'view-recipe') renderRecipeView(data);
    if(id === 'view-notes') renderNotesAggregated();
    if(id === 'view-note-recipe') renderNoteForRecipe(data);
  }

  /* ---------- search (input) ---------- */
  const searchInput = $('searchInput');
  searchInput.addEventListener('input', onSearchInput);
  searchInput.addEventListener('keydown', function(e){
    if(e.key === 'Enter') performSearch(searchInput.value.trim());
  });

  function onSearchInput(e){
    const q = (e.target.value || '').trim();
    if(!q) return; // only show when has text
    const qnorm = normalize(q);
    const matches = recetas.filter(r =>
      normalize(r.nombre).includes(qnorm) ||
      normalize(r.categoria || '').includes(qnorm) ||
      (r.ingredientes && r.ingredientes.some(i => normalize(i.nombre).includes(qnorm)))
    );
    if(matches.length) showSearchModal(matches);
  }

  function performSearch(q){
    if(!q) return;
    const qnorm = normalize(q);
    const matches = recetas.filter(r =>
      normalize(r.nombre).includes(qnorm) ||
      normalize(r.categoria || '').includes(qnorm) ||
      (r.ingredientes && r.ingredientes.some(i => normalize(i.nombre).includes(qnorm)))
    );
    if(matches.length) {
      showList(matches, `Resultados para "${q}"`);
    } else {
      alert('No hay resultados para: ' + q);
    }
    searchInput.value = ''; // reiniciar campo tras búsqueda
  }

  function showSearchModal(matches){
    const overlay = createOverlay();
    const modal = document.createElement('div'); modal.className = 'modal';
    modal.innerHTML = `<h3 style="margin:0 0 8px 0;">Resultados</h3><div id="modalResults"></div>
      <div style="text-align:center;margin-top:12px;"><button class="btn" id="closeModalBtn">Cerrar</button></div>`;
    overlay.appendChild(modal);
    $('overlayRoot').appendChild(overlay); $('overlayRoot').style.display = 'block';
    const container = modal.querySelector('#modalResults');
    container.innerHTML = matches.map(r => `<div class="card"><div class="row"><div><div class="name">${escapeHtml(r.nombre)}</div><div class="muted">${escapeHtml(r.categoria||'')}</div></div><div><button class="btn" onclick="openRecipeById('${r.id}')">Abrir</button></div></div></div>`).join('');
    modal.querySelector('#closeModalBtn').onclick = closeOverlay;
  }

  function closeOverlay(){ const root=$('overlayRoot'); root.innerHTML=''; root.style.display='none'; }

  /* ---------- smart filters ---------- */
  function filterByTime(){
    // A, B, C allowed, case-insensitive
    let choice = prompt("Franja A: 1 - 20 min\nFranja B: 21 - 40 min\nFranja C: 41+ min\nElige A, B o C:") || '';
    choice = choice.trim().toLowerCase();
    if(!['a','b','c'].includes(choice)) { alert('Opción no válida'); return; }
    const list = recetas.filter(r => {
      const mins = recipeMaxMinutes(r);
      if(choice === 'a') return mins <= 20;
      if(choice === 'b') return mins >= 21 && mins <= 40;
      if(choice === 'c') return mins >= 41;
      return false;
    });
    showList(list, `Franja ${choice.toUpperCase()}`);
  }

  function filterByDifficulty(){
    // F (Fácil), M (Medio), D (Difícil) -> acepta mayúsc/minúsc
    let choice = prompt("¿ A que nivel de dificultad te atreves, Facil, Medio o Dificil ?\nElige un nivel: F, M, D:") || '';
    choice = choice.trim().toLowerCase();
    if(!['f','m','d'].includes(choice)) { alert('Opción no válida'); return; }
    const list = recetas.filter(r => {
      const mins = recipeMaxMinutes(r);
      if(choice === 'f') return mins === 0 || mins <= 20;
      if(choice === 'm') return mins >= 21 && mins <= 30;
      if(choice === 'd') return mins > 30;
      return false;
    });
    showList(list, `Nivel ${choice.toUpperCase()}`);
  }

  function filterByCategory(){
    let cat = prompt("¿Qué categoría buscas? Escribe el nombre:") || '';
    cat = cat.trim().toLowerCase();
    if(!cat) return;
    const list = recetas.filter(r => (r.categoria || '').toLowerCase().includes(cat));
    showList(list, `Categoría: ${cat}`);
  }

  /* ---------- list rendering ---------- */
  function showList(list, title){
    showView('view-list', { list, title });
  }
  function renderListView(data){
    const container = $('listContent');
    container.innerHTML = '';
    const titleEl = $('listTitle');
    titleEl.textContent = data?.title || 'Recetas';
    const list = data?.list || [];
    if(!list.length) {
      container.innerHTML = `<div class="card"><div class="muted">No hay resultados.</div></div>`;
      return;
    }
    container.innerHTML = list.map(r => `
      <div class="card">
        <div class="row">
          <div>
            <div class="name">${escapeHtml(r.nombre)}</div>
            <div class="muted">${escapeHtml(r.categoria || '')}</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <button class="btn" onclick="openRecipeById('${r.id}')">Abrir</button>
            <button title="Favorito" style="border-radius:10px;padding:8px 10px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent);cursor:pointer;" onclick="toggleFav('${r.id}', event)">${ favorites.includes(r.id) ? '★' : '☆' }</button>
          </div>
        </div>
      </div>
    `).join('');
  }

  /* ---------- open recipe ---------- */
  function openRecipeById(id){
    const recipe = recetas.find(r => r.id === id);
    if(!recipe) { alert('Receta no encontrada'); return; }
    // record last
    localStorage.setItem(STORAGE.LAST_VIEW_RECIPE, id);
    showView('view-recipe', { id });
  }

  function renderRecipeView(data){
    const id = data?.id;
    const r = recetas.find(x => x.id === id);
    if(!r) {
      $('recipeName').textContent = 'Receta no encontrada';
      $('recipeBody').innerHTML = '<div class="muted">Receta no existe</div>';
      return;
    }
    $('recipeName').textContent = r.nombre;
    $('recipeMeta').textContent = `${r.categoria || ''} · ${r.porciones ? r.porciones + ' porciones' : ''}`;
    // ingredientes
    const ingHtml = (r.ingredientes || []).map(i => {
      const unit = i.unidad ? ` ${i.unidad}` : '';
      return `<li>${escapeHtml(i.nombre)} <strong>(${i.cantidad || ''}${unit})</strong></li>`;
    }).join('');
    $('ingredientsSection').innerHTML = `<b>Ingredientes:</b><ul>${ingHtml}</ul>`;
    // elaboracion
    const elHtml = (r.elaboracion || []).map(step => `<li>${escapeHtml(step)}</li>`).join('');
    $('elaboracionSection').innerHTML = `<b>Elaboración:</b><ol>${elHtml}</ol>`;

    // populate custom timer select (1..90)
    const sel = $('customTimerSelect');
    sel.innerHTML = '';
    for(let m=1;m<=90;m++){
      const opt = document.createElement('option');
      opt.value = m; opt.textContent = `${m} min`;
      sel.appendChild(opt);
    }

    // attach custom timer add
    $('customTimerAdd').onclick = function(){
      const minutes = parseInt(sel.value,10) || 1;
      addTimer(r.id, `${r.nombre} (${minutes}m)`, minutes, true);
      alert('Temporizador añadido y arrancado: ' + minutes + ' min');
    };

    // detect timers automatically from elaboracion and show small UI to add them (not started by default)
    const detected = detectTimersFromElaboracion(r);
    // show detection as small list above ingredients
    let detectHtml = '';
    if(detected.length){
      detectHtml = `<div class="muted" style="margin-bottom:10px;"><strong>Temporizadores sugeridos:</strong></div>` +
        detected.map((d, idx) => `<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;"><div style="flex:1">${escapeHtml(d.label)} — ${d.minutes} min</div><div><button class="small-btn" onclick="addTimer('${r.id}', ${JSON.stringify(d.label+ ' ('+d.minutes+'m)')}, ${d.minutes}, false)">Añadir</button></div></div>`).join('');
    }
    // inject detectHtml into top of recipeBody
    const recipeBody = $('recipeBody');
    // ensure detected html appears above sections (we already set sections, so prepend)
    recipeBody.insertAdjacentHTML('afterbegin', detectHtml);

    // share & notes handlers
    $('shareRecipeBtn').onclick = function(){ shareRecipeFormatted(r); };
    $('notesRecipeBtn').onclick = function(){ showView('view-note-recipe', { id: r.id }); };

    // update timers display (ensures existing timers for this recipe are visible in global timer bar)
    renderTimerBar();
  }

  /* ---------- notes ---------- */
  function renderNoteForRecipe(data){
    const id = data?.id;
    const title = recetas.find(r=>r.id===id)?.nombre || 'Nota';
    $('noteRecipeTitle').textContent = title;
    $('noteTextarea').value = notes[id] || '';
    $('saveNoteBtn').onclick = function(){
      notes[id] = $('noteTextarea').value || '';
      saveNotes();
      alert('Nota guardada');
    };
    $('shareNoteBtn').onclick = function(){
      const txt = notes[id] || '';
      shareText(`Nota: ${title}\n\n${txt}`);
    };
  }

  function renderNotesAggregated(){
    const container = $('notesContainer');
    const entries = Object.entries(notes || {});
    if(!entries.length){
      container.innerHTML = `<div class="card"><div class="muted">No hay notas guardadas.</div></div>`;
      return;
    }
    // show chronologically (most recent at top). As we don't store timestamps, keep insertion order of object: we'll assume last saved is latest.
    container.innerHTML = entries.map(([rid, txt]) => {
      const recipe = recetas.find(r=>r.id===rid);
      return `<div class="card">
        <div class="row">
          <div>
            <div class="name">${escapeHtml(recipe?.nombre || rid)}</div>
            <div class="muted">${escapeHtml(recipe?.categoria || '')}</div>
            <div style="margin-top:8px;">${escapeHtml(txt).replace(/\n/g,'<br>')}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <button class="btn" onclick="openRecipeById('${rid}')">Abrir receta</button>
            <button class="btn" onclick="shareText('Nota de ' + ${JSON.stringify(String(recipe?.nombre||rid))} + '\\n\\n' + ${JSON.stringify('')})">Compartir</button>
          </div>
        </div>
      </div>`;
    }).join('');
  }

  /* ---------- favorites ---------- */
  function toggleFav(id, ev){
    ev.stopPropagation && ev.stopPropagation();
    if(favorites.includes(id)) favorites = favorites.filter(x=>x!==id); else favorites.push(id);
    saveFavorites();
    // rerender visible list if in view-list
    if(currentView === 'view-list') {
      const last = historyStack[historyStack.length-1];
      renderListView(last.data);
    }
  }
  function openStarRecipes(){
    const list = recetas.filter(r => favorites.includes(r.id));
    showList(list, 'Recetas estrella');
  }
  function openLastRecipe(){
    const lastId = localStorage.getItem(STORAGE.LAST_VIEW_RECIPE);
    if(lastId) openRecipeById(lastId); else alert('No hay última receta registrada.');
  }

  /* ---------- timers (multi) ---------- */
  // timers = [{id, recipeId, label, remainingSec, running, endAt}]
  const TIMER_UPDATE_MS = 700;
  let timerTicker = null;

  function addTimer(recipeId, label, minutes, autoStart){
    const id = 't' + Date.now() + Math.floor(Math.random()*9999);
    const sec = Math.max(1, Math.floor(minutes * 60));
    const t = { id, recipeId, label: String(label), remainingSec: sec, running: !!autoStart, endAt: autoStart ? Date.now() + sec*1000 : null, createdAt: Date.now() };
    timers.push(t);
    saveTimers();
    renderTimerBar();
  }

  function startTimerById(id){
    const t = timers.find(x=>x.id===id); if(!t) return;
    if(!t.running){
      t.endAt = Date.now() + (t.remainingSec || 0)*1000;
      t.running = true;
      saveTimers();
      renderTimerBar();
    }
  }
  function pauseTimerById(id){
    const t = timers.find(x=>x.id===id); if(!t) return;
    if(t.running){
      t.remainingSec = Math.max(0, Math.ceil((t.endAt - Date.now())/1000));
      t.endAt = null;
      t.running = false;
      saveTimers();
      renderTimerBar();
    }
  }
  function removeTimerById(id){
    timers = timers.filter(x=>x.id!==id);
    saveTimers();
    renderTimerBar();
  }

  function renderTimerBar(){
    const bar = $('timerBar');
    if(!timers.length){ bar.style.display='none'; bar.innerHTML=''; return; }
    bar.style.display = 'flex';
    // show all timers (running or paused) but emphasize running ones
    const now = Date.now();
    const html = timers.map(t => {
      let remaining = t.running ? Math.max(0, Math.ceil((t.endAt - now)/1000)) : (t.remainingSec || 0);
      const mm = Math.floor(remaining/60); const ss = remaining%60;
      return `<div class="timer-pill" title="${escapeHtml(t.label)}">
        <div style="font-weight:900;">${escapeHtml(t.label)}</div>
        <div style="opacity:0.85;">${mm}:${String(ss).padStart(2,'0')}</div>
        <div class="timer-controls">
          ${t.running ? `<button onclick="pauseTimerById('${t.id}')">Pausar</button>` : `<button onclick="startTimerById('${t.id}')">Iniciar</button>`}
          <button onclick="removeTimerById('${t.id}')">Eliminar</button>
        </div>
      </div>`;
    }).join('');
    bar.innerHTML = html;
  }

  function tickTimers(){
    const now = Date.now();
    let changed = false;
    timers.forEach(t => {
      if(t.running && t.endAt){
        const rem = Math.ceil((t.endAt - now)/1000);
        if(rem <= 0){
          // finished
          t.running = false;
          t.remainingSec = 0;
          t.endAt = null;
          changed = true;
          // notify: simple alert + beep
          try{ navigator.vibrate && navigator.vibrate(300); }catch(e){}
          // small visual alert: add temporary overlay
          showToast(`Temporizador terminado: ${t.label}`);
        }
      }
    });
    if(changed) saveTimers();
    renderTimerBar();
  }

  // periodic tick
  function ensureTimerTicker(){
    if(timerTicker) return;
    timerTicker = setInterval(tickTimers, TIMER_UPDATE_MS);
  }

  /* ---------- parser de tiempos en elaboracion ---------- */
  function detectTimersFromElaboracion(recipe){
    // Busca en cada paso patrones tipo "20 min", "15 minutos", "1h", "2 horas", "30 m", etc.
    // Devuelve array de { label: snippet, minutes: n }
    const steps = recipe.elaboracion || [];
    const found = [];
    const rxMin = /(\d{1,3})\s*(?:min(?:uto)?s?|m\b)/i;
    const rxHour = /(\d{1,2})\s*(?:h(?:ora)?s?)/i;
    for(const s of steps){
      let minutes = 0;
      const h = s.match(rxHour);
      const m = s.match(rxMin);
      if(h && !m){
        minutes = parseInt(h[1],10) * 60;
      } else if(m){
        minutes = parseInt(m[1],10);
        // also check if there is "horas" as well in the same step
        const h2 = s.match(rxHour);
        if(h2) minutes += parseInt(h2[1],10) * 60;
      } else {
        continue;
      }
      // snippet label: first 40 chars of step
      const label = (s.length > 60) ? (s.slice(0,60) + '...') : s;
      // avoid duplicates with same minutes & similar label
      if(!found.some(f => Math.abs(f.minutes - minutes) < 1 && f.label === label)){
        found.push({ label, minutes });
      }
    }
    return found;
  }

  // compute max minutes for recipe to help categorization
  function recipeMaxMinutes(r){
    // prefer explicit r.tiempo if provided
    if(r.tiempo) return Number(r.tiempo) || 0;
    // else use detected
    const detected = detectTimersFromElaboracion(r);
    if(!detected.length) return 0;
    return Math.max(...detected.map(d=>d.minutes));
  }

  /* ---------- sharing ---------- */
  function shareRecipeFormatted(recipe){
    // build styled text
    const title = recipe.nombre;
    const header = `${title}\n\n`;
    const ing = (recipe.ingredientes || []).map(i => `- ${i.nombre} ${i.cantidad ? '('+i.cantidad+(i.unidad?(' '+i.unidad):'')+')' : ''}`).join('\n');
    const el = (recipe.elaboracion || []).map((s,i) => `${i+1}. ${s}`).join('\n\n');
    const txt = `${header}Ingredientes:\n${ing}\n\nElaboración:\n${el}`;
    // try native share
    if(navigator.share){
      navigator.share({ title: title, text: txt }).catch(()=>showShareFallback(txt));
    } else {
      showShareFallback(txt);
    }
  }

  function shareText(text){
    if(navigator.share){
      navigator.share({ text }).catch(()=>showShareFallback(text));
    } else {
      showShareFallback(text);
    }
  }

  function showShareFallback(text){
    const overlay = createOverlay();
    const modal = document.createElement('div'); modal.className = 'modal';
    modal.innerHTML = `<h3>Compartir</h3>
      <div style="max-height:40vh; overflow:auto; padding:8px; border-radius:8px; background:rgba(0,0,0,0.15); margin-top:8px;">${escapeHtml(text).replace(/\n/g,'<br>')}</div>
      <div class="share-row">
        <button id="shareWhatsapp">WhatsApp</button>
        <button id="shareTelegram">Telegram</button>
        <button id="shareEmail">Email</button>
        <button id="shareSMS">SMS</button>
        <button id="copyShare">Copiar</button>
      </div>
      <div style="text-align:center;margin-top:12px;"><button class="btn" id="closeShare">Cerrar</button></div>`;
    overlay.appendChild(modal);
    $('overlayRoot').appendChild(overlay); $('overlayRoot').style.display='block';

    $('shareWhatsapp').onclick = ()=>{ window.open('https://wa.me/?text=' + encodeURIComponent(text), '_blank'); };
    $('shareTelegram').onclick = ()=>{ window.open('https://t.me/share/url?text=' + encodeURIComponent(text), '_blank'); };
    $('shareEmail').onclick = ()=>{ window.open('mailto:?subject=' + encodeURIComponent('Receta') + '&body=' + encodeURIComponent(text), '_self'); };
    $('shareSMS').onclick = ()=>{ window.open('sms:?body=' + encodeURIComponent(text), '_self'); };
    $('copyShare').onclick = ()=>{ navigator.clipboard.writeText(text).then(()=>alert('Copiado al portapapeles')); };
    $('closeShare').onclick = closeOverlay;
  }

  /* ---------- utilities ---------- */
  function normalize(s){ return String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function createOverlay(){
    const overlayRoot = $('overlayRoot');
    const div = document.createElement('div');
    div.className = 'overlay';
    // clicking outside modal closes it
    div.addEventListener('click', (ev)=>{ if(ev.target === div) { overlayRoot.innerHTML=''; overlayRoot.style.display='none'; } });
    return div;
  }

  function showToast(msg, time=2200){
    const existing = document.getElementById('dp_toast');
    if(existing) existing.remove();
    const t = document.createElement('div'); t.id='dp_toast';
    t.style.position='fixed'; t.style.bottom='90px'; t.style.left='50%'; t.style.transform='translateX(-50%)';
    t.style.background='rgba(0,0,0,0.7)'; t.style.color='white'; t.style.padding='10px 14px'; t.style.borderRadius='10px';
    t.style.zIndex='12000'; t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(()=>{ t.remove(); }, time);
  }

  /* ---------- initialize UI handlers ---------- */
  document.addEventListener('click', function(ev){
    // delegated back button handling
    const el = ev.target.closest('[data-action="back"]');
    if(el){ ev.preventDefault(); goBack(); }
  });

  // main buttons
  $('btnModo').onclick = function(){
    document.documentElement.classList.toggle('light');
  };
  $('btnSmart').onclick = function(){ showView('view-smart', null); };
  $('btnMenu').onclick = function(){ showView('view-menu', null); };
  $('btnEstrella').onclick = function(){ openStarRecipes(); };
  $('btnNotas').onclick = function(){ showView('view-notes', null); };

  // initialize search placeholder reset behavior on back: ensure searchInput resets when returning to main
  // when pressing back to main we want placeholder restored; we reset on enter or on search.
  // already handled: performSearch clears searchInput.

  /* ---------- on load ---------- */
  window.addEventListener('DOMContentLoaded', function(){
    // ensure single ticker
    ensureTimerTicker();
    // restore timers -> we already loaded timers from localStorage at top
    renderTimerBar();

    // enable opening recipe from the last viewed (optional)
    const last = localStorage.getItem(STORAGE.LAST_VIEW_RECIPE);
    if(last) {
      // keep at main but not open automatically
    }

    // intercept form enter on searchInput
    searchInput.addEventListener('keypress', function(e){ if(e.key === 'Enter') { performSearch(searchInput.value.trim()); } });

    // ensure accessible keyboard for overlays: close overlay with Escape
    document.addEventListener('keydown', function(e){
      if(e.key === 'Escape'){
        const root = $('overlayRoot');
        if(root && root.style.display === 'block') { root.innerHTML=''; root.style.display='none'; }
      }
    });
  });

  /* ---------- small helpers exposed to inline onclick in generated HTML ---------- */
  window.openRecipeById = openRecipeById;
  window.addTimer = addTimer;
  window.startTimerById = startTimerById;
  window.pauseTimerById = pauseTimerById;
  window.removeTimerById = removeTimerById;
  window.toggleFav = toggleFav;

  // safe periodic save of timers & update UI
  setInterval(()=>{ tickTimers(); saveTimers(); }, 2000);

  </script>
</body>
</html>



