import React, { useState, useMemo } from 'react';
import { Search, SlidersHorizontal, Star, X, Clock, Salad, Utensils } from 'lucide-react';

/**
 * --- Estructura de Estado de Filtros ---
 * Usamos el estado definido previamente para inicializar los filtros.
 */
const initialFilterState = {
    preparationTime: { min: 5, max: 120 },
    cookingTime: { min: 5, max: 120 },
    totalTime: { min: 10, max: 240 },
    ingredientCount: { min: 3, max: 20 },
    difficulty: [1, 2, 3, 4, 5],
};

const filterLimits = {
    preparationTime: { min: 5, max: 120, unit: 'min' },
    cookingTime: { min: 5, max: 120, unit: 'min' },
    totalTime: { min: 10, max: 240, unit: 'min' },
    ingredientCount: { min: 3, max: 20, unit: 'unidades' },
};

// --- Componente para mostrar las estrellas de dificultad ---
const DifficultyStars = ({ rating }) => {
    return (
        <div className="flex items-center space-x-0.5">
            {[1, 2, 3, 4, 5].map((star) => (
                <Star
                    key={star}
                    className={`w-4 h-4 transition-colors duration-150 ${
                        star <= rating ? 'text-yellow-400 fill-yellow-400' : 'text-gray-300'
                    }`}
                />
            ))}
        </div>
    );
};

// --- Componente de Tarjeta de Receta (Mock para visualización) ---
const RecipeCard = ({ recipe }) => (
    <div className="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 overflow-hidden border border-gray-100">
        <div className="relative h-48 sm:h-56">
            <img 
                src={recipe.image} 
                alt={recipe.title} 
                className="w-full h-full object-cover" 
                onError={(e) => { e.target.onerror = null; e.target.src = "https://placehold.co/600x400/1E3A8A/FFFFFF?text=Receta"; }}
            />
            <div className="absolute top-3 right-3 bg-indigo-600 text-white text-xs font-semibold px-3 py-1 rounded-full shadow-md flex items-center">
                <Clock className="w-3 h-3 mr-1" />
                {recipe.totalTime} min
            </div>
        </div>
        <div className="p-4 sm:p-5">
            <h3 className="text-xl font-bold text-gray-800 mb-1 line-clamp-2">{recipe.title}</h3>
            <div className="flex items-center justify-between mb-3">
                <DifficultyStars rating={recipe.difficulty} />
                <span className="text-sm font-medium text-indigo-600">{recipe.category}</span>
            </div>
            <div className="flex justify-between text-sm text-gray-600 border-t border-gray-100 pt-3">
                <div className="flex items-center">
                    <Utensils className="w-4 h-4 mr-1 text-gray-400" />
                    <span>Prep: {recipe.prepTime} min</span>
                </div>
                <div className="flex items-center">
                    <Salad className="w-4 h-4 mr-1 text-gray-400" />
                    <span>Ingr: {recipe.ingredients}</span>
                </div>
            </div>
        </div>
    </div>
);

// --- Componente de Deslizador de Rango (Range Slider) con un solo pulgar (Versión Estable) ---
const RangeFilter = ({ label, icon: Icon, value, limit, onChange, stateKey }) => {
    
    // Aquí usamos solo el valor máximo (value.max) del rango para el deslizador simple.
    // Aunque el estado original es un objeto {min, max}, el deslizador simple controla 'max'.
    
    const handleMaxChange = (e) => {
        const newMax = parseInt(e.target.value, 10);
        // Mantenemos el 'min' fijo y solo actualizamos el 'max' para el filtro.
        onChange(stateKey, { min: limit.min, max: newMax });
    };

    // Estilo para el input de rango simple (estilizado con clases de Tailwind)
    // Nota: El pulgar se estiliza con el tema del navegador.
    const sliderClasses = "w-full h-2 bg-indigo-100 rounded-lg appearance-none cursor-pointer range-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50";

    return (
        <div className="p-4 bg-gray-50 rounded-lg shadow-inner mb-4">
            
            <div className="flex justify-between items-center mb-4">
                <h4 className="flex items-center text-sm font-semibold text-gray-700">
                    <Icon className="w-4 h-4 mr-2 text-indigo-500" />
                    {label}
                </h4>
                {/* Muestra el rango actual */}
                <span className="text-indigo-600 font-bold text-sm">
                    Máx: {value.max} {limit.unit}
                </span>
            </div>
            
            {/* Input de rango simple */}
            <input
                type="range"
                min={limit.min}
                max={limit.max}
                value={value.max} 
                onChange={handleMaxChange}
                className={sliderClasses}
            />
            
            <div className="flex justify-between text-xs text-gray-500 mt-2">
                <span>{limit.min} {limit.unit}</span>
                <span>{limit.max} {limit.unit}</span>
            </div>
        </div>
    );
};


// --- Mock de Recetas para Visualización ---
const mockRecipes = [
    { id: 1, title: "Lomo Saltado Peruano Auténtico", category: "Carnes", prepTime: 20, cookingTime: 25, totalTime: 45, ingredients: 8, difficulty: 4, image: "https://placehold.co/600x400/EF4444/FFFFFF?text=Lomo+Saltado" },
    { id: 2, title: "Sopa de Tomate y Albahaca Rápida", category: "Sopas", prepTime: 10, cookingTime: 15, totalTime: 25, ingredients: 5, difficulty: 2, image: "https://placehold.co/600x400/10B981/FFFFFF?text=Sopa+Tomate" },
    { id: 3, title: "Curry de Garbanzos y Espinacas Vegano", category: "Vegetariano", prepTime: 15, cookingTime: 30, totalTime: 45, ingredients: 12, difficulty: 3, image: "https://placehold.co/600x400/3B82F6/FFFFFF?text=Curry+Vegano" },
    { id: 4, title: "Tarta de Manzana Clásica Holandesa", category: "Postres", prepTime: 30, cookingTime: 60, totalTime: 90, ingredients: 10, difficulty: 5, image: "https://placehold.co/600x400/F97316/FFFFFF?text=Tarta+Manzana" },
];


// --- Componente de Filtro de Dificultad (Estrellas/Checkboxes) ---
const DifficultyFilter = ({ value, onChange }) => {
    const handleToggleStar = (star) => {
        const newDifficulty = value.includes(star)
            ? value.filter(s => s !== star)
            : [...value, star].sort((a, b) => a - b); 
        
        // Evita que el array quede vacío para no "romper" la búsqueda. Si se deseleccionan todas, se selecciona todo de nuevo.
        onChange('difficulty', newDifficulty.length > 0 ? newDifficulty : [1, 2, 3, 4, 5]);
    };

    const isAllSelected = value.length === 5;
    
    return (
        <div className="p-4 bg-gray-50 rounded-lg shadow-inner">
            <h4 className="flex items-center text-sm font-semibold text-gray-700 mb-3">
                <Star className="w-4 h-4 mr-2 text-indigo-500 fill-indigo-500" />
                Nivel de Dificultad (Estrellas)
            </h4>
            <div className="flex justify-between space-x-2">
                {[1, 2, 3, 4, 5].map((star) => {
                    const isSelected = value.includes(star);
                    return (
                        <button
                            key={star}
                            onClick={() => handleToggleStar(star)}
                            className={`flex flex-col items-center p-2 rounded-lg transition-all duration-200 w-1/5 ${
                                isSelected ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-gray-600 hover:bg-indigo-50 border border-gray-200'
                            }`}
                        >
                            <span className="text-lg font-bold">
                                {star}
                            </span>
                            <span className="text-xs mt-0.5">
                                {star === 1 ? '1 estrella' : `${star} estrellas`}
                            </span>
                        </button>
                    );
                })}
            </div>
            <p className="text-xs text-gray-500 mt-3 italic">
                {isAllSelected 
                    ? 'Mostrando todas las dificultades (1 a 5)' 
                    : `Estrellas seleccionadas: ${value.join(', ')}`}
            </p>
        </div>
    );
};


export default function App() {
    // Estado del texto de búsqueda
    const [searchTerm, setSearchTerm] = useState('');
    // Estado de los 5 filtros
    const [filterState, setFilterState] = useState(initialFilterState);
    // Controlar si el panel de filtros está abierto
    const [isFilterPanelOpen, setIsFilterPanelOpen] = useState(false);

    // Función universal para actualizar cualquier filtro (maneja tanto rangos como arrays)
    const updateFilter = (key, value) => {
        setFilterState(prev => ({
            ...prev,
            [key]: value,
        }));
    };

    // Función para restablecer los filtros a su estado inicial
    const resetFilters = () => {
        setFilterState(initialFilterState);
    };

    // --- Lógica de filtrado simulada (useMemo) ---
    const filteredRecipes = useMemo(() => {
        let results = mockRecipes;

        // 1. Filtrado por texto de búsqueda (Título)
        if (searchTerm) {
            results = results.filter(recipe => 
                recipe.title.toLowerCase().includes(searchTerm.toLowerCase())
            );
        }

        // 2. Filtrado por rangos y dificultad (Aplicaremos la lógica real aquí)
        results = results.filter(recipe => {
            
            // a. Tiempo de Preparación
            // Ahora solo filtramos por el MÁXIMO, ya que el min es fijo
            if (recipe.prepTime > filterState.preparationTime.max) return false;

            // b. Tiempo de Cocción
            if (recipe.cookingTime > filterState.cookingTime.max) return false;

            // c. Tiempo Total
            if (recipe.totalTime > filterState.totalTime.max) return false;

            // d. Conteo de Ingredientes
            if (recipe.ingredients > filterState.ingredientCount.max) return false;

            // e. Dificultad (Estrellas)
            if (!filterState.difficulty.includes(recipe.difficulty)) return false;

            return true;
        });

        return results;
    }, [searchTerm, filterState]);


    return (
        <div className="min-h-screen bg-gray-50 font-sans">
            {/* Header / Barra de Búsqueda Fija */}
            <header className="bg-white sticky top-0 z-10 shadow-lg p-4 sm:p-6 border-b border-indigo-100">
                <div className="max-w-4xl mx-auto flex items-center space-x-3">
                    {/* Campo de Búsqueda de Texto */}
                    <div className="relative flex-grow">
                        <input
                            type="text"
                            placeholder="Buscar por nombre de receta o ingrediente clave..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full py-3 pl-10 pr-4 border border-gray-300 rounded-full focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm text-gray-700"
                        />
                        <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" />
                    </div>

                    {/* Botón para Abrir Filtros */}
                    <button
                        onClick={() => setIsFilterPanelOpen(!isFilterPanelOpen)}
                        className={`p-3 rounded-full transition duration-300 shadow-md flex items-center justify-center ${
                            isFilterPanelOpen ? 'bg-indigo-700 text-white' : 'bg-indigo-600 text-white hover:bg-indigo-700'
                        }`}
                        title="Abrir/Cerrar Filtros Avanzados"
                    >
                        <SlidersHorizontal className="w-6 h-6" />
                    </button>
                </div>
            </header>

            <main className="max-w-4xl mx-auto p-4 sm:p-6 pt-0">
                
                {/* Panel de Filtros Desplegable */}
                {isFilterPanelOpen && (
                    <div className="bg-white p-4 sm:p-6 rounded-2xl shadow-xl mt-4 border border-indigo-200 transition-all duration-300 ease-out">
                        <div className="flex justify-between items-center mb-4 border-b pb-3">
                            <h2 className="text-2xl font-extrabold text-indigo-700 flex items-center">
                                <SlidersHorizontal className="w-6 h-6 mr-2" />
                                Filtros Avanzados
                            </h2>
                            <button
                                onClick={resetFilters}
                                className="text-sm font-medium text-red-500 hover:text-red-700 transition duration-150 flex items-center"
                            >
                                <X className="w-4 h-4 mr-1" />
                                Resetear Filtros
                            </button>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 lg:gap-6">
                            {/* DIFICULTAD (Estrellas) */}
                            <div className="md:col-span-2">
                                <DifficultyFilter 
                                    value={filterState.difficulty} 
                                    onChange={updateFilter} 
                                />
                            </div>

                            {/* TIEMPOS */}
                            <RangeFilter 
                                label="Tiempo Máx. de Preparación" 
                                icon={Utensils} 
                                value={filterState.preparationTime} 
                                limit={filterLimits.preparationTime}
                                onChange={updateFilter}
                                stateKey="preparationTime"
                            />
                            <RangeFilter 
                                label="Tiempo Máx. de Cocción" 
                                icon={Clock} 
                                value={filterState.cookingTime} 
                                limit={filterLimits.cookingTime}
                                onChange={updateFilter}
                                stateKey="cookingTime"
                            />
                            <RangeFilter 
                                label="Tiempo Máx. Total" 
                                icon={Utensils} 
                                value={filterState.totalTime} 
                                limit={filterLimits.totalTime}
                                onChange={updateFilter}
                                stateKey="totalTime"
                            />

                            {/* INGREDIENTES */}
                            <RangeFilter 
                                label="Máx. Conteo de Ingredientes" 
                                icon={Salad} 
                                value={filterState.ingredientCount} 
                                limit={filterLimits.ingredientCount}
                                onChange={updateFilter}
                                stateKey="ingredientCount"
                            />
                            
                        </div>
                    </div>
                )}
                
                {/* Indicador de Resultados */}
                <div className="py-4 mt-6 border-b border-gray-200">
                    <h2 className="text-2xl font-bold text-gray-800">
                        Resultados de la Búsqueda 
                        <span className="ml-2 text-indigo-600">({filteredRecipes.length} recetas)</span>
                    </h2>
                </div>


                {/* Contenedor de Recetas */}
                <div className="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-6 pb-12">
                    {filteredRecipes.length > 0 ? (
                        filteredRecipes.map(recipe => (
                            <RecipeCard key={recipe.id} recipe={recipe} />
                        ))
                    ) : (
                        <div className="col-span-1 sm:col-span-2 text-center py-10 bg-white rounded-xl shadow-md border border-gray-100">
                            <p className="text-lg text-gray-500 font-medium">
                                No se encontraron recetas que coincidan con los filtros aplicados.
                            </p>
                            <button
                                onClick={resetFilters}
                                className="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-full shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                            >
                                <X className="w-4 h-4 mr-1" />
                                Resetear filtros
                            </button>
                        </div>
                    )}
                </div>

            </main>
        </div>
    );
}
