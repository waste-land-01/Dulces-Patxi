<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dulces Patxi</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
  :root{
    --bg:#f5f7fb; --surface:#ffffff; --text:#12202b; --muted:#6b7b88;
    --accent:#0b66d1; --accent-2:#0f9ad6; --success:#22b573;
    --card-shadow: 0 6px 18px rgba(12,32,60,0.08);
  }
  body{margin:0;font-family: "Segoe UI", Roboto, Arial; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;}
  body.modo-oscuro{
    --bg:#0f1316; --surface:#0f1418; --text:#e6eef9; --muted:#9fb8d9;
    --accent:#2f7fd6; --accent-2:#2b9be6; --success:#2fb57e;
    --card-shadow: 0 6px 18px rgba(0,0,0,0.5);
  }

  /* Layout */
  .app {
    max-width: 480px;
    margin: 0 auto;
    min-height:100vh;
    box-sizing:border-box;
    padding:20px;
  }
  header{ text-align:center; margin-bottom:16px; }
  .titulo-app{font-size:2.2rem; font-weight:900; color:var(--accent); margin:6px 0;}
  .bienvenida{white-space:pre-line; font-weight:700; margin:4px 0 6px; font-size:1rem; color:var(--muted);}
  .by-yahya{display:block; font-weight:900; color:var(--accent-2); margin-top:10px;}

  /* Search */
  .search-row{position:relative;margin:16px 0;}
  #buscador{
    width:100%; padding:14px 46px 14px 16px; font-size:1.05rem; border-radius:14px; border:2px solid rgba(16,45,90,0.06);
    background:var(--surface); box-shadow:var(--card-shadow); color:var(--text); outline:none;
  }
  body.modo-oscuro #buscador{border-color:rgba(255,255,255,0.06); background:#12151a;}
  .search-icon{position:absolute; right:14px; top:50%; transform:translateY(-50%); color:var(--muted); font-size:1.05rem;}
  .suggestions{
    position:absolute; left:0; right:0; top:56px; z-index:80;
    background:var(--surface); border-radius:12px; box-shadow:var(--card-shadow); padding:8px; max-height:48vh; overflow:auto;
  }
  .suggestions button{display:block; width:100%; text-align:left; padding:10px; border:none; background:transparent; cursor:pointer; border-radius:8px; font-weight:700; color:var(--text);}
  .suggestions button:hover{background:rgba(11,102,209,0.06);}

  /* Buttons main */
  .grid{
    display:grid; gap:12px; grid-template-columns:1fr; margin:18px 0;
  }
  .main-btn{
    padding:18px; border-radius:14px; border:none; font-weight:900; font-size:1.05rem; cursor:pointer; color:#fff;
    box-shadow:var(--card-shadow);
  }
  #btn-modo{background:linear-gradient(180deg,var(--accent),#0b79e3);}
  #btn-buscador-inteligente{background:linear-gradient(180deg,#0f9ad6,#00a6a6);}
  #btn-menu{background:linear-gradient(180deg,#5b3db7,#6b44d9);}
  #btn-estrella{background:linear-gradient(180deg,#f6b500,#f79500);}
  #btn-notas{background:linear-gradient(180deg,#22b573,#1f9b61);}

  /* View (full-screen pages) */
  .view {
    position:fixed; inset:0; z-index:200; padding:20px; overflow:auto; background:var(--surface); color:var(--text);
    box-sizing:border-box; display:flex; flex-direction:column;
  }
  body.modo-oscuro .view{ background:#0e1317; color:var(--text); }
  .view-header{display:flex; align-items:center; gap:12px; margin-bottom:8px;}
  .view-back{background:transparent; border:2px solid rgba(11,102,209,0.12); color:var(--accent); padding:8px 12px; border-radius:10px; font-weight:900; cursor:pointer;}
  body.modo-oscuro .view-back{border-color:rgba(255,255,255,0.06); color:var(--accent-2);}
  .view-title{flex:1; text-align:center; font-weight:900; font-size:1.25rem;}

  /* Lists / cards */
  .list{display:flex; flex-direction:column; gap:12px; padding:6px 4px;}
  .item-btn{background:var(--surface); border-radius:12px; padding:14px; border:2px solid rgba(12,32,60,0.04); font-weight:900; cursor:pointer; text-align:left;}
  body.modo-oscuro .item-btn{border-color:rgba(255,255,255,0.04);}
  .section-title{font-weight:900; margin:8px 0 6px;}

  /* Recipe */
  .recipe-meta{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:12px;}
  .ingredientes, .elaboracion{background:var(--surface); padding:12px; border-radius:12px; border:1px solid rgba(12,32,60,0.04);}
  .ingredientes ul{margin:6px 0 0 18px;}
  .elaboracion ol{margin:6px 0 0 18px;}

  /* Timer controls in recipe header */
  .recipe-top-actions{display:flex; gap:10px; align-items:center;}
  .timer-select{padding:8px;border-radius:10px;border:1px solid rgba(12,32,60,0.06); background:var(--surface); font-weight:900;}
  .timer-mini-btn{padding:8px 10px;border-radius:10px;border:none;background:var(--accent);color:#fff;font-weight:900;cursor:pointer;}

  /* Bottom floating timers panel */
  .timers-bottom{
    position:fixed; left:8px; right:8px; bottom:12px; display:flex; gap:8px; flex-wrap:wrap; z-index:999;
    justify-content:center;
  }
  .timer-chip{
    background:rgba(11,102,209,0.95); color:#fff; padding:8px 10px; border-radius:12px; display:flex; gap:10px; align-items:center; font-weight:900;
  }
  .timer-chip small{font-weight:700; opacity:0.95;}
  .timer-action{background:transparent;border:1px solid rgba(255,255,255,0.2); color:#fff; padding:6px;border-radius:8px; cursor:pointer;}

  /* Share modal and other modals */
  .modal{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:1000; background:linear-gradient(rgba(2,6,23,0.45),rgba(2,6,23,0.45));
  }
  .modal-card{width:92%; max-width:420px; background:var(--surface); padding:18px; border-radius:12px; box-shadow:var(--card-shadow); color:var(--text);}
  .share-list{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;}
  .share-btn{flex:1; min-width:86px; padding:10px;border-radius:10px;border:none;background:var(--accent);color:#fff;font-weight:900;cursor:pointer;}

  /* Notes list in main notes screen */
  .notes-aggregate{display:flex;flex-direction:column;gap:12px;}
  .note-block{background:var(--surface); padding:12px;border-radius:12px;border:1px solid rgba(12,32,60,0.04);}
  .note-title{font-weight:900; margin-bottom:8px;}

  @media(min-width:700px){
    .app{padding:28px;}
  }
</style>
</head>
<body>
  <div class="app" id="app-root">
    <header>
      <div class="titulo-app">Dulces Patxi</div>
      <div class="bienvenida">Bienvenidos en Dulces de Bachir Krai<br><span class="by-yahya">By Yahya</span></div>
    </header>

    <div class="search-row">
      <input id="buscador" placeholder="Buscar receta . . ." autocomplete="off" />
      <i class="fa fa-search search-icon"></i>
      <div id="suggestions" class="suggestions" style="display:none;"></div>
    </div>

    <div class="grid" id="home-grid">
      <button id="btn-modo" class="main-btn">Modo</button>
      <button id="btn-buscador-inteligente" class="main-btn">Buscador inteligente</button>
      <button id="btn-menu" class="main-btn">Menú</button>
      <button id="btn-estrella" class="main-btn">Recetas estrella</button>
      <button id="btn-notas" class="main-btn">Notas personales</button>
    </div>
  </div>

  <!-- Placeholder: páginas dinámicas se inyectan aquí -->
  <div id="view-root"></div>

  <!-- Bottom timers -->
  <div id="timers-bottom" class="timers-bottom" aria-hidden="true"></div>

  <!-- Modales -->
  <div id="modal-root"></div>

<script>
/* ============================================================
   Dulces Patxi - index.html JS (todo en un solo archivo)
   - Navegación por pila (historyStack)
   - Buscador con sugerencias
   - Buscador inteligente (ingrediente / tiempo / dificultad)
   - Parser automático de tiempos en elaboración (múltiples temporizadores por receta)
   - Temporizadores persistentes en localStorage (soportan start/pause/delete)
   - Notas por receta + vista agregada (orden cronológico)
   - Compartir: menú con WhatsApp / Telegram / Email / SMS y uso de navigator.share si disponible
   - Paleta: modo claro / negro-gris con acento azul
   ============================================================ */





 <script>
    // === DATOS DE LAS RECETAS ===
    const recetas = [
           // === TARTAS DEL AYER ===
      {
        "id": "VARIOS 142",
        "nombre": "Tarta de Manzana",
        "categoria": "Tartas del Ayer",
        "ingredientes": [
          { "nombre": "Pasta sableaux o hojaldre", "cantidad": 1, "unidad": "masa" },
          { "nombre": "Crema pastelera", "cantidad": 250, "unidad": "gr" },
          { "nombre": "Manzanas reinetas", "cantidad": 4, "unidad": "unidades" },
          { "nombre": "Azúcar grano", "cantidad": 50, "unidad": "gr" },
          { "nombre": "Gelatina de manzana", "cantidad": 1, "unidad": "sobre" }
        ],
        "elaboracion": [
          "Rellenar un molde con pasta sableux y cocer en blanco con alubias.",
          "Retirar las alubias y rellenar con crema pastelera.",
          "Colocar manzana pelada y fileteada de forma decorativa.",
          "Espolvorear con azúcar y hornear a 190°C durante 35 minutos.",
          "Una vez fría, abrillantar con gelatina de manzana."
        ],
        "temperatura": 190,
        "tiempo": 35
      },
      {
        "id": "VARIOS 143",
        "nombre": "Tarta San Marcos",
        "categoria": "Tartas del Ayer",
        "ingredientes": [
          { "nombre": "Bizcocho corriente", "cantidad": 1, "unidad": "plancha" },
          { "nombre": "Almíbar para emborrachar", "cantidad": 200, "unidad": "ml" },
          { "nombre": "Nata montada", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Yema pastelera", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Azúcar en grano", "cantidad": 50, "unidad": "gr" },
          { "nombre": "Gelatina de manzana", "cantidad": 1, "unidad": "sobre" }
        ],
        "elaboracion": [
          "Montar la tarta: disco de bizcocho emborrachado.",
          "Capa de yema pastelera.",
          "Disco de bizcocho emborrachado.",
          "Capa de nata montada.",
          "Disco de bizcocho emborrachado.",
          "Extender yema pastelera, rociar con azúcar y quemar con soplete.",
          "Decorar laterales con nata y almendra granillo tostada.",
          "Abrillantar con gelatina de manzana."
        ]
      },
      {
        "id": "VARIOS 144",
        "nombre": "Tarta Tatin",
        "categoria": "Tartas del Ayer",
        "ingredientes": [
          { "nombre": "Azúcar", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 100, "unidad": "ml" },
          { "nombre": "Manzanas reinetas", "cantidad": 1, "unidad": "kg" },
          { "nombre": "Recortes de hojaldre", "cantidad": 1, "unidad": "cantidad suficiente" }
        ],
        "elaboracion": [
          "Baño de caramelo en molde: derretir azúcar con agua.",
          "Pelar, descorazonar y cortar manzanas por la mitad.",
          "Colocarlas en el molde con parte convexa hacia abajo.",
          "Cubrir con lámina de hojaldre, pinchar y hornear a 180°C."
        ],
        "temperatura": 180,
        "tiempo": 40
      },
      {
        "id": "VARIOS 146",
        "nombre": "Tarta de Queso",
        "categoria": "Tartas del Ayer",
        "ingredientes": [
          { "nombre": "Queso tipo Philadelphia", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Huevos", "cantidad": 4, "unidad": "unidades" },
          { "nombre": "Nata líquida", "cantidad": 200, "unidad": "ml" },
          { "nombre": "Galletas trituradas", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Mantequilla", "cantidad": 100, "unidad": "gr" }
        ],
        "elaboracion": [
          "Mezclar galletas con mantequilla derretida y formar base.",
          "Batir queso con azúcar, añadir huevos uno a uno.",
          "Incorporar nata y verter sobre la base.",
          "Hornear a baño María a 160°C durante 50 minutos.",
          "Enfriar y refrigerar toda la noche."
        ],
        "temperatura": 160,
        "tiempo": 50
      },
      {
        "id": "VARIOS 147",
        "nombre": "Tarta de Yema Quemada",
        "categoria": "Tartas del Ayer",
        "ingredientes": [
          { "nombre": "Pasta sableaux", "cantidad": 1, "unidad": "masa" },
          { "nombre": "Yemas de huevo", "cantidad": 20, "unidad": "unidades" },
          { "nombre": "Azúcar", "cantidad": 600, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 250, "unidad": "ml" }
        ],
        "elaboracion": [
          "Preparar almíbar con azúcar y agua hasta punto de hebra fina.",
          "Incorporar yemas poco a poco sin dejar de remover.",
          "Verter sobre la masa sableaux previamente cocida.",
          "Cocer al horno suave hasta dorar ligeramente."
        ],
        "temperatura": 170,
        "tiempo": 25
      },
      {
        "id": "VARIOS 150",
        "nombre": "Tarta Sagarroz",
        "categoria": "Tartas del Ayer",
        "ingredientes": [
          { "nombre": "Bizcocho corriente", "cantidad": 1, "unidad": "plancha" },
          { "nombre": "Almíbar aromatizado con sidra", "cantidad": 200, "unidad": "ml" },
          { "nombre": "Nata montada", "cantidad": 400, "unidad": "gr" },
          { "nombre": "Compota de manzana", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Sidra", "cantidad": 100, "unidad": "ml" },
          { "nombre": "Gelatina de manzana", "cantidad": 1, "unidad": "sobre" }
        ],
        "elaboracion": [
          "Emborrar el bizcocho con almíbar de sidra.",
          "Rellenar con capas alternas de nata y compota.",
          "Cubrir con nata y abrillantar con gelatina."
        ]
      },
      {
        "id": "VARIOS 161",
        "nombre": "Tarta de Almendra",
        "categoria": "Tartas del Ayer",
        "ingredientes": [
          { "nombre": "Pasta quebrada", "cantidad": 1, "unidad": "masa" },
          { "nombre": "Azúcar", "cantidad": 250, "unidad": "gr" },
          { "nombre": "Almendra molida", "cantidad": 250, "unidad": "gr" },
          { "nombre": "Ralladura de limón", "cantidad": 1, "unidad": "unidad" },
          { "nombre": "Huevos", "cantidad": 3, "unidad": "unidades" },
          { "nombre": "Mantequilla", "cantidad": 250, "unidad": "gr" }
        ],
        "elaboracion": [
          "Forrar molde con pasta quebrada.",
          "Mezclar almendra, azúcar, ralladura, huevos y mantequilla.",
          "Verter sobre la base y hornear a 180°C durante 45 minutos."
        ],
        "temperatura": 180,
        "tiempo": 45
      },
      {
        "id": "VARIOS 158",
        "nombre": "Tarta de Frutas",
        "categoria": "Tartas del Ayer",
        "ingredientes": [
          { "nombre": "Dos discos de bizcocho", "cantidad": 2, "unidad": "unidades" },
          { "nombre": "Almíbar de emborrachar", "cantidad": 200, "unidad": "ml" },
          { "nombre": "Nata montada", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Yema de naranja", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Frutas variadas", "cantidad": 500, "unidad": "gr" }
        ],
        "elaboracion": [
          "Colocar un disco de bizcocho en molde de aro.",
          "Emborrarlo mínimamente.",
          "Rellenar abundantemente de nata.",
          "Colocar encima el otro disco de bizcocho y emborracharlo.",
          "Extender yema de naranja, rociar con azúcar y quemar.",
          "Abrillantar con gelatina de manzana.",
          "Colocar frutas decorativamente y abrillantar."
        ]
      },
      // === TARTAS PREMIUM ===
      {
        "id": "VARIOS 148",
        "nombre": "Tronco Navideño",
        "categoria": "Tartas Premium",
        "ingredientes": [
          { "nombre": "Bizcocho plancha", "cantidad": 1, "unidad": "unidad" },
          { "nombre": "Trufa", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Almíbar", "cantidad": 150, "unidad": "ml" },
          { "nombre": "Cobertura", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Mantequilla", "cantidad": 50, "unidad": "gr" },
          { "nombre": "Hojas de chocolate", "cantidad": 1, "unidad": "cantidad" },
          { "nombre": "Azúcar glass", "cantidad": 30, "unidad": "gr" },
          { "nombre": "Canela en polvo", "cantidad": 5, "unidad": "gr" }
        ],
        "elaboracion": [
          "Empapar el bizcocho con almíbar.",
          "Untar con trufa y enrollar con ayuda de papel sulfurizado.",
          "Abrillantar con cobertura mezclada con mantequilla.",
          "Crear textura de corteza con tenedor.",
          "Decorar con hojas de chocolate y canela."
        ]
      },
      {
        "id": "VARIOS 149",
        "nombre": "Tarta Selva Negra",
        "categoria": "Tartas Premium",
        "ingredientes": [
          { "nombre": "Bizcocho de chocolate", "cantidad": 1, "unidad": "plancha" },
          { "nombre": "Cherovia", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Kirsch", "cantidad": 200, "unidad": "ml" },
          { "nombre": "Nata montada", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Cacao en polvo", "cantidad": 50, "unidad": "gr" },
          { "nombre": "Cerezas en almíbar", "cantidad": 1, "unidad": "lata" }
        ],
        "elaboracion": [
          "Cortar el bizcocho en tres discos.",
          "Emborrar cada disco con Kirsch.",
          "Alternar capas de cherovia, nata y cerezas.",
          "Cubrir exterior con nata y espolvorear cacao.",
          "Decorar con cerezas y virutas de chocolate."
        ]
      },
      {
        "id": "VARIOS 151",
        "nombre": "Tarta Martínica",
        "categoria": "Tartas Premium",
        "ingredientes": [
          { "nombre": "Pasta sableaux", "cantidad": 1, "unidad": "masa" },
          { "nombre": "Crema pastelera", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Piña natural", "cantidad": 1, "unidad": "unidad" },
          { "nombre": "Ron", "cantidad": 50, "unidad": "ml" },
          { "nombre": "Nata montada", "cantidad": 200, "unidad": "gr" }
        ],
        "elaboracion": [
          "Forrar molde con pasta sableaux y cocer en blanco.",
          "Rellenar con crema pastelera y piña macerada en ron.",
          "Cubrir con nata y decorar con trozos de piña."
        ]
      },
      {
        "id": "VARIOS 152",
        "nombre": "Tarta de Moka",
        "categoria": "Tartas Premium",
        "ingredientes": [
          { "nombre": "Bizcocho genovés", "cantidad": 1, "unidad": "plancha" },
          { "nombre": "Café expreso", "cantidad": 200, "unidad": "ml" },
          { "nombre": "Mascarpone", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Azúcar glass", "cantidad": 100, "unidad": "gr" },
          { "nombre": "Chocolate negro", "cantidad": 100, "unidad": "gr" }
        ],
        "elaboracion": [
          "Emborrar el bizcocho con café.",
          "Mezclar mascarpone con azúcar y cubrir el bizcocho.",
          "Rallar chocolate y espolvorear por encima."
        ]
      },
      {
        "id": "VARIOS 153",
        "nombre": "Tarta Ópera",
        "categoria": "Tartas Premium",
        "ingredientes": [
          { "nombre": "Bizcocho joconde", "cantidad": 3, "unidad": "discos" },
          { "nombre": "Café concentrado", "cantidad": 150, "unidad": "ml" },
          { "nombre": "Crema de moka", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Cobertura de chocolate", "cantidad": 200, "unidad": "gr" }
        ],
        "elaboracion": [
          "Alternar capas de bizcocho empapado en café y crema de moka.",
          "Cubrir con cobertura de chocolate brillante."
        ]
      },
      {
        "id": "VARIOS 154",
        "nombre": "Tarta Ponche Genovés",
        "categoria": "Tartas Premium",
        "ingredientes": [
          { "nombre": "Bizcocho genovés", "cantidad": 1, "unidad": "plancha" },
          { "nombre": "Almíbar de vino de Málaga", "cantidad": 200, "unidad": "ml" },
          { "nombre": "Crema pastelera", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Nata montada", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Chantilly", "cantidad": 200, "unidad": "gr" }
        ],
        "elaboracion": [
          "Cortar el bizcocho en dos capas.",
          "Emborrar con almíbar de vino de Málaga.",
          "Rellenar con crema pastelera y nata.",
          "Cubrir con chantilly y decorar con guindas."
        ]
      },
      {
        "id": "VARIOS 155",
        "nombre": "Tarta Mascota",
        "categoria": "Tartas Premium",
        "ingredientes": [
          { "nombre": "Bizcocho molde", "cantidad": 1, "unidad": "unidad" },
          { "nombre": "Almíbar de emborrachar", "cantidad": 200, "unidad": "ml" },
          { "nombre": "Crema de mantequilla", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Almendra fileteada", "cantidad": 100, "unidad": "gr" }
        ],
        "elaboracion": [
          "Partimos de un bizcocho relleno de crema de mantequilla.",
          "Cubrimos la superficie y los laterales con crema de mantequilla.",
          "Aplanamos con espátula.",
          "Decoramos con almendra fileteada."
        ]
      },
      {
        "id": "VARIOS 156",
        "nombre": "Terrina de Frutas",
        "categoria": "Tartas Premium",
        "ingredientes": [
          { "nombre": "Plancha de bizcocho", "cantidad": 1, "unidad": "unidad" },
          { "nombre": "Mantequilla", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Azúcar lustre", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Almendra molida", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Nata líquida", "cantidad": 300, "unidad": "ml" },
          { "nombre": "Kiwi", "cantidad": 3, "unidad": "unidades" },
          { "nombre": "Fresas", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Melocotón en almíbar", "cantidad": 200, "unidad": "gr" }
        ],
        "elaboracion": [
          "Forrar molde con film transparente.",
          "Colocar capa de bizcocho.",
          "Rellenar con mezcla de mantequilla, azúcar, almendra y nata.",
          "Añadir frutas cortadas.",
          "Congelar y desmoldar."
        ]
      },
      {
        "id": "VARIOS 157",
        "nombre": "Tarta de Enrejado",
        "categoria": "Tartas Premium",
        "ingredientes": [
          { "nombre": "Recortes de hojaldre", "cantidad": 1, "unidad": "masa" },
          { "nombre": "Crema pastelera", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Frambuesas", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Gelatina de manzana", "cantidad": 1, "unidad": "sobre" }
        ],
        "elaboracion": [
          "Forrar molde con hojaldre.",
          "Rellenar con crema pastelera.",
          "Colocar frambuesas.",
          "Hacer rejilla con tiras de hojaldre.",
          "Hornear a 180°C.",
          "Abrillantar con gelatina."
        ],
        "temperatura": 180,
        "tiempo": 35
      },
      {
        "id": "VARIOS 159",
        "nombre": "Tarta de Chocolatina",
        "categoria": "Tartas Premium",
        "ingredientes": [
          { "nombre": "Bizcocho genovés", "cantidad": 1, "unidad": "plancha" },
          { "nombre": "Almíbar de café", "cantidad": 200, "unidad": "ml" },
          { "nombre": "Trufa negra", "cantidad": 400, "unidad": "gr" },
          { "nombre": "Virutas de chocolate", "cantidad": 100, "unidad": "gr" }
        ],
        "elaboracion": [
          "Cortar bizcocho en dos capas.",
          "Emborrar con almíbar de café.",
          "Rellenar con trufa negra.",
          "Cubrir con trufa y decorar con virutas."
        ]
      },
      // === BIZCOCHOS, MAGDALENAS & MUFFINS ===
      {
        "id": "VARIOS 67",
        "nombre": "Sobao Pasiego",
        "categoria": "Bizcochos, Magdalenas & Muffins",
        "ingredientes": [
          { "nombre": "Mantequilla", "cantidad": 1000, "unidad": "gr" },
          { "nombre": "Azúcar glasé", "cantidad": 1000, "unidad": "gr" },
          { "nombre": "Huevos", "cantidad": 15, "unidad": "unidades" },
          { "nombre": "Ron", "cantidad": 50, "unidad": "ml" },
          { "nombre": "Harina floja", "cantidad": 1000, "unidad": "gr" },
          { "nombre": "Impulsor", "cantidad": 10, "unidad": "gr" }
        ],
        "elaboracion": [
          "Batir mantequilla con azúcar, añadir huevos uno a uno.",
          "Incorporar harina con impulsor, ron y mezclar delicadamente.",
          "Hornear a 180°C."
        ],
        "temperatura": 180,
        "tiempo": 30
      },
      {
        "id": "VARIOS 202",
        "nombre": "San Blas",
        "categoria": "Bizcochos, Magdalenas & Muffins",
        "ingredientes": [
          { "nombre": "Harina", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 250, "unidad": "gr" },
          { "nombre": "Huevos", "cantidad": 5, "unidad": "unidades" },
          { "nombre": "Mantequilla", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Leche", "cantidad": 100, "unidad": "ml" },
          { "nombre": "Impulsor", "cantidad": 10, "unidad": "gr" }
        ],
        "elaboracion": [
          "Batir mantequilla con azúcar, añadir huevos uno a uno.",
          "Incorporar harina con impulsor y leche.",
          "Hornear a 180°C durante 25 minutos."
        ],
        "temperatura": 180,
        "tiempo": 25
      },
      {
        "id": "VARIOS 58",
        "nombre": "Bizcocho de Chocolate",
        "categoria": "Bizcochos, Magdalenas & Muffins",
        "ingredientes": [
          { "nombre": "Huevos", "cantidad": 4, "unidad": "unidades" },
          { "nombre": "Azúcar", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Harina", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Cacao en polvo", "cantidad": 50, "unidad": "gr" },
          { "nombre": "Mantequilla", "cantidad": 100, "unidad": "gr" },
          { "nombre": "Leche", "cantidad": 100, "unidad": "ml" },
          { "nombre": "Impulsor", "cantidad": 10, "unidad": "gr" }
        ],
        "elaboracion": [
          "Batir huevos con azúcar hasta doblar volumen.",
          "Añadir harina, cacao, mantequilla derretida, leche e impulsor.",
          "Hornear a 180°C durante 30 minutos."
        ],
        "temperatura": 180,
        "tiempo": 30
      },
      {
        "id": "VARIOS 59",
        "nombre": "Bizcocho de Naranja",
        "categoria": "Bizcochos, Magdalenas & Muffins",
        "ingredientes": [
          { "nombre": "Huevos", "cantidad": 4, "unidad": "unidades" },
          { "nombre": "Azúcar", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Harina", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Zumo de naranja", "cantidad": 100, "unidad": "ml" },
          { "nombre": "Ralladura de naranja", "cantidad": 1, "unidad": "unidad" },
          { "nombre": "Mantequilla", "cantidad": 100, "unidad": "gr" },
          { "nombre": "Impulsor", "cantidad": 10, "unidad": "gr" }
        ],
        "elaboracion": [
          "Batir huevos con azúcar hasta doblar volumen.",
          "Añadir harina, zumo, ralladura, mantequilla derretida e impulsor.",
          "Hornear a 180°C durante 30 minutos."
        ],
        "temperatura": 180,
        "tiempo": 30
      },
      {
        "id": "VARIOS 68",
        "nombre": "Magdalenas",
        "categoria": "Bizcochos, Magdalenas & Muffins",
        "ingredientes": [
          { "nombre": "Huevos", "cantidad": 10, "unidad": "unidades" },
          { "nombre": "Azúcar", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Harina", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Mantequilla", "cantidad": 250, "unidad": "gr" },
          { "nombre": "Leche", "cantidad": 100, "unidad": "ml" },
          { "nombre": "Impulsor", "cantidad": 10, "unidad": "gr" }
        ],
        "elaboracion": [
          "Batir huevos con azúcar hasta doblar volumen.",
          "Incorporar harina, mantequilla derretida, leche e impulsor.",
          "Escudillar en moldes y hornear a 180°C durante 20 minutos."
        ],
        "temperatura": 180,
        "tiempo": 20
      },
      {
        "id": "VARIOS 61",
        "nombre": "Bizcocho de Manzana",
        "categoria": "Bizcochos, Magdalenas & Muffins",
        "ingredientes": [
          { "nombre": "Huevos", "cantidad": 4, "unidad": "unidades" },
          { "nombre": "Azúcar", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Harina", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Manzanas", "cantidad": 2, "unidad": "unidades" },
          { "nombre": "Mantequilla", "cantidad": 100, "unidad": "gr" },
          { "nombre": "Impulsor", "cantidad": 10, "unidad": "gr" }
        ],
        "elaboracion": [
          "Batir huevos con azúcar hasta doblar volumen.",
          "Añadir harina, manzana rallada, mantequilla derretida e impulsor.",
          "Hornear a 180°C durante 30 minutos."
        ],
        "temperatura": 180,
        "tiempo": 30
      },
      {
        "id": "VARIOS 60",
        "nombre": "Bizcocho de Coco",
        "categoria": "Bizcochos, Magdalenas & Muffins",
        "ingredientes": [
          { "nombre": "Huevos", "cantidad": 4, "unidad": "unidades" },
          { "nombre": "Azúcar", "cantidad": 400, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 200, "unidad": "cc" },
          { "nombre": "Harina", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Levadura royal", "cantidad": 1, "unidad": "sobre" },
          { "nombre": "Coco rallado", "cantidad": 50, "unidad": "gr" }
        ],
        "elaboracion": [
          "Batir huevos con azúcar, agregar agua hirviendo, harina, levadura y coco.",
          "Verter en molde engrasado y enharinado.",
          "Hornear a fuego lento los primeros 10 minutos, luego aumentar temperatura."
        ],
        "tiempo": 50
      },
      {
        "id": "VARIOS 195",
        "nombre": "Coquitos",
        "categoria": "Bizcochos, Magdalenas & Muffins",
        "ingredientes": [
          { "nombre": "Huevos", "cantidad": 3, "unidad": "unidades" },
          { "nombre": "Azúcar", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Coco rallado", "cantidad": 250, "unidad": "gr" }
        ],
        "elaboracion": [
          "Mezclar ingredientes y dejar reposar en frigorífico.",
          "Formar bolas pequeñas y hornear a horno fuerte 20 minutos."
        ],
        "temperatura": 190,
        "tiempo": 20
      },
      {
        "id": "VARIOS 196",
        "nombre": "Macarrón de Almendra",
        "categoria": "Bizcochos, Magdalenas & Muffins",
        "ingredientes": [
          { "nombre": "Almendra molida", "cantidad": 480, "unidad": "gr" },
          { "nombre": "Azúcar grano", "cantidad": 400, "unidad": "gr" },
          { "nombre": "Claritas", "cantidad": 180, "unidad": "gr" }
        ],
        "elaboracion": [
          "Mezclar todos los ingredientes hasta formar una masa homogénea.",
          "Escudillar con manga sobre placa.",
          "Secar a 40-50°C durante varias horas.",
          "Cocer a 140°C cuando estén secos."
        ],
        "temperatura": 140,
        "tiempo": 15
      },
      {
        "id": "VARIOS 199",
        "nombre": "Empiñonadas",
        "categoria": "Bizcochos, Magdalenas & Muffins",
        "ingredientes": [
          { "nombre": "Almendra molida", "cantidad": 250, "unidad": "gr" },
          { "nombre": "Azúcar lustre", "cantidad": 225, "unidad": "gr" },
          { "nombre": "Claras de huevo", "cantidad": 1, "unidad": "cantidad" },
          { "nombre": "Piñones", "cantidad": 100, "unidad": "gr" }
        ],
        "elaboracion": [
          "Mezclar almendra, azúcar y claras.",
          "Formar bolas, rebozar con piñones.",
          "Cocer a horno a 180-200°C."
        ],
        "temperatura": 190,
        "tiempo": 18
      },
      // === DULCES & CONFITES ===
      {
        "id": "VARIOS 173",
        "nombre": "Trufa Negra",
        "categoria": "Dulces & Confites",
        "ingredientes": [
          { "nombre": "Nata", "cantidad": 350, "unidad": "gr" },
          { "nombre": "Cobertura negra", "cantidad": 650, "unidad": "gr" },
          { "nombre": "Cognac", "cantidad": 2, "unidad": "cda" }
        ],
        "elaboracion": [
          "Calentar la nata y verter sobre la cobertura.",
          "Disolver con espátula, añadir cognac.",
          "Dejar enfriar, hacer bolas y bañar en cobertura o cacao."
        ]
      },
      {
        "id": "VARIOS 48",
        "nombre": "Trufa Cocida",
        "categoria": "Dulces & Confites",
        "ingredientes": [
          { "nombre": "Nata líquida", "cantidad": 1000, "unidad": "ml" },
          { "nombre": "Cobertura negra", "cantidad": 140, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 150, "unidad": "gr" }
        ],
        "elaboracion": [
          "Mezclar todos los ingredientes y llevar al fuego hasta disolver la cobertura.",
          "Enfriar en cámara toda la noche.",
          "Al día siguiente, montar con varilla hasta obtener textura cremosa.",
          "Formar bolas y rodar en cacao en polvo."
        ]
      },
      {
        "id": "VARIOS 49",
        "nombre": "Trufa Cocida Blanca",
        "categoria": "Dulces & Confites",
        "ingredientes": [
          { "nombre": "Nata líquida", "cantidad": 1000, "unidad": "ml" },
          { "nombre": "Cobertura blanca", "cantidad": 400, "unidad": "gr" }
        ],
        "elaboracion": [
          "Cocer de víspera la nata con la cobertura.",
          "Enfriar en cámara y al día siguiente proceder a montarla."
        ]
      },
      {
        "id": "VARIOS 50",
        "nombre": "Toffe",
        "categoria": "Dulces & Confites",
        "ingredientes": [
          { "nombre": "Nata líquida", "cantidad": 1000, "unidad": "ml" },
          { "nombre": "Azúcar", "cantidad": 250, "unidad": "gr" }
        ],
        "elaboracion": [
          "Hacer caramelo rubio con azúcar.",
          "Añadir nata caliente con cuidado.",
          "Hervir hasta disolución completa.",
          "Usar como salsa o montar al día siguiente."
        ]
      },
      {
        "id": "VARIOS 178",
        "nombre": "Mazapán",
        "categoria": "Dulces & Confites",
        "ingredientes": [
          { "nombre": "Almendra molida", "cantidad": 1000, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 1000, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 200, "unidad": "ml" },
          { "nombre": "Glucosa", "cantidad": 100, "unidad": "gr" }
        ],
        "elaboracion": [
          "Mezclar todos los ingredientes hasta formar una masa homogénea.",
          "Amasar y moldear como se desee.",
          "Secar al aire o en horno muy bajo."
        ]
      },
      {
        "id": "VARIOS 180",
        "nombre": "Turrón de Yema",
        "categoria": "Dulces & Confites",
        "ingredientes": [
          { "nombre": "Nata", "cantidad": 125, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 125, "unidad": "gr" },
          { "nombre": "Yemas", "cantidad": 9, "unidad": "unidades" },
          { "nombre": "Almíbar", "cantidad": 1, "unidad": "kilo" },
          { "nombre": "Almendra molida", "cantidad": 1, "unidad": "kilo" },
          { "nombre": "Glucosa", "cantidad": 50, "unidad": "gr" },
          { "nombre": "Vainillina", "cantidad": 1, "unidad": "cda" }
        ],
        "elaboracion": [
          "Elaborar almíbar a punto de bola floja.",
          "Mezclar con yemas, nata, almendra y glucosa.",
          "Moldear y enfriar."
        ]
      },
      {
        "id": "VARIOS 182",
        "nombre": "Turrón de Coco",
        "categoria": "Dulces & Confites",
        "ingredientes": [
          { "nombre": "Almíbar", "cantidad": 1, "unidad": "kilo" },
          { "nombre": "Agua", "cantidad": 350, "unidad": "gr" },
          { "nombre": "Coco rallado", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Almendra molida", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Glucosa", "cantidad": 125, "unidad": "gr" }
        ],
        "elaboracion": [
          "Hacer almíbar con azúcar, agua y glucosa.",
          "Añadir coco y almendra.",
          "Verter en molde, enfriar y cortar."
        ]
      },
      {
        "id": "VARIOS 183",
        "nombre": "Turrón de Pistachos",
        "categoria": "Dulces & Confites",
        "ingredientes": [
          { "nombre": "Almíbar", "cantidad": 1, "unidad": "kilo" },
          { "nombre": "Agua", "cantidad": 330, "unidad": "gr" },
          { "nombre": "Pistachos molidos", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Almendra molida", "cantidad": 500, "unidad": "gr" }
        ],
        "elaboracion": [
          "Hacer almíbar a punto de hebra floja.",
          "Mezclar con pistachos y almendra.",
          "Moldear, prensar y reposar."
        ]
      },
      {
        "id": "VARIOS 184",
        "nombre": "Guirlache",
        "categoria": "Dulces & Confites",
        "ingredientes": [
          { "nombre": "Azúcar", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Manteca de cerdo", "cantidad": 10, "unidad": "gr" },
          { "nombre": "Canela", "cantidad": 5, "unidad": "gr" },
          { "nombre": "Zumo de limón", "cantidad": 1, "unidad": "chorro" },
          { "nombre": "Almendras marcona", "cantidad": 450, "unidad": "gr" }
        ],
        "elaboracion": [
          "Hacer caramelo rubio con azúcar, manteca, canela y limón.",
          "Añadir almendras tostadas.",
          "Extender sobre mármol engrasado.",
          "Cortar en barritas antes de enfriar."
        ]
      },
      {
        "id": "VARIOS 181",
        "nombre": "Turrón de Nata Nuez",
        "categoria": "Dulces & Confites",
        "ingredientes": [
          { "nombre": "Nata", "cantidad": 400, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 1125, "unidad": "gr" },
          { "nombre": "Almendra molida", "cantidad": 1000, "unidad": "gr" },
          { "nombre": "Nueces", "cantidad": 750, "unidad": "gr" },
          { "nombre": "Vainillina", "cantidad": 1, "unidad": "cda" }
        ],
        "elaboracion": [
          "Hervir nata con azúcar, añadir almendra, nueces y vainillina.",
          "Moldear, prensar y dejar reposar mínimo un día."
        ]
      },
      // === MASAS & PASTELES ===
      {
        "id": "VARIOS 75",
        "nombre": "Hojaldre (Fórmula Tradicional)",
        "categoria": "Masas & Pasteles",
        "ingredientes": [
          { "nombre": "Harina fuerte", "cantidad": 1000, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 600, "unidad": "gr" },
          { "nombre": "Sal", "cantidad": 20, "unidad": "gr" },
          { "nombre": "Manteca de cerdo o mantequilla", "cantidad": 600, "unidad": "gr" }
        ],
        "elaboracion": [
          "Mezclar harina, agua y sal. Formar un plastón.",
          "Enfriar 30 minutos.",
          "Estirar y colocar la grasa en el centro. Doblar como libro.",
          "Repetir 3-4 vueltas simples, refrigerando entre cada una."
        ]
      },
      {
        "id": "VARIOS 83",
        "nombre": "Palmeras",
        "categoria": "Masas & Pasteles",
        "ingredientes": [
          { "nombre": "Plastón de hojaldre", "cantidad": 1, "unidad": "masa" },
          { "nombre": "Azúcar en grano", "cantidad": 200, "unidad": "gr" }
        ],
        "elaboracion": [
          "Hacer una masa de hojaldre a la que se dan 6 pliegues sencillos.",
          "En el último pliegue espolvorear con azúcar en grano y estirar.",
          "Se monta la masa tres veces por cada lado, juntar y cortar en palmeras.",
          "Hornear a 200-210°C hasta dorar."
        ],
        "temperatura": 205,
        "tiempo": 22
      },
      {
        "id": "VARIOS 187",
        "nombre": "Cigarrillos Rusos",
        "categoria": "Masas & Pasteles",
        "ingredientes": [
          { "nombre": "Hojaldre", "cantidad": 1, "unidad": "masa" },
          { "nombre": "Azúcar glass", "cantidad": 100, "unidad": "gr" },
          { "nombre": "Clara de huevo", "cantidad": 1, "unidad": "unidad" }
        ],
        "elaboracion": [
          "Estirar el hojaldre muy fino y pintar con clara de huevo.",
          "Espolvorear con azúcar glass.",
          "Enrollar como si fuera un brazo de gitano y cortar en rodajas finas.",
          "Hornear a 200°C hasta dorar."
        ],
        "temperatura": 200,
        "tiempo": 15
      },
      {
        "id": "VARIOS 190",
        "nombre": "Lenguas de Gato",
        "categoria": "Masas & Pasteles",
        "ingredientes": [
          { "nombre": "Mantequilla", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Azúcar glass", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Harina", "cantidad": 200, "unidad": "gr" }
        ],
        "elaboracion": [
          "Batir mantequilla con azúcar glass.",
          "Incorporar harina con espátula.",
          "Escudillar en boquilla rizada.",
          "Hornear a 180°C sin abrir el horno."
        ],
        "temperatura": 180,
        "tiempo": 12
      },
      // === POSTRES FRÍOS ===
      {
        "id": "VARIOS 13",
        "nombre": "Flan de Chocolate",
        "categoria": "Postres Fríos",
        "ingredientes": [
          { "nombre": "Leche", "cantidad": 250, "unidad": "ml" },
          { "nombre": "Nata líquida", "cantidad": 250, "unidad": "ml" },
          { "nombre": "Azúcar", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Cobertura negra", "cantidad": 100, "unidad": "gr" },
          { "nombre": "Huevos", "cantidad": 6, "unidad": "unidades" },
          { "nombre": "Salsa de caramelo", "cantidad": 1, "unidad": "cantidad" }
        ],
        "elaboracion": [
          "Mezclar leche, nata, azúcar y cobertura fundida.",
          "Añadir huevos batidos.",
          "Verter en moldes con caramelo.",
          "Cocer al baño María a 160°C durante 45 minutos.",
          "Enfriar y desmoldar."
        ],
        "temperatura": 160,
        "tiempo": 45
      },
      {
        "id": "VARIOS 25",
        "nombre": "Compota de Manzana",
        "categoria": "Postres Fríos",
        "ingredientes": [
          { "nombre": "Manzanas", "cantidad": 1000, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Vino blanco", "cantidad": 250, "unidad": "ml" },
          { "nombre": "Orejones", "cantidad": 50, "unidad": "gr" },
          { "nombre": "Pasas", "cantidad": 30, "unidad": "gr" }
        ],
        "elaboracion": [
          "Pelar y cortar manzanas.",
          "Cocer con azúcar, vino y frutas secas.",
          "Dejar enfriar antes de servir."
        ]
      },
      {
        "id": "VARIOS 26",
        "nombre": "Peras en Almíbar",
        "categoria": "Postres Fríos",
        "ingredientes": [
          { "nombre": "Peras", "cantidad": 1000, "unidad": "gr" },
          { "nombre": "Vino blanco", "cantidad": 500, "unidad": "ml" },
          { "nombre": "Azúcar", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 500, "unidad": "ml" },
          { "nombre": "Canela en rama", "cantidad": 1, "unidad": "unidad" },
          { "nombre": "Cáscara de limón", "cantidad": 1, "unidad": "unidad" }
        ],
        "elaboracion": [
          "Pelar peras y mantener en agua con limón.",
          "Hervir agua, vino, azúcar, canela y limón.",
          "Añadir peras y cocer a fuego lento 20-30 min.",
          "Dejar enfriar en el almíbar."
        ],
        "tiempo": 25
      },
      {
        "id": "VARIOS 27",
        "nombre": "Arroz con Leche",
        "categoria": "Postres Fríos",
        "ingredientes": [
          { "nombre": "Arroz", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Leche", "cantidad": 1000, "unidad": "ml" },
          { "nombre": "Azúcar", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Canela en rama", "cantidad": 1, "unidad": "unidad" },
          { "nombre": "Cáscara de limón", "cantidad": 1, "unidad": "unidad" },
          { "nombre": "Vainilla", "cantidad": 1, "unidad": "unidad" }
        ],
        "elaboracion": [
          "Cocer el arroz en leche con azúcar, canela, limón y vainilla.",
          "Dejar enfriar y servir frío con canela por encima."
        ]
      },
      {
        "id": "VARIOS 28",
        "nombre": "Leche Frita",
        "categoria": "Postres Fríos",
        "ingredientes": [
          { "nombre": "Leche", "cantidad": 1000, "unidad": "ml" },
          { "nombre": "Harina", "cantidad": 100, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Canela", "cantidad": 10, "unidad": "gr" },
          { "nombre": "Aceite para freír", "cantidad": 500, "unidad": "ml" }
        ],
        "elaboracion": [
          "Cocer leche con azúcar, canela y harina hasta espesar.",
          "Enfriar, cortar en dados y freír.",
          "Espolvorear con azúcar y canela."
        ]
      },
      {
        "id": "VARIOS 29",
        "nombre": "Torrijas",
        "categoria": "Postres Fríos",
        "ingredientes": [
          { "nombre": "Pan de brioche", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Leche", "cantidad": 500, "unidad": "ml" },
          { "nombre": "Huevos", "cantidad": 3, "unidad": "unidades" },
          { "nombre": "Azúcar", "cantidad": 100, "unidad": "gr" },
          { "nombre": "Canela", "cantidad": 10, "unidad": "gr" },
          { "nombre": "Aceite", "cantidad": 300, "unidad": "ml" }
        ],
        "elaboracion": [
          "Remojar pan en leche con canela y azúcar.",
          "Pasar por huevo y freír.",
          "Espolvorear con azúcar y canela."
        ]
      },
      {
        "id": "VARIOS 30",
        "nombre": "Goxua",
        "categoria": "Postres Fríos",
        "ingredientes": [
          { "nombre": "Bizcocho corriente", "cantidad": 1, "unidad": "plancha" },
          { "nombre": "Crema pastelera", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Nata montada", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Caramelo", "cantidad": 100, "unidad": "gr" }
        ],
        "elaboracion": [
          "Cortar el bizcocho en cuadrados.",
          "Rellenar con crema y nata.",
          "Baño de caramelo por encima."
        ]
      },
      {
        "id": "VARIOS 31",
        "nombre": "Pastel Vasco",
        "categoria": "Postres Fríos",
        "ingredientes": [
          { "nombre": "Harina", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Mantequilla", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Huevos", "cantidad": 4, "unidad": "unidades" },
          { "nombre": "Crema pastelera", "cantidad": 400, "unidad": "gr" }
        ],
        "elaboracion": [
          "Mezclar harina, azúcar, mantequilla y huevos hasta formar masa.",
          "Forrar molde y rellenar con crema pastelera.",
          "Hornear a 180°C durante 40 minutos."
        ],
        "temperatura": 180,
        "tiempo": 40
      },
      // === HELADOS & SORBETES ===
      {
        "id": "VARIOS 100",
        "nombre": "Sorbete de Limón al Champán",
        "categoria": "Helados & Sorbetes",
        "ingredientes": [
          { "nombre": "Almíbar a 28°Brix", "cantidad": 1, "unidad": "litro" },
          { "nombre": "Zumo de limón", "cantidad": 1, "unidad": "litro" }
        ],
        "elaboracion": [
          "Mezclar ambos ingredientes y enfriar bien.",
          "Introducir en heladora y dejar congelar."
        ]
      },
      {
        "id": "VARIOS 105",
        "nombre": "Sorbete de Limón",
        "categoria": "Helados & Sorbetes",
        "ingredientes": [
          { "nombre": "Zumo de limón", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Glucosa", "cantidad": 100, "unidad": "gr" },
          { "nombre": "Maicena", "cantidad": 20, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 480, "unidad": "gr" }
        ],
        "elaboracion": [
          "Mezclar sacarosa con maicena, añadir agua y cocer.",
          "Enfriar, añadir zumo y helar."
        ]
      },
      {
        "id": "VARIOS 118",
        "nombre": "Mousse de Cava",
        "categoria": "Helados & Sorbetes",
        "ingredientes": [
          { "nombre": "Cava", "cantidad": 750, "unidad": "ml" },
          { "nombre": "Azúcar", "cantidad": 360, "unidad": "gr" },
          { "nombre": "Gelatina", "cantidad": 24, "unidad": "gr" },
          { "nombre": "Yemas", "cantidad": 3, "unidad": "unidades" },
          { "nombre": "Nata líquida", "cantidad": 400, "unidad": "ml" }
        ],
        "elaboracion": [
          "Calentar cava con azúcar y gelatina.",
          "Añadir yemas, enfriar y mezclar con nata montada.",
          "Congelar."
        ]
      },
      {
        "id": "VARIOS 97",
        "nombre": "Sorbete de Naranja",
        "categoria": "Helados & Sorbetes",
        "ingredientes": [
          { "nombre": "Agua", "cantidad": 250, "unidad": "ml" },
          { "nombre": "Azúcar", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Ralladura de naranja", "cantidad": 1, "unidad": "cantidad" },
          { "nombre": "Zumo de naranja", "cantidad": 500, "unidad": "ml" },
          { "nombre": "Clara de huevo", "cantidad": 1, "unidad": "unidad" }
        ],
        "elaboracion": [
          "Hacer almíbar con agua y azúcar.",
          "Añadir ralladura, zumo y clara batida.",
          "Congelar en heladora."
        ]
      },
      {
        "id": "VARIOS 106",
        "nombre": "Bavarois de Chocolate",
        "categoria": "Helados & Sorbetes",
        "ingredientes": [
          { "nombre": "Chocolate negro", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Leche", "cantidad": 500, "unidad": "ml" },
          { "nombre": "Azúcar", "cantidad": 100, "unidad": "gr" },
          { "nombre": "Huevos", "cantidad": 4, "unidad": "unidades" },
          { "nombre": "Gelatina", "cantidad": 10, "unidad": "gr" }
        ],
        "elaboracion": [
          "Derretir chocolate con leche y azúcar.",
          "Añadir yemas, gelatina reblandecida.",
          "Montar claras y nata, incorporar.",
          "Enmoldar y refrigerar."
        ]
      },
      // === RELLENOS & COBERTURAS ===
      {
        "id": "VARIOS 221",
        "nombre": "Coulis de Frutos Rojos",
        "categoria": "Rellenos & Coberturas",
        "ingredientes": [
          { "nombre": "Fruta roja", "cantidad": 1000, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 400, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 250, "unidad": "ml" }
        ],
        "elaboracion": [
          "Hervir todos los ingredientes hasta densidad media.",
          "Triturar y colar por chino fino."
        ]
      },
      {
        "id": "VARIOS 215",
        "nombre": "Glassa Antihumedad",
        "categoria": "Decoración & Acabados",
        "ingredientes": [
          { "nombre": "Azúcar glass", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Clara de huevo deshidratada", "cantidad": 20, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 100, "unidad": "ml" }
        ],
        "elaboracion": [
          "Mezclar todos los ingredientes hasta homogeneidad.",
          "Dejar reposar 12 horas tapado.",
          "Ideal para decorar tartas sin que se humedezcan."
        ]
      },
      {
        "id": "VARIOS 223",
        "nombre": "Coulis de Manzana",
        "categoria": "Rellenos & Coberturas",
        "ingredientes": [
          { "nombre": "Manzanas", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 375, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 75, "unidad": "gr" },
          { "nombre": "Zumo de limón", "cantidad": 1, "unidad": "unidad" },
          { "nombre": "Vainilla", "cantidad": 0.25, "unidad": "vaina" }
        ],
        "elaboracion": [
          "Cocer manzanas con resto de ingredientes.",
          "Triturar, colar y ajustar espesor."
        ]
      },
      {
        "id": "VARIOS 224",
        "nombre": "Coulis de Kiwi",
        "categoria": "Rellenos & Coberturas",
        "ingredientes": [
          { "nombre": "Kiwi", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 100, "unidad": "ml" }
        ],
        "elaboracion": [
          "Pelar y triturar kiwi.",
          "Añadir azúcar y agua.",
          "Cocer ligeramente y colar."
        ]
      },
      {
        "id": "VARIOS 216",
        "nombre": "Baño de Cobertura",
        "categoria": "Decoración & Acabados",
        "ingredientes": [
          { "nombre": "Cobertura negra", "cantidad": 1000, "unidad": "gr" },
          { "nombre": "Mantequilla", "cantidad": 1000, "unidad": "gr" },
          { "nombre": "Glucosa", "cantidad": 2, "unidad": "cda" }
        ],
        "elaboracion": [
          "Derretir cobertura con mantequilla y glucosa.",
          "Usar como baño para tartas y bombones."
        ]
      },
      // === DECORACIÓN & ACABADOS ===
      {
        "id": "VARIOS 225",
        "nombre": "Merengue Italiano",
        "categoria": "Decoración & Acabados",
        "ingredientes": [
          { "nombre": "Claras de huevo", "cantidad": 100, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 50, "unidad": "ml" },
          { "nombre": "Azúcar invertido", "cantidad": 10, "unidad": "gr" }
        ],
        "elaboracion": [
          "Calentar azúcar, agua y azúcar invertido hasta 118°C.",
          "Verter sobre claras batidas a punto de nieve.",
          "Seguir batiendo hasta enfriar."
        ]
      },
      {
        "id": "VARIOS 226",
        "nombre": "Salsa de Fresa",
        "categoria": "Decoración & Acabados",
        "ingredientes": [
          { "nombre": "Fresas", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Agua", "cantidad": 100, "unidad": "ml" },
          { "nombre": "Glucosa", "cantidad": 50, "unidad": "gr" },
          { "nombre": "Limón", "cantidad": 1, "unidad": "unidad" }
        ],
        "elaboracion": [
          "Cocer fresas con azúcar, agua, glucosa y limón.",
          "Triturar y colar."
        ]
      },
      {
        "id": "VARIOS 227",
        "nombre": "Salsa de Módena",
        "categoria": "Decoración & Acabados",
        "ingredientes": [
          { "nombre": "Vinagre de módena", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 400, "unidad": "gr" },
          { "nombre": "Zumo de limón", "cantidad": 1, "unidad": "chorro" },
          { "nombre": "Agua", "cantidad": 1, "unidad": "chorro" }
        ],
        "elaboracion": [
          "Reducir vinagre. Hacer caramelo rubio con azúcar.",
          "Mezclar ambas elaboraciones. Debe quedar meloso."
        ]
      },
      // === NUEVAS RECETAS ADICIONALES PARA COMPLETAR 73 ===
      {
        "id": "VARIOS 174",
        "nombre": "Trufa con Leche",
        "categoria": "Dulces & Confites",
        "ingredientes": [
          { "nombre": "Nata", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Cobertura blanca", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Leche condensada", "cantidad": 100, "unidad": "gr" }
        ],
        "elaboracion": [
          "Calentar nata, añadir cobertura blanca y leche condensada.",
          "Dejar enfriar, hacer bolas y rodar en cacao."
        ]
      },
      {
        "id": "VARIOS 197",
        "nombre": "Marquesas",
        "categoria": "Bizcochos, Magdalenas & Muffins",
        "ingredientes": [
          { "nombre": "Huevos", "cantidad": 6, "unidad": "unidades" },
          { "nombre": "Azúcar", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Harina", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Mantequilla", "cantidad": 50, "unidad": "gr" }
        ],
        "elaboracion": [
          "Batir huevos con azúcar hasta triplicar volumen.",
          "Incorporar harina y mantequilla derretida con cuidado.",
          "Hornear a 180°C durante 25 minutos."
        ],
        "temperatura": 180,
        "tiempo": 25
      },
      {
        "id": "VARIOS 171",
        "nombre": "San Honore",
        "categoria": "Tartas Premium",
        "ingredientes": [
          { "nombre": "Pasta choux", "cantidad": 1, "unidad": "masa" },
          { "nombre": "Pasta sable", "cantidad": 1, "unidad": "masa" },
          { "nombre": "Crema San Honore", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Caramelo", "cantidad": 100, "unidad": "gr" }
        ],
        "elaboracion": [
          "Elaborar profiteroles con pasta choux.",
          "Montar base con pasta sable.",
          "Rellenar con crema, colocar profiteroles y abrillantar con caramelo."
        ]
      },
      {
        "id": "VARIOS 122",
        "nombre": "Tarta de Frambuesas",
        "categoria": "Tartas del Ayer",
        "ingredientes": [
          { "nombre": "Base de galleta", "cantidad": 1, "unidad": "unidad" },
          { "nombre": "Crema pastelera", "cantidad": 300, "unidad": "gr" },
          { "nombre": "Frambuesas", "cantidad": 400, "unidad": "gr" },
          { "nombre": "Gelatina de frambuesa", "cantidad": 1, "unidad": "sobre" }
        ],
        "elaboracion": [
          "Rellenar base con crema pastelera.",
          "Colocar frambuesas encima.",
          "Abrillantar con gelatina."
        ]
      },
      {
        "id": "VARIOS 129",
        "nombre": "Tarta de Queso (2ª Forma)",
        "categoria": "Tartas del Ayer",
        "ingredientes": [
          { "nombre": "Queso crema", "cantidad": 500, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 150, "unidad": "gr" },
          { "nombre": "Huevos", "cantidad": 4, "unidad": "unidades" },
          { "nombre": "Galletas", "cantidad": 200, "unidad": "gr" },
          { "nombre": "Mantequilla", "cantidad": 100, "unidad": "gr" },
          { "nombre": "Coulis de fruta", "cantidad": 200, "unidad": "gr" }
        ],
        "elaboracion": [
          "Base con galletas y mantequilla.",
          "Mezclar queso, azúcar y huevos.",
          "Verter sobre base y hornear al baño María.",
          "Desmoldar y cubrir con coulis."
        ],
        "temperatura": 160,
        "tiempo": 50
      },
      {
        "id": "VARIOS 46",
        "nombre": "Nata Montada",
        "categoria": "Rellenos & Coberturas",
        "ingredientes": [
          { "nombre": "Nata líquida", "cantidad": 1000, "unidad": "ml" },
          { "nombre": "Azúcar", "cantidad": 125, "unidad": "gr" }
        ],
        "elaboracion": [
          "Batir nata fría con azúcar hasta punto firme."
        ]
      },
      {
        "id": "VARIOS 45",
        "nombre": "Merengue Rápido",
        "categoria": "Decoración & Acabados",
        "ingredientes": [
          { "nombre": "Claritas", "cantidad": 400, "unidad": "gr" },
          { "nombre": "Azúcar", "cantidad": 600, "unidad": "gr" }
        ],
        "elaboracion": [
          "Mezclar y calentar al baño María hasta disolver azúcar.",
          "Batir hasta enfriar y tener cuerpo firme."
        ]
      }
    ];



   Estado global y persistencia
   ============================ */
const STORAGE = {
  FAVORITOS: 'dp_favoritos_v1',
  NOTES: 'dp_notes_v1',
  TIMERS: 'dp_timers_v1'
};

let favoritos = JSON.parse(localStorage.getItem(STORAGE.FAVORITOS) || "[]");
let notesMap = JSON.parse(localStorage.getItem(STORAGE.NOTES) || "{}"); // { recipeId: [{text,timestamp}] }
let timersStore = JSON.parse(localStorage.getItem(STORAGE.TIMERS) || "[]"); // array of timer objects persisted
// timersStore item: { id, recipeId, label, remainingSec, running, endTimestamp (if running) }

const historyStack = []; // array of { view, data }

const appRoot = document.getElementById('app-root');
const viewRoot = document.getElementById('view-root');
const suggestionsEl = document.getElementById('suggestions');
const modalRoot = document.getElementById('modal-root');
const timersBottom = document.getElementById('timers-bottom');

/* In-memory runtime map for intervals so we can clear them */
const runtimeIntervals = {}; // id -> intervalId

/* ============================
   Utilities
   ============================ */
function byId(id){ return document.getElementById(id); }
function formatTimeSec(sec){
  if(sec < 0) sec = 0;
  const m = Math.floor(sec/60); const s = sec % 60;
  return `${m}:${String(s).padStart(2,'0')}`;
}
function nowMs(){ return Date.now(); }
function saveTimers(){ localStorage.setItem(STORAGE.TIMERS, JSON.stringify(timersStore)); }
function saveNotes(){ localStorage.setItem(STORAGE.NOTES, JSON.stringify(notesMap)); }
function saveFavs(){ localStorage.setItem(STORAGE.FAVORITOS, JSON.stringify(favoritos)); }

/* ============================
   Navigation (stack-based)
   ============================ */
function pushView(view, data = {}) {
  historyStack.push({ view, data });
  renderView(view, data);
}
function replaceView(view, data = {}) {
  if(historyStack.length) historyStack[historyStack.length - 1] = { view, data };
  else historyStack.push({ view, data });
  renderView(view, data);
}
function goBack() {
  // pop current
  if(historyStack.length <= 1) {
    // go to home
    historyStack.length = 0;
    renderHome();
    return;
  }
  historyStack.pop();
  const prev = historyStack[historyStack.length - 1];
  renderView(prev.view, prev.data);
}

/* ============================
   Renderers
   ============================ */
function clearViewRoot(){ viewRoot.innerHTML = ''; modalRoot.innerHTML = ''; }
function renderHome(){
  // clear stack and show home
  historyStack.length = 0;
  clearViewRoot();
  appRoot.style.display = 'block';
  resetSearchBox();
}
function renderView(view, data = {}) {
  clearViewRoot();
  appRoot.style.display = 'none';
  if(view === 'menu') renderMenuView(data);
  else if(view === 'categorias') renderCategoriasView(data);
  else if(view === 'recetas') renderRecetasListView(data);
  else if(view === 'receta') renderRecetaView(data);
  else if(view === 'favoritos') renderFavoritosView(data);
  else if(view === 'notesAggregate') renderNotesAggregateView(data);
  else if(view === 'searchResults') renderSearchResultsView(data);
  else if(view === 'smartFilters') renderSmartFiltersView(data);
  else if(view === 'filterTime') renderFilterTimeView(data);
  else if(view === 'filterIngredient') renderFilterIngredientView(data);
  else if(view === 'filterDifficulty') renderFilterDifficultyView(data);
  else renderHome();
}

/* ---- Home helpers already in HTML: search and buttons will push new views ---- */

function renderMenuView(){
  const html = document.createElement('div');
  html.className = 'view';
  html.innerHTML = `
    <div class="view-header"><button class="view-back" onclick="goBack()">← Atrás</button><div class="view-title">Menú</div></div>
    <div class="list">
      <button class="item-btn" onclick="pushView('categorias')">Categorías</button>
      <button class="item-btn" onclick="pushView('favoritos')">Recetas estrella</button>
      <button class="item-btn" onclick="pushView('ultima')">Última receta</button>
    </div>
  `;
  viewRoot.appendChild(html);
}

function renderCategoriasView(){
  const cats = [...new Set(recetas.map(r=>r.categoria || 'Sin categoría'))].filter(Boolean);
  const html = document.createElement('div'); html.className='view';
  html.innerHTML = `<div class="view-header"><button class="view-back" onclick="goBack()">← Atrás</button><div class="view-title">Categorías</div></div>`;
  const list = document.createElement('div'); list.className='list';
  if(!cats.length) list.innerHTML = '<div class="item-btn">No hay categorías</div>';
  cats.forEach(c => {
    const b = document.createElement('button'); b.className='item-btn';
    b.textContent = c;
    b.onclick = ()=> pushView('recetas',{ categoria: c });
    list.appendChild(b);
  });
  html.appendChild(list);
  viewRoot.appendChild(html);
}

function renderRecetasListView(data){
  const results = data.resultados || recetas.filter(r=>r.categoria === data.categoria);
  const title = data.title || data.categoria || 'Recetas';
  const html = document.createElement('div'); html.className='view';
  html.innerHTML = `<div class="view-header"><button class="view-back" onclick="goBack()">← Atrás</button><div class="view-title">${title}</div></div>`;
  const list = document.createElement('div'); list.className='list';
  if(!results.length) list.innerHTML = '<div class="item-btn">No hay recetas.</div>';
  results.forEach(r => {
    const b = document.createElement('button'); b.className='item-btn';
    b.textContent = r.nombre;
    b.onclick = ()=> pushView('receta',{ id: r.id, fromList: { view:'recetas', data } });
    list.appendChild(b);
  });
  html.appendChild(list);
  viewRoot.appendChild(html);
}

function renderSearchResultsView(data){
  const results = data.results || [];
  const q = data.query || 'Resultados';
  const html = document.createElement('div'); html.className='view';
  html.innerHTML = `<div class="view-header"><button class="view-back" onclick="goBack()">← Atrás</button><div class="view-title">Resultados: ${escapeHtml(q)}</div></div>`;
  const list = document.createElement('div'); list.className='list';
  if(!results.length) list.innerHTML = '<div class="item-btn">No hay resultados.</div>';
  results.forEach(r => {
    const b = document.createElement('button'); b.className='item-btn';
    b.textContent = r.nombre;
    b.onclick = ()=> pushView('receta',{ id: r.id, fromList: { view:'searchResults', data } });
    list.appendChild(b);
  });
  html.appendChild(list);
  viewRoot.appendChild(html);
}

function renderFavoritosView(){
  const favs = recetas.filter(r => favoritos.includes(r.id));
  const html = document.createElement('div'); html.className='view';
  html.innerHTML = `<div class="view-header"><button class="view-back" onclick="goBack()">← Atrás</button><div class="view-title">Recetas estrella</div></div>`;
  const list = document.createElement('div'); list.className='list';
  if(!favs.length) list.innerHTML = '<div class="item-btn">No tienes recetas favoritas.</div>';
  favs.forEach(r=>{
    const b = document.createElement('button'); b.className='item-btn';
    b.textContent = r.nombre;
    b.onclick = ()=> pushView('receta',{ id: r.id, fromList: { view:'favoritos' } });
    list.appendChild(b);
  });
  html.appendChild(list);
  viewRoot.appendChild(html);
}

function renderNotesAggregateView(){
  // Aggregate all notes across recipes sorted chronologically (latest first)
  const entries = [];
  for(const rid in notesMap){
    (notesMap[rid]||[]).forEach(note => {
      entries.push({ recipeId: rid, text: note.text, ts: note.ts });
    });
  }
  entries.sort((a,b)=>b.ts - a.ts);
  const html = document.createElement('div'); html.className='view';
  html.innerHTML = `<div class="view-header"><button class="view-back" onclick="goBack()">← Atrás</button><div class="view-title">Notas personales (todas)</div></div>`;
  const container = document.createElement('div'); container.className='notes-aggregate';
  if(!entries.length) container.innerHTML = '<div class="item-btn">Aún no hay notas.</div>';
  entries.forEach(e=>{
    const block = document.createElement('div'); block.className='note-block';
    const recipe = recetas.find(r=>r.id === e.recipeId);
    block.innerHTML = `<div class="note-title">${escapeHtml(recipe?recipe.nombre: e.recipeId)} <small style="color:var(--muted);margin-left:8px">${new Date(e.ts).toLocaleString()}</small></div>
      <div>${escapeHtml(e.text)}</div>
      <div style="margin-top:8px"><button class="item-btn" style="width:auto" onclick="shareText('${encodeURIComponent((recipe?recipe.nombre: e.recipeId) + '\\n\\n' + e.text)}')">Compartir</button></div>`;
    container.appendChild(block);
  });
  html.appendChild(container);
  viewRoot.appendChild(html);
}

function renderRecetaView(data){
  const id = data.id;
  const r = recetas.find(x => x.id === id);
  if(!r){
    const html = document.createElement('div'); html.className='view'; html.innerHTML = `<div class="view-header"><button class="view-back" onclick="goBack()">← Atrás</button><div class="view-title">Receta no encontrada</div></div>`;
    viewRoot.appendChild(html); return;
  }

  // ensure parser-created timers exist (but do not auto-start)
  ensureTimersCreatedForRecipe(r);

  // build view
  const html = document.createElement('div'); html.className='view';
  // header with back + timer select + actions
  const header = document.createElement('div'); header.className='view-header';
  header.innerHTML = `
    <button class="view-back" onclick="goBack()">← Atrás</button>
    <div class="view-title">${escapeHtml(r.nombre)}</div>
  `;

  html.appendChild(header);

  // recipe content container
  const content = document.createElement('div');

  // recipe meta (category + favorite)
  const favActive = favoritos.includes(r.id);
  const favBtnHtml = `<button class="item-btn" style="width:auto" onclick="toggleFavorito('${r.id}', this)">${favActive? '★ Favorito' : '☆ Marcar favorito'}</button>`;
  const metaHtml = `<div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:12px">
    <div style="font-weight:900;color:var(--muted)">${escapeHtml(r.categoria||'')}</div>
    <div>${favBtnHtml}</div>
  </div>`;
  content.insertAdjacentHTML('beforeend', metaHtml);

  // timer control row (select minutes 1..90 + create timer button)
  const timerRow = document.createElement('div'); timerRow.className = 'recipe-top-actions';
  const select = document.createElement('select'); select.className='timer-select'; select.id='recipe-timer-select';
  for(let i=1;i<=90;i++){ const o = document.createElement('option'); o.value = i; o.textContent = `${i} min`; select.appendChild(o); }
  const addTimerBtn = document.createElement('button'); addTimerBtn.className='timer-mini-btn'; addTimerBtn.textContent='Añadir temporizador';
  addTimerBtn.onclick = ()=> {
    const mins = parseInt(select.value);
    createTimerForRecipe(r.id, mins, r.nombre, { startImmediately:false });
    alert(`Temporizador de ${mins} min creado para "${r.nombre}". Puedes iniciarlo desde la receta o desde el panel inferior.`);
    renderTimersInRecipeView(r.id, content); // refresh section
    renderTimersBottom();
  };
  timerRow.appendChild(select); timerRow.appendChild(addTimerBtn);
  content.appendChild(timerRow);

  // Ingredients and elaboration
  const ingHtml = `<div class="section-title">Ingredientes</div><div class="ingredientes"><ul>${(r.ingredientes||[]).map(i=>`<li>${escapeHtml(i.nombre)} ${i.cantidad?('- '+escapeHtml(String(i.cantidad))):''} ${i.unidad?escapeHtml(i.unidad):''}</li>`).join('')}</ul></div>`;
  content.insertAdjacentHTML('beforeend', ingHtml);

  const elaborHtml = `<div class="section-title">Elaboración</div><div class="elaboracion"><ol>${(r.elaboracion||[]).map(s=>`<li>${escapeHtml(s)}</li>`).join('')}</ol></div>`;
  content.insertAdjacentHTML('beforeend', elaborHtml);

  // timers area inside recipe (shows timers for this recipe with start/pause/change/delete)
  const timersContainer = document.createElement('div'); timersContainer.id = 'recipe-timers-container';
  timersContainer.style.marginTop = '12px';
  content.appendChild(timersContainer);

  // share and notes buttons
  const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='10px'; actions.style.marginTop='14px';
  const shareBtn = document.createElement('button'); shareBtn.className='item-btn'; shareBtn.style.width='50%'; shareBtn.textContent='Compartir';
  shareBtn.onclick = ()=> openShareMenuForRecipe(r);
  const notesBtn = document.createElement('button'); notesBtn.className='item-btn'; notesBtn.style.width='50%'; notesBtn.textContent='Notas y observaciones';
  notesBtn.onclick = ()=> pushView('notesForRecipe',{ id: r.id });
  actions.appendChild(shareBtn); actions.appendChild(notesBtn);
  content.appendChild(actions);

  html.appendChild(content);
  viewRoot.appendChild(html);

  // render recipe timers area
  renderTimersInRecipeView(r.id, content);

  // push current view into history if not already the top
  const top = historyStack[historyStack.length-1];
  if(!top || top.view !== 'receta' || top.data.id !== r.id) pushHistoryKeep(r.id);
}

// small helper: pushView but for receta we want to mark proper data
function pushHistoryKeep(recipeId){
  // ensure last in stack is current view (we call pushView elsewhere) - this function called only from recipe render
  // Instead of pushing again, we rely on caller pushView when invoked. This function ensures stack correct.
  // noop here — navigation push already done in pushView('receta', ...)
}

/* ============================
   Timers: create / start / pause / delete / restore
   ============================ */

function ensureTimersCreatedForRecipe(recipe){
  // detect minutes in recipe (tiempo field and in elaboracion text)
  const foundMins = detectTimesFromRecipe(recipe); // returns array[int minutes]
  // For each detected time, if there's not an existing timer for same recipe and same minutes, create it (not running)
  foundMins.forEach(mins=>{
    const exists = timersStore.some(t => t.recipeId === recipe.id && t.label === `${mins}min` && !t._autoCreated);
    // _autoCreated used to mark we auto-created from parser previously
    if(!exists){
      createTimerForRecipe(recipe.id, mins, recipe.nombre, { startImmediately:false, autoCreated:true });
    }
  });
}

function detectTimesFromRecipe(recipe){
  const times = [];
  if(typeof recipe.tiempo === 'number' && recipe.tiempo > 0) times.push(recipe.tiempo);
  if(Array.isArray(recipe.elaboracion)){
    const text = recipe.elaboracion.join(' ');
    // detect "30 min", "20 minutos", "1 hora", "2 horas"
    const reMin = /(\d+)\s*(min|mins|minuto|minutos)/ig;
    const reHour = /(\d+)\s*(h|hora|horas)/ig;
    let m;
    while((m = reMin.exec(text)) !== null) times.push(parseInt(m[1]));
    while((m = reHour.exec(text)) !== null) times.push(parseInt(m[1]) * 60);
  }
  // unique and positive
  return Array.from(new Set(times.filter(n => Number.isFinite(n) && n > 0)));
}

function createTimerForRecipe(recipeId, minutes, labelStr, opts={ startImmediately:false, autoCreated:false }){
  const id = 't_' + Date.now() + '_' + Math.floor(Math.random()*9999);
  const remainingSec = minutes * 60;
  const timer = {
    id, recipeId, label: `${minutes}min`, remainingSec,
    running: false, endTs: null, autoCreated: !!opts.autoCreated
  };
  timersStore.push(timer);
  saveTimers();
  if(opts.startImmediately) startTimer(id);
  renderTimersBottom();
  return timer;
}

function startTimer(id){
  const t = timersStore.find(x => x.id === id);
  if(!t) return;
  if(t.running){
    // already running
    return;
  }
  // set end timestamp
  t.endTs = nowMs() + (t.remainingSec * 1000);
  t.running = true;
  saveTimers();
  // start runtime interval
  attachIntervalForTimer(t);
  renderTimersBottom();
  refreshRecipeTimerAreaIfVisible(t.recipeId);
}
function pauseTimer(id){
  const t = timersStore.find(x => x.id === id);
  if(!t) return;
  if(!t.running) return;
  // compute remaining
  const rem = Math.max(0, Math.round((t.endTs - nowMs())/1000));
  t.remainingSec = rem;
  t.running = false;
  t.endTs = null;
  saveTimers();
  detachIntervalForTimer(t.id);
  renderTimersBottom();
  refreshRecipeTimerAreaIfVisible(t.recipeId);
}
function stopAndRemoveTimer(id){
  const idx = timersStore.findIndex(x => x.id === id);
  if(idx === -1) return;
  const t = timersStore[idx];
  detachIntervalForTimer(t.id);
  timersStore.splice(idx,1);
  saveTimers();
  renderTimersBottom();
  refreshRecipeTimerAreaIfVisible(t.recipeId);
}
function attachIntervalForTimer(timerObj){
  // avoid duplicate
  if(runtimeIntervals[timerObj.id]) return;
  const loop = ()=>{
    const t = timersStore.find(x => x.id === timerObj.id);
    if(!t) { clearInterval(runtimeIntervals[timerObj.id]); delete runtimeIntervals[timerObj.id]; return; }
    if(!t.running) { clearInterval(runtimeIntervals[t.id]); delete runtimeIntervals[t.id]; return; }
    const rem = Math.max(0, Math.round((t.endTs - nowMs())/1000));
    t.remainingSec = rem;
    if(rem <= 0){
      // finish
      t.running = false; t.endTs = null; t.remainingSec = 0;
      saveTimers();
      clearInterval(runtimeIntervals[t.id]); delete runtimeIntervals[t.id];
      // notify user (only in current session)
      try { if(window.navigator && window.navigator.vibrate) window.navigator.vibrate(200); } catch(e){}
      alert(`⏰ Temporizador "${t.label}" de "${findRecipeName(t.recipeId)}" ha terminado.`);
      renderTimersBottom();
      refreshRecipeTimerAreaIfVisible(t.recipeId);
      return;
    }
    saveTimers();
    renderTimersBottom();
    refreshRecipeTimerAreaIfVisible(t.recipeId);
  };
  loop(); // initial
  runtimeIntervals[timerObj.id] = setInterval(loop, 1000);
}
function detachIntervalForTimer(id){
  if(runtimeIntervals[id]){ clearInterval(runtimeIntervals[id]); delete runtimeIntervals[id]; }
}

function resumeTimersFromStore(){
  // Called on load to attach intervals for running timers and compute remainingSecs
  timersStore.forEach(t=>{
    if(t.running && t.endTs){
      // recalc remaining
      const rem = Math.max(0, Math.round((t.endTs - nowMs())/1000));
      t.remainingSec = rem;
      if(rem <= 0){
        // finished
        t.running = false; t.remainingSec = 0; t.endTs = null;
      } else {
        attachIntervalForTimer(t);
      }
    }
  });
  saveTimers();
  renderTimersBottom();
}

/* ============================
   Render timers areas
   - In recipe view: show timers associated with recipe (start/pause/change/delete)
   - Bottom panel: show all timers (running or paused) in compact chips with stop/delete controls
   ============================ */

function renderTimersInRecipeView(recipeId, contentContainer){
  // contentContainer may be passed; if not find by id; create or refresh container
  let container = contentContainer ? contentContainer.querySelector('#recipe-timers-container') : document.getElementById('recipe-timers-container');
  if(!container){
    // If not found, nothing to render
    return;
  }
  container.innerHTML = '';
  const title = document.createElement('div'); title.className='section-title'; title.textContent = 'Temporizadores de esta receta';
  container.appendChild(title);
  const list = document.createElement('div'); list.style.display='flex'; list.style.flexDirection='column'; list.style.gap='8px';
  const myTimers = timersStore.filter(t => t.recipeId === recipeId);
  if(!myTimers.length){
    const none = document.createElement('div'); none.className='item-btn'; none.textContent = 'No hay temporizadores asociados. Usa el selector superior para añadir uno.';
    list.appendChild(none);
  } else {
    myTimers.forEach(t=>{
      const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.alignItems='center';
      const label = document.createElement('div'); label.style.flex='1'; label.innerHTML = `<strong>${escapeHtml(t.label)}</strong> — ${formatTimeSec(t.remainingSec)} ${t.running?'<small style="color:var(--muted)"> (en marcha)</small>':''}`;
      const startBtn = document.createElement('button'); startBtn.className='timer-mini-btn'; startBtn.textContent = t.running? 'Pausar' : 'Iniciar';
      startBtn.onclick = ()=> {
        if(t.running) pauseTimer(t.id);
        else startTimer(t.id);
        renderTimersInRecipeView(recipeId, contentContainer);
      };
      const changeBtn = document.createElement('button'); changeBtn.className='timer-mini-btn'; changeBtn.textContent = 'Cambiar';
      changeBtn.onclick = ()=> {
        const nuevo = prompt('Nuevo tiempo en minutos:', Math.max(1, Math.round(t.remainingSec/60)));
        if(nuevo && !isNaN(nuevo)){
          t.remainingSec = Math.max(1, parseInt(nuevo)) * 60;
          if(t.running) t.endTs = nowMs() + t.remainingSec*1000;
          saveTimers(); renderTimersInRecipeView(recipeId, contentContainer); renderTimersBottom();
        }
      };
      const delBtn = document.createElement('button'); delBtn.className='timer-mini-btn'; delBtn.textContent='Eliminar';
      delBtn.onclick = ()=> { if(confirm('Eliminar este temporizador?')){ stopAndRemoveTimer(t.id); renderTimersInRecipeView(recipeId, contentContainer); } };
      row.appendChild(label); row.appendChild(startBtn); row.appendChild(changeBtn); row.appendChild(delBtn);
      list.appendChild(row);
    });
  }
  container.appendChild(list);
}

function renderTimersBottom(){
  timersBottom.innerHTML = '';
  if(!timersStore.length) { timersBottom.style.display='none'; return; }
  timersBottom.style.display = 'flex';
  timersStore.forEach(t => {
    // show only if running or paused — user wanted an unobtrusive panel; show all, with running highlighted.
    const chip = document.createElement('div'); chip.className='timer-chip';
    const name = document.createElement('small'); name.textContent = `${truncate(findRecipeName(t.recipeId),20)}: ${formatTimeSec(t.remainingSec)}`;
    const startPause = document.createElement('button'); startPause.className='timer-action'; startPause.textContent = t.running? 'Pausar' : 'Iniciar';
    startPause.onclick = ()=>{ t.running? pauseTimer(t.id): startTimer(t.id); };
    const del = document.createElement('button'); del.className='timer-action'; del.textContent='Eliminar';
    del.onclick = ()=>{ if(confirm('Eliminar temporizador?')) stopAndRemoveTimer(t.id); };
    chip.appendChild(name); chip.appendChild(startPause); chip.appendChild(del);
    timersBottom.appendChild(chip);
  });
}

/* ============================
   Helpers for recipes, favorites, notes
   ============================ */
function findRecipeName(id){ const r = recetas.find(x=>x.id===id); return r? r.nombre : id; }
function toggleFavorito(id, btnEl){
  if(favoritos.includes(id)){
    favoritos = favoritos.filter(x=>x!==id);
  } else {
    favoritos.push(id);
  }
  saveFavs();
  // update UI label if provided
  if(btnEl) btnEl.textContent = favoritos.includes(id)? '★ Favorito' : '☆ Marcar favorito';
}
function openShareMenuForRecipe(recipe){
  // share formatted recipe
  const formatted = formatRecipeForShare(recipe);
  openShareModal(formatted, recipe.nombre);
}
function formatRecipeForShare(r){
  const ing = (r.ingredientes||[]).map(i=>`- ${i.nombre}${i.cantidad?` — ${i.cantidad} ${i.unidad||''}`:''}`).join('\n');
  const el = (r.elaboracion||[]).map((s,i)=>`${i+1}. ${s}`).join('\n');
  const ttotal = detectTimesFromRecipe(r).reduce((a,b)=>a+b,0);
  return `🍰 ${r.nombre}\n-------------------\n🥄 Ingredientes:\n${ing}\n\n👩‍🍳 Elaboración:\n${el}\n\n⏱ Tiempo total aprox: ${ttotal? ttotal + ' min' : 'No especificado'}`;
}
function shareText(encodedText){
  const text = decodeURIComponent(encodedText);
  if(navigator.share){
    navigator.share({ title:'Nota / Receta', text }).catch(()=>{ alert('No se pudo usar compartir nativo.'); });
  } else {
    // show a modal with direct links
    openShareModal(text, 'Compartir');
  }
}

/* ============================
   Modals: share & simple prompt-like UI (custom)
   ============================ */
function openShareModal(text, title='Compartir'){
  modalRoot.innerHTML = '';
  const modal = document.createElement('div'); modal.className='modal';
  const card = document.createElement('div'); card.className='modal-card';
  card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;"><strong>${escapeHtml(title)}</strong><button onclick="closeModal()" style="background:transparent;border:none;font-weight:900;cursor:pointer">✕</button></div>
    <div style="margin-top:12px; white-space:pre-wrap;">${escapeHtml(text)}</div>
    <div class="share-list">
      <button class="share-btn" onclick='doShareWeb("whatsapp","${encodeURIComponent(text)}")'><i class="fa fa-whatsapp"></i> WhatsApp</button>
      <button class="share-btn" onclick='doShareWeb("telegram","${encodeURIComponent(text)}")'><i class="fa fa-paper-plane"></i> Telegram</button>
      <button class="share-btn" onclick='doShareWeb("email","${encodeURIComponent(text)}")'><i class="fa fa-envelope"></i> Email</button>
      <button class="share-btn" onclick='doShareWeb("sms","${encodeURIComponent(text)}")'><i class="fa fa-sms"></i> SMS</button>
    </div>`;
  modal.appendChild(card);
  modalRoot.appendChild(modal);
}
function closeModal(){ modalRoot.innerHTML = ''; }

/* helper used by share modal */
function doShareWeb(type, encodedText){
  closeModal();
  const text = decodeURIComponent(encodedText);
  if(type === 'whatsapp'){
    window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`, '_blank');
  } else if(type === 'telegram'){
    window.open(`https://t.me/share/url?url=&text=${encodeURIComponent(text)}`, '_blank');
  } else if(type === 'email'){
    window.location.href = `mailto:?subject=${encodeURIComponent('Receta / Nota')}&body=${encodeURIComponent(text)}`;
  } else if(type === 'sms'){
    window.location.href = `sms:?body=${encodeURIComponent(text)}`;
  }
}

/* ============================
   Smart filters (buscador inteligente)
   - time: A/B/C mapping to ranges
   - difficulty: F/M/D mapping based on detected times
   - ingredient: text input
   ============================ */

function renderSmartFiltersView(){
  const html = document.createElement('div'); html.className='view';
  html.innerHTML = `<div class="view-header"><button class="view-back" onclick="goBack()">← Atrás</button><div class="view-title">Buscador inteligente</div></div>`;
  const container = document.createElement('div'); container.className='list';
  const btn1 = document.createElement('button'); btn1.className='item-btn'; btn1.textContent='Filtrar por ingrediente'; btn1.onclick = ()=> pushView('filterIngredient');
  const btn2 = document.createElement('button'); btn2.className='item-btn'; btn2.textContent='Filtrar por tiempo (A/B/C)'; btn2.onclick = ()=> pushView('filterTime');
  const btn3 = document.createElement('button'); btn3.className='item-btn'; btn3.textContent='Filtrar por dificultad (F/M/D)'; btn3.onclick = ()=> pushView('filterDifficulty');
  container.appendChild(btn1); container.appendChild(btn2); container.appendChild(btn3);
  html.appendChild(container); viewRoot.appendChild(html);
}

function renderFilterIngredientView(){
  const html = document.createElement('div'); html.className='view';
  html.innerHTML = `<div class="view-header"><button class="view-back" onclick="goBack()">← Atrás</button><div class="view-title">Filtrar por ingrediente</div></div>`;
  const container = document.createElement('div'); container.className='list';
  const input = document.createElement('input'); input.placeholder='¿Qué ingrediente?'; input.style.padding='12px'; input.style.borderRadius='10px'; input.style.border='1px solid rgba(12,32,60,0.06)';
  const searchBtn = document.createElement('button'); searchBtn.className='item-btn'; searchBtn.textContent='Buscar';
  searchBtn.onclick = ()=>{
    const q = (input.value||'').trim().toLowerCase();
    if(!q){ alert('Introduce un ingrediente.'); return; }
    const results = recetas.filter(r => (r.ingredientes||[]).some(i => (i.nombre||'').toLowerCase().includes(q)));
    pushView('searchResults',{ results, query: input.value });
  };
  container.appendChild(input); container.appendChild(searchBtn);
  html.appendChild(container); viewRoot.appendChild(html);
}

function renderFilterTimeView(){
  const html = document.createElement('div'); html.className='view';
  html.innerHTML = `<div class="view-header"><button class="view-back" onclick="goBack()">← Atrás</button><div class="view-title">Filtrar por tiempo</div></div>`;
  const container = document.createElement('div'); container.className='list';
  container.appendChild(makeFilterOptionButton('Franja "A": 1 - 20 min','A', (opt)=>{ applyTimeFilter(opt); }));
  container.appendChild(makeFilterOptionButton('Franja "B": 21 - 40 min','B', (opt)=>{ applyTimeFilter(opt); }));
  container.appendChild(makeFilterOptionButton('Franja "C": 41+ min','C', (opt)=>{ applyTimeFilter(opt); }));
  html.appendChild(container); viewRoot.appendChild(html);
}
function applyTimeFilter(letter){
  const L = (letter||'').toString().trim().toUpperCase();
  let results=[];
  if(L === 'A') results = recetas.filter(r => totalTimeOfRecipe(r) <= 20);
  if(L === 'B') results = recetas.filter(r => totalTimeOfRecipe(r) >= 21 && totalTimeOfRecipe(r) <= 40);
  if(L === 'C') results = recetas.filter(r => totalTimeOfRecipe(r) >= 41);
  pushView('searchResults',{ results, query: `Franja ${L}` });
}
function renderFilterDifficultyView(){
  const html = document.createElement('div'); html.className='view';
  html.innerHTML = `<div class="view-header"><button class="view-back" onclick="goBack()">← Atrás</button><div class="view-title">Filtrar por dificultad</div></div>`;
  const container = document.createElement('div'); container.className='list';
  container.appendChild(makeFilterOptionButton('Fácil (F)','F', (opt)=>applyDifficultyFilter(opt)));
  container.appendChild(makeFilterOptionButton('Medio (M)','M', (opt)=>applyDifficultyFilter(opt)));
  container.appendChild(makeFilterOptionButton('Difícil (D)','D', (opt)=>applyDifficultyFilter(opt)));
  html.appendChild(container); viewRoot.appendChild(html);
}
function applyDifficultyFilter(letter){
  const L = (letter||'').toString().trim().toUpperCase();
  const map = { 'F': r => recipeDifficulty(r) === 'F', 'M': r => recipeDifficulty(r) === 'M', 'D': r => recipeDifficulty(r) === 'D' };
  const pred = map[L] || (()=>false);
  const results = recetas.filter(pred);
  pushView('searchResults',{ results, query: `Nivel ${L}` });
}
function makeFilterOptionButton(label, key, onClick){
  const b = document.createElement('button'); b.className='item-btn'; b.textContent = label;
  b.onclick = ()=> onClick(key);
  return b;
}

/* ============================
   Search suggestions and search box
   - suggestions appear under input and do not navigate immediately
   - clicking suggestion opens searchResults view (so back returns to results)
   ============================ */

const busquedaInput = byId('buscador');
busquedaInput.addEventListener('input', onSearchInput);
busquedaInput.addEventListener('keydown', e=>{
  // Enter -> open searchResults
  if(e.key === 'Enter'){
    const q = busquedaInput.value.trim();
    if(!q) return;
    const results = searchRecipesByQuery(q);
    pushView('searchResults',{ results, query: q });
    hideSuggestions();
  }
});
function onSearchInput(e){
  const q = (e.target.value || '').trim();
  if(!q){ hideSuggestions(); return; }
  const results = searchRecipesByQuery(q).slice(0,12);
  if(!results.length){ hideSuggestions(); return; }
  showSuggestions(results, q);
}
function searchRecipesByQuery(q){
  q = (q||'').toLowerCase();
  return recetas.filter(r=>{
    if((r.nombre||'').toLowerCase().includes(q)) return true;
    if((r.categoria||'').toLowerCase().includes(q)) return true;
    if((r.ingredientes||[]).some(i=> (i.nombre||'').toLowerCase().includes(q))) return true;
    return false;
  });
}
function showSuggestions(results, q){
  suggestionsEl.innerHTML = '';
  suggestionsEl.style.display = 'block';
  results.forEach(r => {
    const btn = document.createElement('button');
    btn.textContent = r.nombre + (r.categoria ? ` — ${r.categoria}` : '');
    btn.onclick = ()=> {
      // open searchResults with full results for the query so back goes there
      const all = searchRecipesByQuery(q);
      pushView('searchResults',{ results: all, query: q });
      hideSuggestions();
    };
    suggestionsEl.appendChild(btn);
  });
}
function hideSuggestions(){ suggestionsEl.style.display = 'none'; suggestionsEl.innerHTML = ''; }
function resetSearchBox(){ busquedaInput.value = ''; hideSuggestions(); busquedaInput.placeholder = 'Buscar receta . . .'; }

/* ============================
   Notes per recipe
   - notesMap stored as { recipeId: [ { text, ts } ] }
   - per-recipe notes view (pushView('notesForRecipe',{id}))
   - saving stores in notesMap and localStorage and shows in aggregate in main notes view
   ============================ */

function pushViewNotesForRecipe(recipeId){
  pushView('notesForRecipe', { id: recipeId });
}
function renderNotesForRecipeView(data){
  const recipeId = data.id;
  const recipe = recetas.find(r=>r.id===recipeId);
  const html = document.createElement('div'); html.className='view';
  html.innerHTML = `<div class="view-header"><button class="view-back" onclick="goBack()">← Atrás</button><div class="view-title">Notas: ${escapeHtml(recipe?recipe.nombre:recipeId)}</div></div>`;
  const container = document.createElement('div'); container.className='list';
  const textarea = document.createElement('textarea'); textarea.style.width='100%'; textarea.style.minHeight='40vh'; textarea.style.padding='12px'; textarea.style.borderRadius='10px';
  textarea.value = (notesMap[recipeId] && notesMap[recipeId].length) ? notesMap[recipeId][notesMap[recipeId].length-1].text : '';
  const saveBtn = document.createElement('button'); saveBtn.className='item-btn'; saveBtn.textContent='Guardar';
  saveBtn.onclick = ()=> {
    const txt = textarea.value.trim();
    if(!txt){ alert('La nota está vacía.'); return; }
    const arr = notesMap[recipeId] || [];
    arr.push({ text: txt, ts: Date.now() });
    notesMap[recipeId] = arr;
    saveNotes();
    alert('Nota guardada.');
  };
  const shareBtn = document.createElement('button'); shareBtn.className='item-btn'; shareBtn.textContent='Compartir';
  shareBtn.onclick = ()=> shareText(encodeURIComponent((recipe?recipe.nombre:recipeId) + '\n\n' + textarea.value));
  container.appendChild(textarea); container.appendChild(saveBtn); container.appendChild(shareBtn);
  // show previous notes for this recipe chronologically
  const prev = document.createElement('div'); prev.style.marginTop = '12px';
  const arrPrev = notesMap[recipeId] || [];
  if(arrPrev.length){
    arrPrev.slice().reverse().forEach(n=>{
      const b = document.createElement('div'); b.className='note-block'; b.style.marginBottom='8px';
      b.innerHTML = `<div style="font-weight:900;margin-bottom:6px">${new Date(n.ts).toLocaleString()}</div><div style="white-space:pre-wrap">${escapeHtml(n.text)}</div>`;
      prev.appendChild(b);
    });
  }
  html.appendChild(container); html.appendChild(prev);
  viewRoot.appendChild(html);
}

/* ============================
   Small helper + init
   ============================ */

function escapeHtml(s){
  if(s==null) return '';
  return String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]);
}
function truncate(s, n){ if(!s) return ''; return (s.length>n)? s.slice(0,n-1)+'…': s; }

/* totalTimeOfRecipe used by filters */
function totalTimeOfRecipe(r){
  return detectTimesFromRecipe(r).reduce((a,b)=>a+b, 0);
}
function recipeDifficulty(r){
  const t = totalTimeOfRecipe(r);
  if(t === 0 || t <= 20) return 'F';
  if(t > 20 && t <= 30) return 'M';
  return 'D';
}

/* helpers for recipe notes view plumbing with pushView */
window.pushView = function(v,d){ pushView(v,d); };
window.goBack = function(){ goBack(); };
window.openShareMenuForRecipe = openShareMenuForRecipe;
window.createTimerForRecipe = createTimerForRecipe;

/* ============================
   Initialization: event hooks & restoring timers
   ============================ */

document.getElementById('btn-modo').addEventListener('click', ()=>{
  document.body.classList.toggle('modo-oscuro');
});
document.getElementById('btn-menu').addEventListener('click', ()=> { pushView('menu'); });
document.getElementById('btn-estrella').addEventListener('click', ()=> { pushView('favoritos'); });
document.getElementById('btn-notas').addEventListener('click', ()=> { pushView('notesAggregate'); });
document.getElementById('btn-buscador-inteligente').addEventListener('click', ()=> { pushView('smartFilters'); });

// suggestions hide on click outside
document.addEventListener('click', (e)=>{
  if(!document.querySelector('.search-row').contains(e.target)) hideSuggestions();
});

// load timers from storage and resume if running
resumeTimersFromStore();

// If the stack empty, show home
renderHome();

/* Hook for when a view is pushed: we used pushView(...) from UI — ensure rendering recipe notes view has support */
(function hookPushViewForNotes(){
  // Intercept pushView (we used pushView in code above) to support notesForRecipe
  const origPush = pushView;
  window.pushView = function(v,d){
    // call original (but ensure d default)
    origPush(v,d||{});
    // if pushed notesForRecipe view, render special view
    if(v === 'notesForRecipe'){
      // replace last view render with our specialized function
      historyStack[historyStack.length-1] = { view:'notesForRecipe', data:d };
      clearViewRoot();
      renderNotesForRecipeView(d);
    }
  }
})();

/* Render notes aggregate view on request mapping */
(function hookRenderViewNotesAggregate(){
  // patch renderView to handle notesAggregate and notesForRecipe mapping to proper functions
  const origRender = renderView;
  renderView = function(view, data){
    clearViewRoot();
    if(view === 'notesAggregate') renderNotesAggregateView();
    else if(view === 'notesForRecipe') renderNotesForRecipeView(data);
    else origRender(view,data);
  }
})();

/* On load: ensure if any recipe view should be shown (none), keep home */
/* Provide a small utility: if user hits Back browser button, map to goBack (optional) */
window.addEventListener('popstate', (e)=>{ goBack(); });

/* Expose some helpers in global for inline onclick use */
window.startTimer = startTimer;
window.pauseTimer = pauseTimer;
window.stopAndRemoveTimer = stopAndRemoveTimer;
window.shareText = shareText;

/* Initialize UI: make suggestions hidden and attach behavior to Opening recipe view link from suggestions works via pushView in code above */
function hideSuggestions(){ suggestionsEl.style.display='none'; suggestionsEl.innerHTML=''; }
function showSuggestions(arr){ /* not used directly */ }

/* Refresh recipe timer area when timers change and the recipe view is visible */
function refreshRecipeTimerAreaIfVisible(recipeId){
  const rc = document.querySelector('.view .recipe-top-actions') || null;
  // easiest: if current top view is receta with same id, re-render view
  const top = historyStack[historyStack.length - 1];
  if(top && top.view === 'receta' && top.data && top.data.id === recipeId){
    // re-render same view without pushing
    renderView('receta', top.data);
  }
}

/* small helper: when bottom timers updated, keep it visible */
function ensureTimersUI(){
  renderTimersBottom();
}

// expose a few functions to window for inline onclick attributes used earlier
window.ensureTimersCreatedForRecipe = ensureTimersCreatedForRecipe;
window.renderTimersInRecipeView = renderTimersInRecipeView;
window.renderTimersBottom = renderTimersBottom;
window.findRecipeName = findRecipeName;

/* Final: wire a small handler so when user pushes "searchResults" or similar with search, the functions above are used.
   NOTE: Some older inline-created functions call pushView('receta'... etc).
*/

/* ============================
   Compatibility: if pushView replaced earlier, ensure proper functions exist
   ============================ */
if(!window.pushView) window.pushView = (v,d)=>{ pushView(v,d); };

/* END of script */
</script>
</body>
</html>


