<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador Inteligente de Recetas</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Estilos personalizados para asegurar la fuente Inter */
        html {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para tarjetas en pantallas pequeñas */
        @media (max-width: 640px) {
            .grid-recipes {
                grid-template-columns: 1fr;
            }
        }
        /* Clase para ocultar el scroll del cuerpo cuando un modal está abierto */
        .modal-open {
            overflow: hidden;
        }

        /* Estilos para el slider (range input) en Tailwind (Personalización de apariencia) */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px; 
            height: 16px;
            background: #4F46E5; /* Indigo-600 */
            cursor: pointer;
            border-radius: 9999px; /* rounded-full */
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.3); /* Ring effect */
            transition: background 0.15s, box-shadow 0.15s;
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #4F46E5;
            cursor: pointer;
            border-radius: 9999px;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.3);
            border: none;
            transition: background 0.15s, box-shadow 0.15s;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">

    <div id="app">
        <!-- Contenido principal generado por JavaScript -->
    </div>

    <!-- Contenedor para todos los Modales -->
    <div id="modals-container">
        <!-- Los modales se insertarán aquí con JavaScript -->
    </div>

    <script>
        // --- MOCK DE RECETAS Y LÍMITES ---
        const initialFilterState = {
            totalTime: { value: 240, min: 10, max: 240, label: "Tiempo Máximo", unit: "min" },
            ingredientCount: { value: 20, min: 3, max: 20, label: "Máx. Ingredientes", unit: "" },
            difficulty: { value: 1, min: 1, max: 5, label: "Dificultad Mínima", unit: "" },
            excludeIngredients: [], // Lista de ingredientes a excluir
            minRating: 0 // Mínimo de puntuación (0 a 5)
        };

        // Estado Reactivo de la Aplicación
        let filterState = { ...initialFilterState };
        let searchTerm = '';
        let activeModal = null; // Para rastrear qué modal está abierto

        
        const mockRecipes = [
            { id: 1, title: "Lomo Saltado Peruano Auténtico", category: "Carnes", prepTime: 20, cookingTime: 25, totalTime: 45, ingredients: 8, difficulty: 4, rating: 4.5, image: "https://placehold.co/600x400/EF4444/FFFFFF?text=Lomo+Saltado", tags: ["carne", "peruano", "salado"] },
            { id: 2, title: "Sopa de Tomate y Albahaca Rápida", category: "Sopas", prepTime: 10, cookingTime: 15, totalTime: 25, ingredients: 5, difficulty: 2, rating: 3.8, image: "https://placehold.co/600x400/10B981/FFFFFF?text=Sopa+Tomate", tags: ["vegetariano", "sopa", "rápida"] },
            { id: 3, title: "Curry de Garbanzos y Espinacas Vegano", category: "Vegetariano", prepTime: 15, cookingTime: 30, totalTime: 45, ingredients: 12, difficulty: 3, rating: 4.2, image: "https://placehold.co/600x400/3B82F6/FFFFFF?text=Curry+Vegano", tags: ["vegano", "curry", "salado"] },
            { id: 4, title: "Tarta de Manzana Clásica Holandesa", category: "Postres", prepTime: 30, cookingTime: 60, totalTime: 90, ingredients: 10, difficulty: 5, rating: 4.9, image: "https://placehold.co/600x400/F97316/FFFFFF?text=Tarta+Manzana", tags: ["postre", "dulce", "horneado"] },
            { id: 5, title: "Ensalada César con Pollo Grillado", category: "Ensaladas", prepTime: 15, cookingTime: 10, totalTime: 25, ingredients: 8, difficulty: 2, rating: 4.0, image: "https://placehold.co/600x400/D97706/FFFFFF?text=Ensalada+Cesar", tags: ["ensalada", "pollo", "rápida"] },
            // Añadir más recetas para una mejor prueba del filtrado
            { id: 6, title: "Filete de Pescado con Mantequilla de Ajo", category: "Pescado", prepTime: 10, cookingTime: 15, totalTime: 25, ingredients: 6, difficulty: 2, rating: 4.1, image: "https://placehold.co/600x400/06B6D4/FFFFFF?text=Pescado+Ajo", tags: ["pescado", "rápida", "salado"] },
            { id: 7, title: "Paella Valenciana Clásica", category: "Arroces", prepTime: 40, cookingTime: 45, totalTime: 85, ingredients: 15, difficulty: 5, rating: 4.7, image: "https://placehold.co/600x400/EF4444/FFFFFF?text=Paella", tags: ["marisco", "arroz", "española"] },
            { id: 8, title: "Galletas de Chispas de Chocolate (Sin Nueces)", category: "Postres", prepTime: 15, cookingTime: 12, totalTime: 27, ingredients: 7, difficulty: 1, rating: 3.9, image: "https://placehold.co/600x400/F97316/FFFFFF?text=Galletas", tags: ["postre", "dulce", "horneado"] },
        ];

        // --- FUNCIONES AUXILIARES DE RENDERIZADO ---

        /**
         * Genera el HTML de las estrellas de dificultad.
         * @param {number} rating 
         */
        function getDifficultyStars(rating) {
            let html = '<div class="flex items-center space-x-0.5">';
            // Redondear el rating para la visualización de estrellas
            const roundedRating = Math.round(rating * 2) / 2;
            for (let i = 1; i <= 5; i++) {
                let color = 'text-gray-300';
                let svgContent = `<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>`; // Estrella completa (default)
                
                if (roundedRating >= i) {
                    // Estrella completa
                    color = 'text-yellow-400 fill-yellow-400';
                } else if (roundedRating === i - 0.5) {
                    // Media estrella (usamos un clip-path o un SVG de media estrella, pero por simplicidad usaremos un color gris oscuro para indicar medio)
                    color = 'text-yellow-400 fill-yellow-400 opacity-50'; 
                }

                // Usamos el código SVG de Lucide para evitar la dependencia de React
                const svgHtml = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 transition-colors duration-150 ${color}">${svgContent}</svg>`;
                html += svgHtml;
            }
            html += '</div>';
            return html;
        }

        /**
         * Genera el HTML de una tarjeta de receta.
         * @param {Object} recipe 
         */
        function renderRecipeCard(recipe) {
            const starsHtml = getDifficultyStars(recipe.rating);
            
            return `
                <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 overflow-hidden border border-gray-100">
                    <div class="relative h-48 sm:h-56">
                        <img 
                            src="${recipe.image}" 
                            alt="${recipe.title}" 
                            class="w-full h-full object-cover" 
                            onerror="this.onerror=null;this.src='https://placehold.co/600x400/1E3A8A/FFFFFF?text=Receta';"
                        />
                        <div class="absolute top-3 right-3 bg-indigo-600 text-white text-xs font-semibold px-3 py-1 rounded-full shadow-md flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-3 h-3 mr-1"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            ${recipe.totalTime} min
                        </div>
                    </div>
                    <div class="p-4 sm:p-5">
                        <h3 class="text-xl font-bold text-gray-800 mb-1 line-clamp-2">${recipe.title}</h3>
                        <div class="flex items-center justify-between mb-3">
                            ${starsHtml}
                            <span class="text-sm font-medium text-indigo-600">${recipe.category}</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600 border-t border-gray-100 pt-3">
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-1 text-gray-400"><path d="M3 2v7c0 1.1.9 2 2 2h4l-3 4v4"/><path d="M21 15v7c0 1.1-.9 2-2 2h-4l3-4v-4"/></svg>
                                <span>Prep: ${recipe.prepTime} min</span>
                            </div>
                            <div class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-1 text-gray-400"><path d="M12 2A7 7 0 0 0 5 9c0 5.5 7 13 7 13s7-7.5 7-13A7 7 0 0 0 12 2z"/><path d="M12 12a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
                                <span>Ingr: ${recipe.ingredients}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Genera el HTML de un botón de filtro rápido.
         * @param {string} label 
         * @param {string} iconHtml 
         * @param {string} colorClass 
         * @param {string} filterAction: Nombre de la acción del filtro (ej: 'time', 'difficulty').
         */
        function renderQuickFilterButton(label, iconHtml, colorClass, filterAction) {
            // Muestra el valor actual del filtro en el botón para Tiempo y Ingredientes
            let currentValue = '';
            // Si el valor actual es diferente al inicial, lo mostramos
            if (filterAction === 'time' && filterState.totalTime.value < initialFilterState.totalTime.value) {
                currentValue = `(${filterState.totalTime.value} ${filterState.totalTime.unit})`;
            } else if (filterAction === 'ingredientes' && filterState.ingredientCount.value < initialFilterState.ingredientCount.value) {
                 currentValue = `(${filterState.ingredientCount.value} Máx)`; 
            } else if (filterAction === 'difficulty' && filterState.difficulty.value > initialFilterState.difficulty.value) {
                currentValue = `(${filterState.difficulty.value}+ ⭐)`;
            } else if (filterAction === 'puntuacion' && filterState.minRating > initialFilterState.minRating) {
                 currentValue = `(${filterState.minRating}+ ⭐)`;
            } else if (filterAction === 'excluir' && filterState.excludeIngredients.length > 0) {
                 currentValue = `(${filterState.excludeIngredients.length})`;
            }


            return `
                <button 
                    onclick="handleFilterClick('${filterAction}')"
                    class="w-full py-3 px-4 rounded-xl text-lg font-bold shadow-md transition duration-200 transform hover:scale-[1.02] active:scale-[0.98]
                    ${colorClass} text-white flex items-center justify-center space-x-3 text-center"
                    title="${label}"
                >
                    <span>${label} ${currentValue}</span> ${iconHtml}
                </button>
            `;
        }
        
        // --- LÓGICA DE FILTRADO ---
        function filterRecipes() {
            let results = mockRecipes;

            // 1. Filtrado por texto de búsqueda (Título y Tags)
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                results = results.filter(recipe => 
                    recipe.title.toLowerCase().includes(term) ||
                    recipe.tags.some(tag => tag.includes(term))
                );
            }

            // 2. Aplicar lógica de filtros
            results = results.filter(recipe => {
                
                // a. Tiempo Total Máximo
                if (recipe.totalTime > filterState.totalTime.value) return false;

                // b. Conteo Máximo de Ingredientes
                if (recipe.ingredients > filterState.ingredientCount.value) return false;

                // c. Dificultad Mínima
                if (recipe.difficulty < filterState.difficulty.value) return false;
                
                // d. Puntuación Mínima (Rating)
                if (recipe.rating < filterState.minRating) return false;

                // e. Excluir Ingrediente (Simulación simple)
                if (filterState.excludeIngredients.length > 0) {
                     // Solo para simulación, asumimos que si la receta contiene la palabra clave, la excluimos.
                     const titleContainsExcluded = filterState.excludeIngredients.some(excludedTerm => 
                        recipe.title.toLowerCase().includes(excludedTerm.toLowerCase())
                    );
                    if (titleContainsExcluded) return false;
                }

                return true;
            });

            return results;
        }


        // --- LÓGICA DE MODALES ---

        /**
         * Muestra un modal por su ID.
         * @param {string} modalId 
         */
        function showModal(modalId) {
            // Primero nos aseguramos de que el DOM de los modales esté listo
            renderModals(); 
            
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.body.classList.add('modal-open');
                activeModal = modalId;
                
                // Inicializar valores de control si es necesario (ej: slider)
                if (modalId === 'modal-time') {
                    const slider = document.getElementById('filter-max-time');
                    const display = document.getElementById('time-display');
                    if (slider && display) {
                         slider.value = filterState.totalTime.value;
                         display.textContent = `${filterState.totalTime.value} min`;
                    }
                }
                if (modalId === 'modal-ingredients') {
                    const slider = document.getElementById('filter-max-ingredients');
                    const display = document.getElementById('ingredients-display');
                    if (slider && display) {
                         slider.value = filterState.ingredientCount.value;
                         display.textContent = `${filterState.ingredientCount.value}`;
                    }
                }
                if (modalId === 'modal-difficulty') {
                    // Seteamos el valor de la dificultad
                    document.getElementById('filter-min-difficulty').value = filterState.difficulty.value;
                }
                 // Para el modal de exclusión, forzamos la actualización de la lista
                if (modalId === 'modal-exclude') {
                    renderModals(); // Necesario para actualizar la lista de tags
                    showModal('modal-exclude');
                }
            }
        }

        /**
         * Oculta el modal activo.
         */
        function hideModal() {
            const modal = document.getElementById(activeModal);
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.classList.remove('modal-open');
                activeModal = null;
            }
        }

        /**
         * Maneja el guardado de los filtros dentro de un modal
         * @param {string} filterKey - Clave del filtro ('totalTime', 'ingredientCount', etc.)
         */
        function applyFilterFromModal(filterKey) {
            if (filterKey === 'totalTime') {
                // El valor viene del slider
                filterState.totalTime.value = parseInt(document.getElementById('filter-max-time').value);
            } else if (filterKey === 'difficulty') {
                filterState.difficulty.value = parseInt(document.getElementById('filter-min-difficulty').value);
            } else if (filterKey === 'ingredients') {
                 filterState.ingredientCount.value = parseInt(document.getElementById('filter-max-ingredients').value);
            } else if (filterKey === 'rating') {
                filterState.minRating = parseFloat(document.getElementById('filter-min-rating').value);
            }
            
            hideModal();
            renderApp();
        }
        
        /**
         * Lógica de añadir una exclusión
         */
        function addExclusion() {
            const exclusionInput = document.getElementById('exclude-input');
            const exclusionTerm = exclusionInput.value.trim();
            if (exclusionTerm && !filterState.excludeIngredients.map(s => s.toLowerCase()).includes(exclusionTerm.toLowerCase())) {
                 filterState.excludeIngredients.push(exclusionTerm);
            }
            // Limpiar input y actualizar el modal para ver el nuevo tag
            exclusionInput.value = '';
            renderModals(); // Re-renderiza el contenedor de modales para actualizar la lista
            showModal('modal-exclude'); // Muestra de nuevo el modal
            renderApp(); // Actualiza los resultados de búsqueda
        }

        // --- MANEJADORES DE EVENTOS ---

        /**
         * Maneja el clic en los botones de filtro rápido, abriendo el modal correspondiente.
         * @param {string} filterName 
         */
        function handleFilterClick(filterName) {
            if (filterName === 'time') {
                showModal('modal-time');
            } else if (filterName === 'difficulty') {
                showModal('modal-difficulty');
            } else if (filterName === 'ingredientes') {
                showModal('modal-ingredients');
            } else if (filterName === 'puntuacion') {
                showModal('modal-rating');
            } else if (filterName === 'excluir') {
                showModal('modal-exclude');
            } else if (filterName === 'reset') {
                // Reiniciar el estado a una copia profunda del estado inicial
                filterState = JSON.parse(JSON.stringify(initialFilterState)); 
                searchTerm = '';
                document.getElementById('search-input').value = '';
                // Asegurarse de que los valores de los modales y la app se reseteen
                renderModals();
                renderApp();
            }
        }

        function handleSearchInput(event) {
            searchTerm = event.target.value;
            renderApp();
        }

        // --- RENDERIZADO PRINCIPAL ---

        function renderApp() {
            const results = filterRecipes();
            
            const appDiv = document.getElementById('app');
            
            // Íconos SVG para los botones (usando Lucide directamente)
            const clockIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`;
            const zapIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`;
            const minusCircleIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="12" cy="12" r="10"/><line x1="8" y1="12" x2="16" y2="12"/></svg>`;
            const saladIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M15 10c-3 0-5 2.5-5 5"/></svg>`;
            const starIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`;
            
            // Generar el HTML de las tarjetas de resultados
            const recipeCardsHtml = results.length > 0 ?
                results.map(renderRecipeCard).join('') :
                `
                <div class="col-span-1 sm:col-span-2 text-center py-10 bg-white rounded-xl shadow-md border border-gray-100">
                    <p class="text-lg text-gray-500 font-medium">
                        No se encontraron recetas que coincidan con los filtros.
                    </p>
                </div>
                `;

            // HTML del indicador de filtros aplicados
            let activeFilters = [];
            if (filterState.totalTime.value < initialFilterState.totalTime.value) {
                activeFilters.push(`Tiempo: <span class="font-bold">${filterState.totalTime.value} min</span>`);
            }
            if (filterState.ingredientCount.value < initialFilterState.ingredientCount.value) {
                activeFilters.push(`Ingr: <span class="font-bold">${filterState.ingredientCount.value} Máx</span>`);
            }
             if (filterState.difficulty.value > initialFilterState.difficulty.value) {
                activeFilters.push(`Dif: <span class="font-bold">${filterState.difficulty.value}+ ⭐</span>`);
            }
            if (filterState.minRating > 0) {
                 activeFilters.push(`Punt: <span class="font-bold">${filterState.minRating}+ ⭐</span>`);
            }
            if (filterState.excludeIngredients.length > 0) {
                 activeFilters.push(`Excluir: <span class="font-bold">${filterState.excludeIngredients.length}</span>`);
            }

            const filterIndicatorHtml = activeFilters.length > 0 ?
                `<div class="mt-2 text-sm text-gray-600 flex flex-wrap gap-2">
                    <span class="font-semibold">Filtros Activos:</span>
                    ${activeFilters.map(f => `<span class="bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded-full text-xs">${f}</span>`).join('')}
                    <button
                        onclick="handleFilterClick('reset')"
                        class="text-xs font-medium text-red-500 hover:text-red-700 transition duration-150 flex items-center bg-red-50 px-2 py-0.5 rounded-full"
                        title="Resetear todos los filtros aplicados"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-3 h-3 mr-1"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
                        Reset
                    </button>
                </div>` :
                '<p class="mt-2 text-sm text-gray-400">Ningún filtro avanzado aplicado.</p>';

             // Botón de Reset general (se deja, aunque el otro es más visible)
            const resetButtonHtml = activeFilters.length === 0 ? 
                '' : 
                `<button
                    onclick="handleFilterClick('reset')"
                    class="text-sm font-medium text-red-500 hover:text-red-700 transition duration-150 flex items-center"
                    title="Resetear todos los filtros aplicados"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-1"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
                    Resetear
                </button>`;


            appDiv.innerHTML = `
                <!-- Header / Barra de Búsqueda Fija -->
                <header class="bg-white sticky top-0 z-10 shadow-lg p-4 sm:p-6 border-b border-indigo-100">
                    <div class="max-w-4xl mx-auto flex flex-col space-y-4">
                        
                        <h1 class="text-3xl font-extrabold text-center text-indigo-700">
                            Buscador Inteligente <span class="text-pink-500">🧠</span>
                        </h1>

                        <!-- Campo de Búsqueda de Texto -->
                        <div class="relative flex-grow">
                            <input
                                type="text"
                                id="search-input"
                                placeholder="Buscar por nombre de receta, ingrediente o categoría..."
                                value="${searchTerm}"
                                oninput="handleSearchInput(event)"
                                class="w-full py-3 pl-10 pr-4 border border-gray-300 rounded-full focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm text-gray-700"
                            />
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                        </div>

                        <!-- Botones de Filtro Rápido (Replicando la estructura de la imagen) -->
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                            ${renderQuickFilterButton("Tiempo Máximo", clockIcon, "bg-indigo-500 hover:bg-indigo-600", 'time')}
                            ${renderQuickFilterButton("Dificultad Mínima", zapIcon, "bg-yellow-500 hover:bg-yellow-600", 'difficulty')}
                            ${renderQuickFilterButton("Excluir Ingrediente", minusCircleIcon, "bg-red-500 hover:bg-red-600", 'excluir')}
                            ${renderQuickFilterButton("Máx. Ingredientes", saladIcon, "bg-green-500 hover:bg-green-600", 'ingredientes')}
                            ${renderQuickFilterButton("Top Puntuación", starIcon, "bg-purple-500 hover:bg-purple-600", 'puntuacion')}
                        </div>
                        ${filterIndicatorHtml}
                    </div>
                </header>

                <main class="max-w-4xl mx-auto p-4 sm:p-6 pt-0">
                    
                    <!-- Indicador de Resultados -->
                    <div class="flex justify-between items-center py-4 mt-6 border-b border-gray-200">
                        <h2 class="text-2xl font-bold text-gray-800">
                            Resultados de la Búsqueda 
                            <span class="ml-2 text-indigo-600">(${results.length} recetas)</span>
                        </h2>
                        ${resetButtonHtml}
                    </div>


                    <!-- Contenedor de Recetas -->
                    <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-6 pb-12 grid-recipes">
                        ${recipeCardsHtml}
                    </div>

                </main>
            `;
        }
        
        // --- FUNCIÓN DE RENDERIZADO DE MODALES (Añadida para completar el código) ---

        function renderModals() {
            const modalsContainer = document.getElementById('modals-container');
            // La lista de exclusiones debe ser generada aquí para ser dinámica en el modal
            const exclusionListHtml = filterState.excludeIngredients.map(item => 
                                `<span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm flex items-center shadow-sm">
                                    ${item} 
                                    <button onclick="removeExclusion('${item}')" class="ml-2 text-red-600 hover:text-red-900 leading-none">
                                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
                                    </button>
                                </span>`
                            ).join('');


            modalsContainer.innerHTML = `
                <!-- Modal de Tiempo Máximo (totalTime) -->
                ${renderModalTemplate(
                    'modal-time', 
                    'Filtrar por Tiempo Máximo', 
                    `
                    <p class="text-gray-600 mb-6">Muestra solo recetas que se puedan terminar en el tiempo seleccionado (incluye preparación y cocción).</p>
                    <div class="space-y-4">
                        <label for="filter-max-time" class="block text-sm font-medium text-gray-700">Tiempo Máximo: <span id="time-display" class="font-bold text-indigo-600">
                            ${filterState.totalTime.value} min
                        </span></label>
                        <!-- AQUÍ SE IMPLEMENTA EL SLIDER INTERACTIVO -->
                        <input type="range" 
                            id="filter-max-time" 
                            min="${filterState.totalTime.min}" 
                            max="${filterState.totalTime.max}" 
                            step="5"
                            value="${filterState.totalTime.value}" 
                            class="w-full h-2 bg-indigo-200 rounded-lg appearance-none cursor-pointer range-lg transition duration-200"
                            oninput="document.getElementById('time-display').textContent = this.value + ' min';"
                        />
                        <div class="flex justify-between text-sm text-gray-500">
                            <span>${filterState.totalTime.min} min</span>
                            <span>${filterState.totalTime.max} min (4 horas)</span>
                        </div>
                    </div>
                    `,
                    "applyFilterFromModal('totalTime')"
                )}

                <!-- Modal de Dificultad Mínima (difficulty) -->
                ${renderModalTemplate(
                    'modal-difficulty', 
                    'Filtrar por Dificultad Mínima', 
                    `
                    <p class="text-gray-600 mb-6">Muestra recetas que cumplan o superen la dificultad seleccionada.</p>
                    <div class="space-y-4">
                        <label for="filter-min-difficulty" class="block text-sm font-medium text-gray-700">Dificultad Mínima:</label>
                        <select id="filter-min-difficulty" class="w-full py-2 px-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 shadow-sm">
                            <option value="1">⭐ Muy Fácil</option>
                            <option value="2">⭐⭐ Fácil</option>
                            <option value="3">⭐⭐⭐ Media</option>
                            <option value="4">⭐⭐⭐⭐ Difícil</option>
                            <option value="5">⭐⭐⭐⭐⭐ Muy Difícil</option>
                        </select>
                    </div>
                    `,
                    "applyFilterFromModal('difficulty')"
                )}

                <!-- Modal de Máx. Ingredientes (ingredientCount) -->
                ${renderModalTemplate(
                    'modal-ingredients', 
                    'Filtrar por Máximo de Ingredientes', 
                    `
                    <p class="text-gray-600 mb-6">Ideal para cuando tienes pocos ingredientes en casa. Muestra recetas con un número igual o menor al seleccionado.</p>
                    <div class="space-y-4">
                        <label for="filter-max-ingredients" class="block text-sm font-medium text-gray-700">Máximo de Ingredientes: <span id="ingredients-display" class="font-bold text-green-600">
                            ${filterState.ingredientCount.value}
                        </span></label>
                        <input type="range" 
                            id="filter-max-ingredients" 
                            min="${filterState.ingredientCount.min}" 
                            max="${filterState.ingredientCount.max}" 
                            step="1"
                            value="${filterState.ingredientCount.value}" 
                            class="w-full h-2 bg-green-200 rounded-lg appearance-none cursor-pointer range-lg transition duration-200"
                            oninput="document.getElementById('ingredients-display').textContent = this.value;"
                        />
                        <div class="flex justify-between text-sm text-gray-500">
                            <span>Mín: ${filterState.ingredientCount.min}</span>
                            <span>Máx: ${filterState.ingredientCount.max}</span>
                        </div>
                    </div>
                    `,
                    "applyFilterFromModal('ingredients')"
                )}

                <!-- Modal de Top Puntuación (minRating) -->
                ${renderModalTemplate(
                    'modal-rating', 
                    'Filtrar por Top Puntuación', 
                    `
                    <p class="text-gray-600 mb-6">Muestra recetas con una puntuación (rating) igual o superior al valor seleccionado. Solo lo mejor.</p>
                    <div class="space-y-4">
                        <label for="filter-min-rating" class="block text-sm font-medium text-gray-700">Puntuación Mínima:</label>
                        <select id="filter-min-rating" class="w-full py-2 px-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 shadow-sm">
                            <option value="0">Cualquiera</option>
                            <option value="3.5">3.5 estrellas o más</option>
                            <option value="4">4 estrellas o más</option>
                            <option value="4.5">4.5 estrellas o más</option>
                        </select>
                    </div>
                    `,
                    "applyFilterFromModal('rating')"
                )}

                <!-- Modal de Excluir Ingrediente (excludeIngredients) -->
                ${renderModalTemplate(
                    'modal-exclude', 
                    'Excluir Ingrediente', 
                    `
                    <p class="text-gray-600 mb-6">Escribe un ingrediente (o palabra clave) para excluir las recetas que lo contengan.</p>
                    <div class="flex space-x-2 mb-4">
                        <input type="text" 
                            id="exclude-input" 
                            placeholder="Ej: Nueces, picante, huevo..."
                            class="flex-grow py-2 px-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 shadow-sm"
                            onkeypress="if(event.key === 'Enter') addExclusion();"
                        />
                        <button onclick="addExclusion()" class="bg-red-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-700 transition duration-150 shadow-md flex-shrink-0">
                            Añadir
                        </button>
                    </div>

                    <div class="mt-4 flex flex-wrap gap-2 pt-4 border-t border-gray-100">
                        ${exclusionListHtml}
                        ${filterState.excludeIngredients.length === 0 ? '<p class="text-sm text-gray-400">Ningún ingrediente excluido.</p>' : ''}
                    </div>
                    `,
                    "hideModal()" // Usamos hideModal porque el filtro se aplica en el botón "Añadir"
                )}

            `;
        }

        /**
         * Plantilla genérica para renderizar un modal.
         */
        function renderModalTemplate(id, title, contentHtml, saveAction) {
            // Se usa hidden y flex en lugar de show/hide classes para mejorar la compatibilidad de navegadores
            return `
                <div id="${id}" class="hidden fixed inset-0 z-50 bg-black bg-opacity-50 items-center justify-center p-4 transition-opacity duration-300" onclick="if(event.target.id === '${id}') hideModal()">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md transform transition-all duration-300 scale-100 opacity-100">
                        <!-- Header del Modal -->
                        <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="text-xl font-bold text-gray-800">${title}</h3>
                            <button onclick="hideModal()" class="text-gray-400 hover:text-gray-600 transition duration-150">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
                            </button>
                        </div>
                        
                        <!-- Contenido del Modal -->
                        <div class="p-5">
                            ${contentHtml}
                        </div>
                        
                        <!-- Footer del Modal (Botones de Acción) -->
                        <div class="p-4 border-t border-gray-200 flex justify-end space-x-3">
                            <button onclick="hideModal()" class="px-4 py-2 text-gray-600 font-medium bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150">
                                Cancelar
                            </button>
                            <!-- Solo si hay una acción de guardado distinta a Excluir (que guarda con su propio botón) -->
                            ${saveAction !== "hideModal()" ? 
                                `<button onclick="${saveAction}" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                                    Aplicar Filtro
                                </button>` 
                                : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        /**
         * Remueve un ingrediente de la lista de exclusión y rerenderiza.
         * @param {string} item 
         */
        function removeExclusion(item) {
            filterState.excludeIngredients = filterState.excludeIngredients.filter(e => e !== item);
            
            // Re-renderiza el modal de exclusión para actualizar la lista de tags
            renderModals(); 
            // Si el modal de exclusión está activo, lo volvemos a mostrar para mantenerlo abierto
            if (activeModal === 'modal-exclude') {
                showModal('modal-exclude');
            }
            renderApp(); // Actualiza los resultados de búsqueda
        }


        // Inicializar la aplicación al cargar la página.
        // Se llama a renderModals inmediatamente para que los elementos DOM del modal existan.
        // Luego se llama a renderApp para que la interfaz principal se muestre.
        window.onload = function() {
            renderModals(); // Asegura que el DOM de los modales exista
            renderApp();    // Renderiza la interfaz principal
        };

    </script>
</body>
</html>
