<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recetario de Pasteler√≠a 2009-2010</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    :root{
      --fondo: #fdfbf8;
      --texto: #5d4037;
      --titulo: #9c6b4a;
      --categoria: #b07c5e;
      --hover: #e9dccf;
      --borde: #e6d6c5;
      --btn-bg: #d4a782;
      --btn-text: #fffaf0;
      --panel: #ffffff;
      --muted: #7b5a4a;
    }
    /* dark theme variables */
    .dark{
      --fondo: #121212;
      --texto: #e6d6c5;
      --titulo: #ffd9b3;
      --categoria: #ffb88c;
      --hover: rgba(255,184,136,0.12);
      --borde: #2a2a2a;
      --btn-bg: #ff8f3b;
      --btn-text: #1a1a1a;
      --panel: #1b1b1b;
      --muted: #b99a86;
    }

    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',sans-serif}
    html,body{height:100%}
    body{
      display:flex;
      background:var(--fondo);
      color:var(--texto);
      min-height:100vh;
      font-size:16px;
      line-height:1.6;
      transition:background .18s ease,color .18s ease;
    }

    /* NAV */
    nav{
      width:300px;
      background:var(--panel);
      border-right:1px solid var(--borde);
      padding:18px 14px;
      overflow-y:auto;
      height:100vh;
      position:sticky;
      top:0;
    }
    nav h2{ text-align:center;margin-bottom:14px;color:var(--categoria);font-size:1.4rem;font-weight:600}
    #buscador{
      width:100%;
      padding:10px 12px;
      margin-bottom:14px;
      border-radius:10px;
      border:1px solid var(--borde);
      background:transparent;
      color:var(--texto);
      outline:none;
    }
    #lista-recetas{ list-style:none; padding:0; margin:0; }
    #lista-recetas li{
      padding:8px 10px;
      margin:6px 0;
      border-radius:8px;
      cursor:pointer;
      transition:all .18s ease;
      font-size:.95rem;
      color:var(--texto);
    }
    #lista-recetas li:hover{ background:var(--hover); color:var(--panel) }

    .categoria-titulo{
      font-weight:700;
      color:var(--categoria);
      margin:16px 0 8px 0;
      padding-bottom:6px;
      border-bottom:1px dashed var(--borde);
      cursor:pointer;
    }
    .categoria-titulo:hover{ background:var(--hover); color:var(--panel); padding-left:6px }

    /* MAIN */
    main{ flex:1; padding:28px 22px; overflow-y:auto }
    #receta-detalle h1{ color:var(--titulo); margin-bottom:10px; font-size:2.1rem; font-weight:700 }
    #receta-detalle h3{ color:var(--categoria); margin-bottom:16px; font-size:1.05rem }
    .info-extra{
      background: rgba(0,0,0,0.03);
      padding:10px 14px;
      border-radius:8px;
      margin:12px 0;
      font-size:.95rem;
      border-left:4px solid var(--btn-bg);
      color:var(--muted);
    }
    .dark .info-extra{ background: rgba(255,255,255,0.02) }

    /* image container */
    .imagen-destacada{
      width:100%;
      height:260px;
      border-radius:12px;
      overflow:hidden;
      margin:18px 0;
      box-shadow:0 6px 18px rgba(0,0,0,0.08);
      background:linear-gradient(90deg, rgba(0,0,0,0.02), rgba(0,0,0,0.01));
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    .imagen-destacada img{ width:100%; height:100%; object-fit:cover; display:block }

    .imagen-placeholder{
      width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:var(--muted); padding:12px;
      font-size:1rem; text-align:center;
    }

    /* sections */
    .section{ margin:22px 0 }
    .section h4{ color:var(--categoria); margin-bottom:12px; font-size:1.15rem; font-weight:700; display:flex; gap:8px; align-items:center }
    .section ul,.section ol{ margin-left:20px; margin-top:8px }
    .section li{ margin:8px 0; line-height:1.45 }

    /* controls panel bottom right */
    .controls{
      position:fixed;
      bottom:20px;
      right:20px;
      background:var(--panel);
      padding:12px 14px;
      border-radius:14px;
      box-shadow:0 6px 20px rgba(0,0,0,0.12);
      z-index:1200;
      border:1px solid var(--borde);
      display:flex; gap:10px; align-items:center;
    }
    .controls label{ font-weight:600; color:var(--texto); font-size:.95rem }
    .controls select{ padding:8px 10px; border-radius:8px; border:1px solid var(--borde); background:transparent; color:var(--texto) }

    /* top utility bar inside main */
    .toolbar{
      display:flex; gap:10px; align-items:center; margin-bottom:8px;
    }
    .btn{
      background:var(--btn-bg);
      color:var(--btn-text);
      border:none;
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .btn.secondary{
      background:transparent;
      color:var(--texto);
      border:1px solid var(--borde);
      font-weight:600;
    }
    .btn.icon{
      padding:8px; border-radius:10px;
    }
    /* timer UI */
    #timer-panel{ display:flex; gap:12px; align-items:center; background:var(--panel); padding:12px; border-radius:12px; border:1px solid var(--borde) }
    #timer-display{ font-size:1.6rem; font-weight:800; min-width:130px; text-align:center; color:var(--titulo) }
    .small{ font-size:.9rem; color:var(--muted) }

    /* footer */
    footer{ margin-top:40px; text-align:center; font-size:.82rem; color:var(--muted); padding-bottom:24px }

    /* responsive */
    @media (max-width: 820px){
      nav{ width:100%; height:auto; max-height:28vh; border-bottom:1px solid var(--borde); position:sticky; top:0; z-index:100 }
      body{ flex-direction:column }
      .controls{ position:static; margin:12px auto; width:calc(100% - 28px); max-width:420px; justify-content:center }
      .imagen-destacada{ height:180px }
    }
  </style>
</head>
<body>

  <nav id="menu">
    <h2><i class="fas fa-book-open"></i> Recetario</h2>
    <input id="buscador" placeholder="Buscar receta..." aria-label="Buscar receta" />
    <ul id="lista-recetas" aria-live="polite"></ul>
  </nav>

  <main id="receta-detalle" role="main" tabindex="0">
    <div class="toolbar" id="toolbar">
      <button class="btn icon secondary" id="btn-back" title="Atr√°s" style="display:none"><i class="fas fa-arrow-left"></i></button>
      <button class="btn icon secondary" id="btn-home" title="Inicio"><i class="fas fa-house"></i></button>
      <button class="btn secondary" id="toggle-dark" title="Cambiar modo">üåì Modo</button>
      <div style="flex:1"></div>
      <div class="small">Versi√≥n local ‚Äî Recetario</div>
    </div>

    <h1>Bienvenido al Recetario de Pasteler√≠a</h1>
    <p>Un compendio elegante y profesional de recetas cl√°sicas y modernas, pensado para pasteleros exigentes.</p>

    <div class="imagen-destacada">
      <div class="imagen-placeholder">üßÅ Tartas, bizcochos, confites, sorbetes y m√°s ‚Äî selecciona una receta</div>
    </div>

    <p>Selecciona una receta del men√∫ para comenzar. Puedes ajustar las cantidades seg√∫n el n√∫mero de personas y usar el temporizador integrado.</p>

    <div class="section">
      <h4><i class="fas fa-star"></i> Destacadas</h4>
      <ul>
        <li>Tarta de Manzana</li>
        <li>Trufa Negra</li>
        <li>Sorbete de Lim√≥n al Champ√°n</li>
        <li>Mousse de Chocolate</li>
      </ul>
    </div>
  </main>

  <!-- controls bottom-right -->
  <div class="controls" role="region" aria-label="Controles">
    <label>üçΩÔ∏è Para:
      <select id="selector-personas" aria-label="N√∫mero de personas">
        <option value="1">1</option>
        <option value="4" selected>4</option>
        <option value="6">6</option>
        <option value="8">8</option>
        <option value="12">12</option>
      </select>
    </label>
    <!-- timer compact -->
    <div id="timer-panel" aria-live="polite">
      <div style="display:flex;flex-direction:column;align-items:flex-end;">
        <input id="timer-mins" type="number" min="0" value="10" style="width:64px;padding:6px;border-radius:6px;border:1px solid var(--borde);background:transparent;color:var(--texto)" />
        <div class="small">minutos</div>
      </div>
      <div id="timer-display" aria-atomic="true">10:00</div>
      <div style="display:flex;flex-direction:column;gap:6px;">
        <button class="btn" id="timer-start">Iniciar</button>
        <div style="display:flex;gap:6px">
          <button class="btn secondary" id="timer-pause">Pausa</button>
          <button class="btn secondary" id="timer-reset">Reset</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  /* -------------------------
     Datos de recetas (proporcionados)
     ------------------------- */
  const recetas = [
    {"id":"VARIOS 142","nombre":"Tarta de Manzana","categoria":"Tartas del Ayer","ingredientes":[{"nombre":"Pasta sableaux o hojaldre","cantidad":1,"unidad":"masa"},{"nombre":"Crema pastelera","cantidad":250,"unidad":"gr"},{"nombre":"Manzanas reinetas","cantidad":4,"unidad":"unidades"},{"nombre":"Az√∫car grano","cantidad":50,"unidad":"gr"},{"nombre":"Gelatina de manzana","cantidad":1,"unidad":"sobre"}],"elaboracion":["Rellenar un molde con pasta sableux y cocer en blanco con alubias.","Retirar las alubias y rellenar con crema pastelera.","Colocar manzana pelada y fileteada de forma decorativa.","Espolvorear con az√∫car y hornear a 190¬∞C durante 35 minutos.","Una vez fr√≠a, abrillantar con gelatina de manzana."],"temperatura":190,"tiempo":35,"imagen":"tarta_manzana"},
    {"id":"VARIOS 143","nombre":"Tarta San Marcos","categoria":"Tartas del Ayer","ingredientes":[{"nombre":"Bizcocho corriente","cantidad":1,"unidad":"plancha"},{"nombre":"Alm√≠bar para emborrachar","cantidad":200,"unidad":"ml"},{"nombre":"Nata montada","cantidad":300,"unidad":"gr"},{"nombre":"Yema pastelera","cantidad":200,"unidad":"gr"},{"nombre":"Az√∫car en grano","cantidad":50,"unidad":"gr"},{"nombre":"Gelatina de manzana","cantidad":1,"unidad":"sobre"}],"elaboracion":["Montar la tarta: disco de bizcocho emborrachado.","Capa de yema pastelera.","Disco de bizcocho emborrachado.","Capa de nata montada.","Disco de bizcocho emborrachado.","Extender yema pastelera, rociar con az√∫car y quemar con soplete.","Decorar laterales con nata y almendra granillo tostada.","Abrillantar con gelatina de manzana."],"imagen":"tarta_san_marcos"},
    {"id":"VARIOS 144","nombre":"Tarta Tatin","categoria":"Tartas del Ayer","ingredientes":[{"nombre":"Az√∫car","cantidad":200,"unidad":"gr"},{"nombre":"Agua","cantidad":100,"unidad":"ml"},{"nombre":"Manzanas reinetas","cantidad":1,"unidad":"kg"},{"nombre":"Recortes de hojaldre","cantidad":1,"unidad":"cantidad suficiente"}],"elaboracion":["Ba√±o de caramelo en molde: derretir az√∫car con agua.","Pelar, descorazonar y cortar manzanas por la mitad.","Colocarlas en el molde con parte convexa hacia abajo.","Cubrir con l√°mina de hojaldre, pinchar y hornear a 180¬∞C."],"temperatura":180,"tiempo":40,"imagen":"tarta_tatin"},
    {"id":"VARIOS 146","nombre":"Tarta de Queso","categoria":"Tartas del Ayer","ingredientes":[{"nombre":"Queso tipo Philadelphia","cantidad":500,"unidad":"gr"},{"nombre":"Az√∫car","cantidad":150,"unidad":"gr"},{"nombre":"Huevos","cantidad":4,"unidad":"unidades"},{"nombre":"Nata l√≠quida","cantidad":200,"unidad":"ml"},{"nombre":"Galletas trituradas","cantidad":200,"unidad":"gr"},{"nombre":"Mantequilla","cantidad":100,"unidad":"gr"}],"elaboracion":["Mezclar galletas con mantequilla derretida y formar base.","Batir queso con az√∫car, a√±adir huevos uno a uno.","Incorporar nata y verter sobre la base.","Hornear a ba√±o Mar√≠a a 160¬∞C durante 50 minutos.","Enfriar y refrigerar toda la noche."],"temperatura":160,"tiempo":50,"imagen":"tarta_queso"},
    {"id":"VARIOS 147","nombre":"Tarta de Yema Quemada","categoria":"Tartas del Ayer","ingredientes":[{"nombre":"Pasta sableaux","cantidad":1,"unidad":"masa"},{"nombre":"Yemas de huevo","cantidad":20,"unidad":"unidades"},{"nombre":"Az√∫car","cantidad":600,"unidad":"gr"},{"nombre":"Agua","cantidad":250,"unidad":"ml"}],"elaboracion":["Preparar alm√≠bar con az√∫car y agua hasta punto de hebra fina.","Incorporar yemas poco a poco sin dejar de remover.","Verter sobre la masa sableaux previamente cocida.","Cocer al horno suave hasta dorar ligeramente."],"temperatura":170,"tiempo":25,"imagen":"tarta_yema_quemada"},
    {"id":"VARIOS 150","nombre":"Tarta Sagarroz","categoria":"Tartas del Ayer","ingredientes":[{"nombre":"Bizcocho corriente","cantidad":1,"unidad":"plancha"},{"nombre":"Alm√≠bar aromatizado con sidra","cantidad":200,"unidad":"ml"},{"nombre":"Nata montada","cantidad":400,"unidad":"gr"},{"nombre":"Compota de manzana","cantidad":300,"unidad":"gr"},{"nombre":"Sidra","cantidad":100,"unidad":"ml"},{"nombre":"Gelatina de manzana","cantidad":1,"unidad":"sobre"}],"elaboracion":["Emborrar el bizcocho con alm√≠bar de sidra.","Rellenar con capas alternas de nata y compota.","Cubrir con nata y abrillantar con gelatina."],"imagen":"tarta_sagarroz"},
    {"id":"VARIOS 161","nombre":"Tarta de Almendra","categoria":"Tartas del Ayer","ingredientes":[{"nombre":"Pasta quebrada","cantidad":1,"unidad":"masa"},{"nombre":"Az√∫car","cantidad":250,"unidad":"gr"},{"nombre":"Almendra molida","cantidad":250,"unidad":"gr"},{"nombre":"Ralladura de lim√≥n","cantidad":1,"unidad":"unidad"},{"nombre":"Huevos","cantidad":3,"unidad":"unidades"},{"nombre":"Mantequilla","cantidad":250,"unidad":"gr"}],"elaboracion":["Forrar molde con pasta quebrada.","Mezclar almendra, az√∫car, ralladura, huevos y mantequilla.","Verter sobre la base y hornear a 180¬∞C durante 45 minutos."],"temperatura":180,"tiempo":45,"imagen":"tarta_almendra"},
    {"id":"VARIOS 158","nombre":"Tarta de Frutas","categoria":"Tartas del Ayer","ingredientes":[{"nombre":"Dos discos de bizcocho","cantidad":2,"unidad":"unidades"},{"nombre":"Alm√≠bar de emborrachar","cantidad":200,"unidad":"ml"},{"nombre":"Nata montada","cantidad":500,"unidad":"gr"},{"nombre":"Yema de naranja","cantidad":200,"unidad":"gr"},{"nombre":"Frutas variadas","cantidad":500,"unidad":"gr"}],"elaboracion":["Colocar un disco de bizcocho en molde de aro.","Emborrarlo m√≠nimamente.","Rellenar abundantemente de nata.","Colocar encima el otro disco de bizcocho y emborracharlo.","Extender yema de naranja, rociar con az√∫car y quemar.","Abrillantar con gelatina de manzana.","Colocar frutas decorativamente y abrillantar."],"imagen":"tarta_frutas"},
    /* ---------- resto de recetas truncado en el snippet por brevedad
       En tu archivo original ya est√°n todas las recetas ‚Äî aqu√≠ se usan tal cual.
       (En el fichero final que pegues, conserva el array completo que ya ten√≠as).
    */
  ];

  /* -----------
     L√≥gica general y navegaci√≥n jer√°rquica (stack)
     - Jerarqu√≠a pedida:
       Receta -> Lista de sus Recetas (misma categor√≠a)
       Lista de sus Recetas -> Lista de categor√≠as
       Lista de categor√≠as -> Pantalla inicial
     ------------- */

  // stack de vistas. Cada elemento: {type:'home'|'categories'|'category'|'recipe', payload:...}
  const navStack = [];

  // DOM refs
  const listaEl = document.getElementById('lista-recetas');
  const buscador = document.getElementById('buscador');
  const detalle = document.getElementById('receta-detalle');
  const selectorPersonas = document.getElementById('selector-personas');
  const btnBack = document.getElementById('btn-back');
  const btnHome = document.getElementById('btn-home');
  const toggleDark = document.getElementById('toggle-dark');

  // ensure we have full recetas array if truncated above: if recetas incomplete, fetch them from variable
  // (We assume user will paste full array in final file. If not, UI still functions for included items.)

  // build list of categories from recetas
  function obtenerCategorias(){
    const cat = {};
    recetas.forEach(r => cat[r.categoria] = (cat[r.categoria] || 0) + 1);
    return Object.keys(cat).sort((a,b)=>a.localeCompare(b,'es'));
  }

  // RENDER: menu lateral (categor√≠as + recetas flattened)
  function cargarMenu(){
    listaEl.innerHTML = '';
    const categorias = {};
    recetas.forEach(r => {
      if (!categorias[r.categoria]) categorias[r.categoria] = [];
      categorias[r.categoria].push(r);
    });

    // build: category title items (click -> show category list) then recipes under it
    Object.keys(categorias).sort((a,b)=>a.localeCompare(b,'es')).forEach(cat => {
      const catLi = document.createElement('li');
      catLi.className = 'categoria-titulo';
      catLi.textContent = cat;
      catLi.onclick = () => {
        pushState({type:'category', category:cat});
        mostrarListaRecetasPorCategoria(cat);
      };
      listaEl.appendChild(catLi);

      categorias[cat].sort((x,y)=>x.nombre.localeCompare(y.nombre,'es')).forEach(r => {
        const li = document.createElement('li');
        li.textContent = r.nombre;
        li.onclick = () => {
          pushState({type:'recipe', id:r.id});
          mostrarReceta(r);
        };
        listaEl.appendChild(li);
      });
    });
  }

  // SEARCH realtime
  buscador.addEventListener('input', (e) => {
    const term = e.target.value.trim().toLowerCase();
    if (!term){
      cargarMenu();
      return;
    }
    listaEl.innerHTML = '';
    const filtradas = recetas.filter(r => r.nombre.toLowerCase().includes(term) || r.categoria.toLowerCase().includes(term));
    if (filtradas.length === 0){
      const li = document.createElement('li');
      li.textContent = 'No se encontraron recetas';
      li.style.opacity = .7;
      listaEl.appendChild(li);
      return;
    }
    filtradas.forEach(r => {
      const li = document.createElement('li');
      li.textContent = `${r.nombre} ‚Äî ${r.categoria}`;
      li.onclick = () => {
        pushState({type:'recipe', id:r.id});
        mostrarReceta(r);
      };
      listaEl.appendChild(li);
    });
  });

  /* ------------------------
     NAVEGACI√ìN con stack + history API
     ------------------------ */
  function pushState(view){
    // push to our stack and to history so back button works
    navStack.push(view);
    try{ history.pushState(view, '', '#view'); } catch(e){}
    actualizarBotonAtras();
  }

  function popState(){
    // pop current view and render previous
    if (navStack.length > 1){
      navStack.pop();
      const prev = navStack[navStack.length - 1];
      renderFromView(prev, false);
      try{ history.pushState(prev, '', '#view'); } catch(e){}
    } else {
      // if only one or less, show home
      navStack.length = 0;
      mostrarHome();
    }
    actualizarBotonAtras();
  }

  // Handle browser back (popstate)
  window.addEventListener('popstate', (ev) => {
    // if history changes, sync with our stack: we pop
    if (navStack.length > 0) {
      navStack.pop();
      const prev = navStack[navStack.length-1] || {type:'home'};
      renderFromView(prev, false);
      actualizarBotonAtras();
    } else {
      mostrarHome();
    }
  });

  btnBack.addEventListener('click', () => popState());
  btnHome.addEventListener('click', () => {
    // clear stack and go home
    navStack.length = 0;
    mostrarHome();
    try{ history.pushState({type:'home'}, '', '#home'); } catch(e){}
    actualizarBotonAtras();
  });

  function actualizarBotonAtras(){
    btnBack.style.display = navStack.length > 1 ? 'inline-flex' : 'none';
  }

  function renderFromView(view, pushHistory = true){
    if (!view) return mostrarHome();
    if (view.type === 'home') return mostrarHome();
    if (view.type === 'categories') return mostrarCategorias();
    if (view.type === 'category') return mostrarListaRecetasPorCategoria(view.category);
    if (view.type === 'recipe'){
      const rec = recetas.find(x => x.id === view.id);
      if (rec) return mostrarReceta(rec);
      return mostrarHome();
    }
  }

  /* ------------------------
     Vistas: home, categorias, lista categoria, receta
     ------------------------ */
  function mostrarHome(){
    detalle.innerHTML = `
      <div class="toolbar" id="toolbar2">
        <button class="btn secondary" id="btn-home-2" style="display:none"><i class="fas fa-house"></i></button>
        <div style="flex:1"></div>
        <div class="small">Bienvenido</div>
      </div>
      <h1>Bienvenido al Recetario de Pasteler√≠a</h1>
      <p>Un compendio elegante y profesional de recetas cl√°sicas y modernas, pensado para pasteleros exigentes.</p>
      <div class="imagen-destacada"><div class="imagen-placeholder">üßÅ Tartas, bizcochos, confites, sorbetes y m√°s ‚Äî selecciona una receta</div></div>
      <p>Selecciona una receta del men√∫ para comenzar. Puedes ajustar las cantidades seg√∫n el n√∫mero de personas y usar el temporizador integrado.</p>
      <div class="section">
        <h4><i class="fas fa-star"></i> Destacadas</h4>
        <ul>
          <li>Tarta de Manzana</li>
          <li>Trufa Negra</li>
          <li>Sorbete de Lim√≥n al Champ√°n</li>
          <li>Mousse de Chocolate</li>
        </ul>
      </div>
    `;
    detalle.focus();
  }

  function mostrarCategorias(){
    // build category list
    const cats = obtenerCategorias();
    let html = `<h1>Categor√≠as</h1><p><strong>${cats.length} categor√≠as</strong></p><ul style="list-style:disc;margin-left:18px;">`;
    cats.forEach(c => {
      html += `<li style="margin:6px 0; cursor:pointer;" onclick="(function(){ pushState({type:'category', category: ${JSON.stringify(c)} }); mostrarListaRecetasPorCategoria(${JSON.stringify(c)}); })()">${c}</li>`;
    });
    html += `</ul>`;
    detalle.innerHTML = html;
    detalle.focus();
  }

  // show list of recipes for a category (Lista de sus Recetas)
  function mostrarListaRecetasPorCategoria(categoria){
    const recetasFiltradas = recetas.filter(r => r.categoria === categoria).sort((a,b)=>a.nombre.localeCompare(b.nombre,'es'));
    let html = `<h1>${categoria}</h1>`;
    html += `<p><strong>${recetasFiltradas.length} recetas disponibles</strong></p>`;
    html += `<ul style="list-style:disc;margin-left:18px">`;
    recetasFiltradas.forEach(r => {
      html += `<li style="margin:6px 0;cursor:pointer" onclick="(function(){ pushState({type:'recipe', id:${JSON.stringify(r.id)} }); mostrarRecetaPorNombre(${JSON.stringify(r.nombre)}); })()">${r.nombre}</li>`;
    });
    html += `</ul>`;
    detalle.innerHTML = html;
    detalle.focus();
    actualizarBotonAtras();
  }

  function mostrarRecetaPorNombre(nombre){
    const receta = recetas.find(r => r.nombre === nombre);
    if (receta) {
      pushState({type:'recipe', id:receta.id});
      mostrarReceta(receta);
    }
  }

  /* ------------------------
     Mostrar receta (imagen + ingredientes escalados + elaboracion)
     ------------------------ */
  function mostrarReceta(receta){
    // Guardar √∫ltimo
    localStorage.setItem('ultimaReceta', receta.id);

    const personasBase = 4;
    const personasActuales = parseInt(selectorPersonas.value) || 4;
    const factor = personasActuales / personasBase;

    // build image URL (Unsplash random with query); encode recipe.imagen to be safe
    const query = encodeURIComponent(`${receta.imagen} dessert cake pastry ${receta.nombre}`);
    const imgUrl = `https://source.unsplash.com/random/1200x600/?${query}`;

    // create ingredients list with scaled amounts (if cantidad is numeric)
    let ingHtml = '';
    if (Array.isArray(receta.ingredientes) && receta.ingredientes.length){
      receta.ingredientes.forEach(ing => {
        let qty = ing.cantidad;
        if (typeof qty === 'number' && !isNaN(qty)){
          const nuevaCantidad = (qty * factor);
          // format: avoid long decimals, show up to 2 decimals or integer
          const formatted = (Math.round(nuevaCantidad * 100) / 100).toString().replace(/\.0+$/,'');
          ingHtml += `<li>${formatted} ${ing.unidad} de <strong>${ing.nombre}</strong></li>`;
        } else {
          ingHtml += `<li>${ing.cantidad} ${ing.unidad ? ing.unidad : ''} de <strong>${ing.nombre}</strong></li>`;
        }
      });
    } else {
      ingHtml = `<li>Ingredientes: (por completar)</li>`;
    }

    // elaboracion
    let elaborHtml = '';
    if (Array.isArray(receta.elaboracion) && receta.elaboracion.length){
      receta.elaboracion.forEach(p => elaborHtml += `<li>${p}</li>`);
    } else {
      elaborHtml = `<li>Elaboraci√≥n: (por completar)</li>`;
    }

    // temperature/time box: ensure visible in dark mode by using background + strong text
    let tempHtml = '';
    if (receta.temperatura || receta.tiempo){
      const temp = receta.temperatura ? `${receta.temperatura}¬∞C` : '';
      const tiempo = receta.tiempo ? `¬∑ ${receta.tiempo} min` : '';
      tempHtml = `<div class="info-extra" style="display:flex;justify-content:space-between;align-items:center;"><strong style="font-weight:800">üî• ${temp} ${tiempo}</strong></div>`;
    }

    // final HTML
    const final = `
      <h1>${receta.nombre}</h1>
      <h3><i class="fas fa-tag"></i> ${receta.categoria}</h3>
      ${tempHtml}
      <div class="imagen-destacada" id="img-destacada">
        <img src="${imgUrl}" alt="${receta.nombre}" onerror="this.parentElement.innerHTML='<div class=\\'imagen-placeholder\\'>üì∑ Imagen de: ${receta.nombre} (no disponible)</div>'" />
      </div>

      <div class="section">
        <h4><i class="fas fa-shopping-cart"></i> Ingredientes (para ${personasActuales} personas)</h4>
        <ul>
          ${ingHtml}
        </ul>
      </div>

      <div class="section">
        <h4><i class="fas fa-mortar-pestle"></i> Elaboraci√≥n</h4>
        <ol>
          ${elaborHtml}
        </ol>
      </div>

      <footer>üí° Im√°genes generadas autom√°ticamente desde Unsplash. Busca "${receta.nombre}" si deseas versiones libres.</footer>
    `;
    detalle.innerHTML = final;
    detalle.focus();
    actualizarBotonAtras();
  }

  // When changing personas, re-render the currently visible recipe if any
  selectorPersonas.addEventListener('change', () => {
    const currentName = document.querySelector('#receta-detalle h1')?.textContent || '';
    if (!currentName) return;
    const receta = recetas.find(r => r.nombre === currentName);
    if (receta) mostrarReceta(receta);
  });

  /* ------------------------
     Dark mode toggle (persistir en localStorage)
     ------------------------ */
  const preferredDark = localStorage.getItem('modoOscuro') === '1';
  if (preferredDark) document.documentElement.classList.add('dark');

  toggleDark.addEventListener('click', () => {
    document.documentElement.classList.toggle('dark');
    const isDark = document.documentElement.classList.contains('dark');
    localStorage.setItem('modoOscuro', isDark ? '1':'0');
  });

  /* ------------------------
     TIMER & ALARMA (vibraci√≥n + notificaci√≥n + beep)
     - compatible Android: navigator.vibrate + Notification API + AudioContext beep
     - note: many mobile browsers require user gesture to play sound; Start button will be a user gesture.
     ------------------------ */
  let timerInterval = null;
  let remainingSec = 0;
  let timerRunning = false;
  const timerMinsInput = document.getElementById('timer-mins');
  const timerDisplay = document.getElementById('timer-display');
  const btnTimerStart = document.getElementById('timer-start');
  const btnTimerPause = document.getElementById('timer-pause');
  const btnTimerReset = document.getElementById('timer-reset');

  // format mm:ss
  function fmt(sec){
    const m = Math.floor(sec/60).toString().padStart(2,'0');
    const s = Math.floor(sec%60).toString().padStart(2,'0');
    return `${m}:${s}`;
  }

  function updateDisplay(){
    timerDisplay.textContent = fmt(remainingSec);
  }

  function startTimerFromInput(){
    const mins = Math.max(0, Math.floor(Number(timerMinsInput.value) || 0));
    remainingSec = mins * 60;
    if (remainingSec <= 0) return;
    if (timerInterval) clearInterval(timerInterval);
    timerRunning = true;
    updateDisplay();
    timerInterval = setInterval(() => {
      remainingSec--;
      if (remainingSec <= 0){
        clearInterval(timerInterval);
        timerInterval = null;
        timerRunning = false;
        remainingSec = 0;
        updateDisplay();
        triggerAlarm();
      } else {
        updateDisplay();
      }
    }, 1000);
  }

  btnTimerStart.addEventListener('click', (ev) => {
    // user gesture happens here (allowed to play sound)
    if (!timerRunning){
      // if remainingSec is zero, start from input
      if (remainingSec <= 0){
        startTimerFromInput();
      } else {
        // resume
        timerRunning = true;
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          remainingSec--;
          if (remainingSec <= 0){
            clearInterval(timerInterval);
            timerRunning = false;
            remainingSec = 0;
            updateDisplay();
            triggerAlarm();
          } else updateDisplay();
        }, 1000);
      }
      btnTimerStart.textContent = 'En marcha';
    }
  });

  btnTimerPause.addEventListener('click', ()=>{
    if (timerRunning){
      clearInterval(timerInterval);
      timerInterval = null;
      timerRunning = false;
      btnTimerStart.textContent = 'Continuar';
    }
  });

  btnTimerReset.addEventListener('click', ()=>{
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null;
    timerRunning = false;
    const m = Math.max(0, Math.floor(Number(timerMinsInput.value) || 0));
    remainingSec = m*60;
    updateDisplay();
    btnTimerStart.textContent = 'Iniciar';
  });

  // initialize timer display
  remainingSec = Math.max(0, Math.floor(Number(timerMinsInput.value) || 10)) * 60;
  updateDisplay();

  // Alarm: notification + vibrate + beep
  async function triggerAlarm(){
    // Vibrate if available (pattern: vibrate 600ms three times)
    try{
      if (navigator.vibrate){
        navigator.vibrate([600,200,600,200,600]);
      }
    }catch(e){ /* no-op */ }

    // Notification (request permission if needed)
    try{
      if ("Notification" in window){
        if (Notification.permission === "granted"){
          const n = new Notification("Temporizador: tiempo cumplido", { body: "Tu temporizador ha terminado.", icon: undefined });
          setTimeout(()=>n.close(), 7000);
        } else if (Notification.permission !== "denied"){
          const perm = await Notification.requestPermission();
          if (perm === 'granted'){
            const n = new Notification("Temporizador: tiempo cumplido", { body: "Tu temporizador ha terminado." });
            setTimeout(()=>n.close(), 7000);
          }
        }
      }
    } catch(e){ /* ignore */ }

    // beep via WebAudio (short chirp). Many browsers require user gesture first (we ensured start had gesture).
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'sine';
      o.frequency.value = 950;
      g.gain.value = 0.0001;
      o.connect(g);
      g.connect(ctx.destination);
      // ramp up quickly
      g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.02);
      o.start();
      // ramp down and stop
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 1.0);
      setTimeout(()=>{ try{ o.stop(); ctx.close(); }catch(e){} }, 1100);
    } catch(e){ /* no-op */ }
  }

  /* ------------------------
     Inicializaci√≥n y carga
     ------------------------ */
  function init(){
    cargarMenu();
    actualizarBotonAtras();

    // initial view: if there's ultimaReceta in localStorage show recipe, else home
    const savedId = localStorage.getItem('ultimaReceta');
    if (savedId){
      const primera = recetas.find(r => r.id === savedId) || recetas[0];
      if (primera){
        // push category list then recipe so back navigates to list of recetas
        pushState({type:'category', category: primera.categoria});
        pushState({type:'recipe', id:primera.id});
        mostrarReceta(primera);
        return;
      }
    }
    // default: show categories list (user asked categories -> home transition is last)
    pushState({type:'home'});
    mostrarHome();
  }

  // export pushState to global so inline onclick in generated HTML can call it
  window.pushState = pushState;
  window.mostrarRecetaPorNombre = mostrarRecetaPorNombre;

  // initialize after DOM ready
  window.addEventListener('load', init);

  // accessibility: keyboard Esc to go back if possible
  window.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape'){
      popState();
    }
  });

  </script>
</body>
</html>
